"use strict";var seeduml=(()=>{var mt=Object.defineProperty;var bt=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var kt=Object.prototype.hasOwnProperty;var St=(I,i)=>{for(var t in i)mt(I,t,{get:i[t],enumerable:!0})},vt=(I,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of wt(i))!kt.call(I,n)&&n!==t&&mt(I,n,{get:()=>i[n],enumerable:!(e=bt(i,n))||e.enumerable});return I};var Mt=I=>vt(mt({},"__esModule",{value:!0}),I);var Ct={};St(Ct,{default:()=>Lt,initialize:()=>ut,render:()=>ht,renderAll:()=>K,renderComponentDiagram:()=>J,renderSequenceDiagram:()=>Q});var nt=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumber=0;this.autoactivateEnabled=!1}setHideFootbox(i){this.hideFootbox=i}addParticipant(i,t,e="participant",n,o,s){let a=this.participants.find(c=>c.name===i);a?(t&&(a.label=t),e!=="participant"&&(a.type=e),n!==void 0&&(a.order=n),o&&(a.color=o),s&&(a.stereotype=s)):(a={name:i,label:t,type:e,order:n,color:o,stereotype:s},this.participants.push(a)),this.groupStack.forEach(c=>{c.participants.includes(i)||c.participants.push(i)})}addMessage(i,t,e,n="arrow",o="default",s,a,c="none"){let r=this.currentStep++;this.addParticipant(i),this.addParticipant(t);let h;return this.autonumberConfig&&(h=this.currentAutonumber.toString(),this.currentAutonumber+=this.autonumberConfig.increment),this.messages.push({from:i,to:t,text:e,type:n,step:r,arrowHead:o,startHead:c,color:s,bidirectional:a,number:h}),this.autoactivateEnabled&&i!==t&&n==="arrow"&&this.activate(t,r,r),r}setAutonumber(i=1,t=1,e){this.autonumberConfig={start:i,increment:t,format:e},this.currentAutonumber=i}setAutoactivate(i){this.autoactivateEnabled=i}destroy(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(i,e.destroyedStep))}create(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.createdStep=t)}addDivider(i){this.dividers.push({label:i,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(i){this.delays.push({text:i,step:this.currentStep++})}addSpacing(i=30){this.spacings.push({height:i,step:this.currentStep++})}setTitle(i){this.title=i}setHeader(i){this.header=i}setFooter(i){this.footer=i}returnMessage(i){let t=[...this.activations].reverse().find(s=>s.endStep===void 0);if(!t)return;let e=t.participantName,n=e;if(t.sourceStep!==void 0){let s=this.messages.find(a=>a.step===t.sourceStep);s&&(n=s.from)}let o=this.addMessage(e,n,i,"dotted","open");this.deactivate(e,o)}addNote(i,t,e,n,o="folder",s){let a=s!==void 0?s:this.currentStep++,c=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0;return this.notes.push({text:i,position:t,participants:e,step:a,color:n,shape:o,owner:c}),a}activate(i,t=this.currentStep,e,n){this.addParticipant(i);let o=this.activations.filter(s=>s.participantName===i&&s.endStep===void 0).length;this.activations.push({participantName:i,startStep:t,level:o,sourceStep:e,color:n})}deactivate(i,t=this.currentStep,e){this.addParticipant(i);let n=[...this.activations].reverse().find(o=>o.participantName===i&&o.endStep===void 0);n&&(n.endStep=t,n.endSourceStep=e)}startGroup(i,t){let e=this.nextStep(),n={type:i,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(n),this.groupStack.push(n),n}addGroupSection(i){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:i,startStep:this.nextStep()})}endGroup(){let i=this.groupStack.pop();i&&(i.endStep=this.nextStep())}addReference(i,t){let e=this.nextStep(),n=this.nextStep();this.references.push({participants:i,label:t,startStep:e,endStep:n})}addTaggedStep(i,t){this.taggedSteps.set(i,t)}addTimeConstraint(i,t,e){this.timeConstraints.push({startTag:i,endTag:t,label:e})}};var it=class{parse(i){let t=new nt,e=i.split(`
`),n=null,o=null,s=-1,a="",c="",r="",h=new Map;for(let l=0;l<e.length;l++){let d=e[l],p=d;if(d=d.trim(),!d||d.startsWith("@")||d.startsWith("!pragma"))continue;if(o){let E=d.toLowerCase();if(E.startsWith("end note")||(E==="end hnote"||E==="endhnote")||(E==="end rnote"||E==="endrnote")||(E==="end bnote"||E==="endbnote")){let H=o.position.toLowerCase(),Y;if(o.participants.length===0&&(H==="right"||H==="left")&&a&&c){let q=t.participants.findIndex(G=>G.name===a),P=t.participants.findIndex(G=>G.name===c);if(q!==-1&&P!==-1){let G=t.participants[q],O=t.participants[P],j=q<P;G.order!==void 0&&O.order!==void 0&&(j=G.order<O.order),H==="left"?o.participants=[j?a:c]:o.participants=[j?c:a]}else o.participants=[c];s!==-1&&(Y=s)}let z=o.text.join(`
`).replace(/\\n/g,`
`);t.addNote(z,o.position,o.participants,o.color,o.shape,Y),o=null}else o.text.push(p);continue}if(n){d.toLowerCase().startsWith("end ref")?(t.addReference(n.participants,n.label.join(`
`)),n=null):n.label.push(p);continue}if(d.startsWith("'"))continue;let $=!1;d.startsWith("/")&&($=!0,d=d.substring(1).trim(),t.rewindStep());let x=d.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if(x){let[,E,C]=x;t.addParticipant(C,E),t.create(C,t.getCurrentStep());continue}let g=d.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(g){let[,E,C,T]=g,D=C.replace(/^"(.*)"$/,"$1");if(T&&T.startsWith("#")){let H=T.substring(1);/^[0-9A-Fa-f]+$/.test(H)&&[3,4,6,8].includes(H.length)||(T=H)}let X=E.toLowerCase();if(X==="activate")if(D===c&&s!==-1)t.activate(D,s,s,T),h.set(D,s);else{let H=t.nextStep();t.activate(D,H,void 0,T),h.set(D,H)}else if(X==="deactivate"){let H=!1;s!==-1&&s>(h.get(D)??-1)&&(r==="arrow"?H=D===c||D===a:r==="dotted"&&(H=D===a)),H?t.deactivate(D,s):t.deactivate(D,t.nextStep())}else if(X==="destroy"){let H=!1;s!==-1&&s>(h.get(D)??-1)&&(r==="arrow"?H=D===c||D===a:r==="dotted"&&(H=D===a)),H?t.destroy(D,s):t.destroy(D,t.nextStep())}continue}let b=d.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(b){let[,E,C,T]=b;t.addTimeConstraint(E,C,T||"");continue}let S=d.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if(S){let[,E]=S;t.addDelay(E||void 0);continue}let L=d.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(L){let[,E,C,T,D,X,H,Y,z,q,P,G]=L;G=G||"";let O=D+(H||"");if(O.length>0){C&&(C=C.replace(/^"(.*)"$/,"$1")),z&&(z=z.replace(/^"(.*)"$/,"$1")),(!C||C==="[")&&(C="["),(!z||z==="]")&&(z="]");let j=O.includes("..")||O.includes("--"),V=T.includes("<")&&(Y||"").includes(">"),_=(W,ft)=>W?W===">"||W==="<"?"default":W===">>"||W==="<<"?"open":W==="\\"||W==="/"?"half":W==="\\\\"||W==="//"?"open":W.includes("x")?"lost":W.includes("o")?"arrow-circle":"default":"none",Z=_(Y||"",!1),tt=_(T||"",!0);Y==="x"&&(Z="lost"),C==="x"&&(tt="found");let yt=G.replace(/\\n/g,`
`),B=t.addMessage(C,z,yt,j?"dotted":"arrow",Z,X,V,tt);E&&t.addTaggedStep(E,B);let dt=C,pt=z,et=W=>["default","open","half","arrow-circle"].includes(W);if(et(tt)&&!et(Z)?(dt=z,pt=C):et(Z)&&!et(tt)&&(dt=C,pt=z),s=B,a=dt,c=pt,r=j?"dotted":"arrow",q==="++"){if(P&&P.startsWith("#")){let W=P.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(P=W)}t.activate(z,B,B,P),h.set(z,B)}else if(q==="--")t.deactivate(C,B,B);else if(q==="--++"){if(t.deactivate(C,B,B),P&&P.startsWith("#")){let W=P.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(P=W)}t.activate(z,B,B,P),h.set(z,B)}else if(q==="++--"){if(P&&P.startsWith("#")){let W=P.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(P=W)}t.activate(C,B,B,P),h.set(C,B),t.deactivate(z,B,B)}else q==="**"?t.create(z,B):q==="!!"&&t.destroy(z,B);continue}}let R=d.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if(R){let[,E,C,T,D,X]=R,H=[];T&&T.trim()&&(H=T.split(",").map(z=>z.trim().replace(/^"(.*)"$/,"$1")));let Y="folder";if(E==="h"?Y="hexagon":E==="r"?Y="rectangle":E==="b"&&(Y="bubble"),X!==void 0){let z=C.toLowerCase(),q;if(H.length===0&&(z==="right"||z==="left")&&a&&c){let G=t.participants.findIndex(j=>j.name===a),O=t.participants.findIndex(j=>j.name===c);if(G!==-1&&O!==-1){let j=t.participants[G],V=t.participants[O],_=G<O;j.order!==void 0&&V.order!==void 0&&(_=j.order<V.order),z==="left"?H=[_?a:c]:H=[_?c:a]}else H=[c];s!==-1&&(q=s)}let P=X.replace(/\\n/g,`
`);t.addNote(P,C.toLowerCase(),H,D,Y,q)}else o={text:[],position:C.toLowerCase(),participants:H,color:D,shape:Y};continue}let N=d.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(N){let[,E,C]=N;t.startGroup(E.toLowerCase(),C||"");continue}let M=d.match(/^else(?:\s+(.*))?$/i);if(M){let[,E]=M;t.addGroupSection(E||"");continue}if(d.toLowerCase().startsWith("end")){t.endGroup();continue}let f=d.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(f){let[,E,C]=f,T=E.split(",").map(D=>D.trim().replace(/^"(.*)"$/,"$1"));C?t.addReference(T,C):n={participants:T,label:[]};continue}let y=d.match(/^return(?:\s+(.*))?$/i);if(y){let[,E]=y,C=(E||"").replace(/\\n/g,`
`);t.returnMessage(C);continue}let u=d.match(/^autonumber(?:\s+(\d+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(u){let[,E,C,T]=u;t.setAutonumber(E?parseInt(E,10):1,C?parseInt(C,10):1,T);continue}let w=d.match(/^autoactivate\s+(on|off)$/i);if(w){t.setAutoactivate(w[1].toLowerCase()==="on");continue}let m=d.match(/^==\s*(.*?)\s*==$/);if(m){t.addDivider(m[1]);continue}if(d==="|||"){t.addSpacing();continue}let k=d.match(/^\|\|(\d+)\|\|$/);if(k){t.addSpacing(parseInt(k[1],10));continue}let v=d.match(/^(title|header|footer)\s+(.*)$/i);if(v){let[,E,C]=v;E.toLowerCase()==="title"?t.setTitle(C):E.toLowerCase()==="header"?t.setHeader(C):E.toLowerCase()==="footer"&&t.setFooter(C);continue}if(d.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let A="(participant|actor|boundary|control|entity|database|collections|queue)",F=new RegExp(`^${A}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),U=d.match(F);if(U){let[,E,C,T,D,X,H,Y]=U;if(!E||!C)continue;let z=T||X,q,P;D?D.startsWith('"')?(q=C.replace(/^"(.*)"$/,"$1"),P=D.replace(/^"(.*)"$/,"$1")):(q=D.replace(/^"(.*)"$/,"$1"),P=C.replace(/^"(.*)"$/,"$1")):(q=C.replace(/^"(.*)"$/,"$1"),P=void 0);let G=H?parseInt(H,10):void 0;t.addParticipant(q,P,E.toLowerCase(),G,Y,z);continue}if(p.trim()!==""&&!p.trim().startsWith("'"))throw new Error(`Syntax error at line ${l+1}: ${d}`)}return t}};var gt={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var ot=class{constructor(i){this.theme=i}calculateLayout(i){let t=[...i.participants].sort((N,M)=>N.order!==void 0&&M.order!==void 0?N.order-M.order:N.order!==void 0?-1:M.order!==void 0?1:0),e=this.calculateMaxStep(i);this.finalizeEndSteps(i,e);let n=this.calculateStepHeights(i,e),o=n.stepY,s=n.totalHeight,a=t.map(N=>this.calculateParticipantWidth(N)),c=this.calculateGaps(i,t,a),r=this.calculateRelativepCenterXs(t,a,c),h=this.preCalculateNoteLayouts(i,t,r,a,o),l=this.calculateBounds(t,r,a,h,i.messages),d=this.theme.padding-l.minX,p=l.maxX-l.minX+this.theme.padding*2,$=p;if(i.timeConstraints.length>0){let M=50+Math.max(...i.timeConstraints.map(f=>f.label.length),0)*8;$+=M}let x=i.hideFootbox?0:this.theme.participantHeight+20,g=s+x+this.theme.padding,b=t.map((N,M)=>{let f=r[M]+d;return{participant:N,centerX:f,x:f-a[M]/2,y:N.createdStep!==void 0?o[N.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:a[M],height:this.theme.participantHeight,destroyedY:N.destroyedStep!==void 0?o[N.destroyedStep]:void 0}}),S=[];h.forEach((N,M)=>{let f=N.x+d,y=N.width;M.position==="across"&&(f=this.theme.padding,y=Math.max(p-this.theme.padding*2,N.width)),S.push({note:M,x:f,y:N.y,width:y,height:N.height})});let L=this.calculateGroupLayouts(i,b,S,o,e),R=this.calculateActivationLayouts(i,b,o,i.messages);return{width:$,height:g,participants:b,notes:S,dividers:this.calculateDividerLayouts(i,o,$),references:this.calculateReferenceLayouts(i,b,o),messages:this.calculateMessageLayouts(i,b,o,R),groups:L,activations:R,delays:this.calculateDelayLayouts(i,o),timeConstraints:this.calculateTimeConstraintLayouts(i,b,o,p)}}calculateMessageLayouts(i,t,e,n){return i.messages.map(o=>{let s=t.findIndex(p=>p.participant.name===o.from),a=t.findIndex(p=>p.participant.name===o.to),c=e[o.step],r=s!==-1?t[s].centerX:0,h=a!==-1?t[a].centerX:0;if(s!==-1&&a!==-1){let p=n.filter(x=>x.activation.participantName===o.from&&x.activation.startStep<=o.step&&(x.activation.endStep??1/0)>=o.step).sort((x,g)=>g.activation.level-x.activation.level),$=n.filter(x=>x.activation.participantName===o.to&&x.activation.startStep<=o.step&&(x.activation.endStep??1/0)>=o.step).sort((x,g)=>g.activation.level-x.activation.level);s!==a&&(s<a?(p.length>0&&(r=p[0].x+p[0].width),$.length>0&&(h=$[0].x)):(p.length>0&&(r=p[0].x),$.length>0&&(h=$[0].x+$[0].width)))}a!==-1&&t[a].participant.createdStep===o.step&&(h=t[a].x);let l=[{x:r,y:c},{x:h,y:c}],d={x:(r+h)/2,y:c};if(s===a&&s!==-1){let p=n.filter(g=>g.activation.participantName===o.from&&g.activation.startStep<=o.step&&(g.activation.endStep??1/0)>=o.step).sort((g,b)=>b.activation.level-g.activation.level),$=0,x=0;if(p.length>0){let g=p[0];g.activation.startStep===o.step?p.length>1?($=1,x=0):($=void 0,x=0):g.activation.endStep===o.step&&(p.length>1?($=0,x=1):($=0,x=void 0));let b=$!==void 0&&p.length>$?p[$].x+p[$].width:t[s].centerX,S=x!==void 0&&p.length>x?p[x].x+p[x].width:t[s].centerX,L=40;l[0]={x:b,y:c},l[1]={x:Math.max(b,S)+L,y:c},l.push({x:Math.max(b,S)+L,y:c+25}),l.push({x:S,y:c+25}),d={x:Math.max(b,S)+L+5,y:c+10}}else{let g=t[s].centerX,b=40;l[0]={x:g,y:c},l[1]={x:g+b,y:c},l.push({x:g+b,y:c+25}),l.push({x:g,y:c+25}),d={x:g+b+5,y:c+10}}}return{message:o,y:c,points:l,labelPosition:d,lineStyle:o.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(i,t,e){return i.dividers.map(n=>({y:t[n.step],label:n.label}))}calculateDelayLayouts(i,t){return i.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(i,t,e,n){return i.timeConstraints.map(o=>{let s=i.taggedSteps.get(o.startTag),a=i.taggedSteps.get(o.endTag);return s===void 0||a===void 0?null:{x:n-this.theme.padding+20,startY:e[s],endY:e[a],label:o.label}}).filter(o=>o!==null)}calculateReferenceLayouts(i,t,e){return i.references.map(n=>{let o=n.participants.map(d=>t.findIndex(p=>p.participant.name===d)).filter(d=>d!==-1);if(o.length===0)return null;let s=Math.min(...o),a=Math.max(...o),c=t[s].x,r=t[a].x+t[a].width-c,h=e[n.startStep]-10,l=e[n.endStep]-h;return{reference:n,x:c,y:h,width:r,height:l}}).filter(n=>n!==null)}calculateActivationLayouts(i,t,e,n){return i.activations.map(o=>{let s=t.findIndex(p=>p.participant.name===o.participantName);if(s===-1)return null;let c=t[s].centerX-this.theme.activationWidth/2+o.level*5,r=e[o.startStep];if(o.sourceStep!==void 0){let p=n.find($=>$.step===o.sourceStep);p&&p.from===o.participantName&&p.to===o.participantName&&(r+=25)}let h=e[o.endStep];if(o.endSourceStep!==void 0){let p=n.find($=>$.step===o.endSourceStep);p&&p.from===o.participantName&&p.to===o.participantName&&(h+=25)}let d=Math.max(5,h-r);return{activation:o,x:c,y:r,width:this.theme.activationWidth,height:d}}).filter(o=>o!==null)}calculateMaxStep(i){let t=0;return[...i.messages,...i.activations,...i.groups,...i.references,...i.notes,...i.dividers,...i.delays,...i.spacings].forEach(n=>{let o=n.step??n.startStep??n.endStep??0;o>t&&(t=o)}),t+1}finalizeEndSteps(i,t){i.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),i.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(i,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),n=new Array(t+2).fill(0),o=new Array(t+2).fill(0);i.notes.forEach(r=>{let l=r.text.split(`
`).length*20+10;n[r.step]=Math.max(n[r.step],l/2),o[r.step]=Math.max(o[r.step],l/2)}),i.messages.forEach(r=>{let l=r.text.split(`
`).length;if(r.from===r.to){let d=Math.max(25,l*20);n[r.step]=Math.max(n[r.step],0),o[r.step]=Math.max(o[r.step],d+10)}else{let d=l*15+5;n[r.step]=Math.max(n[r.step],d),o[r.step]=Math.max(o[r.step],0)}});let s=new Array(t+1).fill(this.theme.defaultMessageGap);i.dividers.forEach(r=>{s[r.step]=30}),i.delays.forEach(r=>{s[r.step]=40}),i.spacings.forEach(r=>{s[r.step]=r.height}),i.references.forEach(r=>{let l=r.label.split(`
`).length*15+40;r.endStep===r.startStep+1&&(s[r.startStep]=Math.max(s[r.startStep],l))});for(let r=0;r<=t;r++){let h=o[r]+n[r+1]+10;e[r]=Math.max(s[r],h)}let a=new Array(t+1).fill(0),c=this.theme.padding+90;for(let r=0;r<=t;r++)a[r]=c,c+=e[r];return{stepY:a,totalHeight:c}}calculateParticipantWidth(i){let e=(i.label||i.name).replace(/\\n/g,`
`).split(`
`),n=Math.max(...e.map(o=>o.length));return Math.max(this.theme.participantWidth,n*9+30)}calculateGaps(i,t,e){let n=Math.max(0,t.length-1),o=new Array(n).fill(60),s=this.calculateMaxStep(i);for(let a=0;a<=s;a++){let c=new Array(n).fill(0);for(let r=0;r<t.length;r++){let h=t[r].name;if(t[r].createdStep===a){let S=e[r];r<n&&(c[r]=Math.max(c[r],S/2+20))}let d=15,p=i.messages.find(S=>S.step===a&&S.from===h&&S.to===h);p&&(d=40+(Math.max(...p.text.split(`
`).map(L=>L.length*8))+20)+10);let $=i.activations.filter(S=>S.participantName===h&&S.startStep<=a&&(S.endStep??1/0)>=a);if($.length>0){let S=Math.max(...$.map(L=>L.level));d=Math.max(d,this.theme.activationWidth/2+S*5+10)}i.notes.filter(S=>S.step===a&&S.position==="right"&&S.participants?.includes(h)).forEach(S=>{let L=Math.max(60,Math.max(...S.text.split(`
`).map(R=>R.length*8.5))+20);d+=L+10}),r<n&&(c[r]+=d);let g=15;i.notes.filter(S=>S.step===a&&S.position==="left"&&S.participants?.includes(h)).forEach(S=>{let L=Math.max(60,Math.max(...S.text.split(`
`).map(R=>R.length*8.5))+20);g+=L+10}),r>0&&(c[r-1]+=g)}for(let r=0;r<n;r++)o[r]=Math.max(o[r],c[r])}return i.messages.forEach(a=>{let c=t.findIndex($=>$.name===a.from),r=t.findIndex($=>$.name===a.to);if(c===-1||r===-1||c===r)return;let h=Math.max(...a.text.split(`
`).map($=>$.length*8))+20,l=Math.min(c,r),d=Math.max(c,r),p=0;for(let $=l;$<d;$++)p+=e[$]/2+o[$]+e[$+1]/2;if(p<h){let x=(h-p)/(d-l);for(let g=l;g<d;g++)o[g]+=x}}),i.notes.forEach(a=>{if(a.position!=="over"&&a.position!=="across")return;let c=a.text.split(`
`),r=Math.max(60,Math.max(...c.map(h=>h.length*8.5))+20);if(a.participants&&a.participants.length>0){let h=t.findIndex($=>$.name===a.participants[0]),l=a.participants.length>1?t.findIndex($=>$.name===a.participants[1]):h;if(h===-1||l===-1)return;let d=Math.min(h,l),p=Math.max(h,l);if(d===p){let $=r/2+10;d<n&&o[d]<$&&(o[d]=$)}else{let $=0;for(let x=d;x<p;x++)$+=e[x]/2+o[x]+e[x+1]/2;if($<r){let g=(r-$)/(p-d);for(let b=d;b<p;b++)o[b]+=g}}}}),o}calculateRelativepCenterXs(i,t,e){let n=new Array(i.length).fill(0);return i.forEach((o,s)=>{s===0?n[s]=t[s]/2:n[s]=n[s-1]+t[s-1]/2+e[s-1]+t[s]/2}),n}preCalculateNoteLayouts(i,t,e,n,o){let s=new Map,a=new Map;return i.notes.forEach(c=>{let r=c.text.split(`
`),h=Math.max(...r.map(g=>g.length*8.5))+20,d=Math.max(h,60),p=r.length*20+10,$=o[c.step]-p/2,x=0;if(c.position==="across")x=0,s.set(c,{x,y:$,width:d,height:p});else if(c.position==="over"){let g=c.participants.map(b=>t.findIndex(S=>S.name===b)).filter(b=>b!==-1);if(g.length>0){let b=Math.min(...g),S=Math.max(...g),L=e[S]+n[S]/2-(e[b]-n[b]/2),R=Math.max(L,d);x=e[b]-n[b]/2-(R-L)/2,s.set(c,{x,y:$,width:R,height:p})}}else{let g=(c.participants||[]).map(b=>t.findIndex(S=>S.name===b)).filter(b=>b!==-1);if(g.length>0){let b=c.position==="left"?Math.min(...g):Math.max(...g),S=e[b],L=`${c.step}-${b}-${c.position}`,R=t[b],N=n[b]/2,f=c.step===R.createdStep?N:0;if(c.position==="left")x=(a.get(L)??S-f-5)-d,a.set(L,x-10);else{let y=i.messages.find(F=>F.step===c.step&&F.from===R.name&&F.to===R.name),u=0;if(y){let F=y.text.split(`
`);u=40+(Math.max(...F.map(E=>E.length*8))+20)}let w=i.activations.filter(F=>F.participantName===R.name&&F.startStep<=c.step&&(F.endStep??1/0)>=c.step),m=w.length>0?Math.max(...w.map(F=>F.level)):0,k=this.theme.activationWidth/2+m*5,v=Math.max(f,k,u);x=a.get(L)??S+v+5,a.set(L,x+d+10)}s.set(c,{x,y:$,width:d,height:p})}}}),s}calculateBounds(i,t,e,n,o){let s=0,a=0;return i.forEach((c,r)=>{let h=t[r]-e[r]/2,l=t[r]+e[r]/2;r===0?(s=h,a=l):(h<s&&(s=h),l>a&&(a=l))}),n.forEach(c=>{c.x<s&&(s=c.x),c.x+c.width>a&&(a=c.x+c.width)}),o.forEach(c=>{let r=i.findIndex(p=>p.name===c.from),h=i.findIndex(p=>p.name===c.to);if(r===-1||h===-1)return;let l=c.text.split(`
`),d=Math.max(...l.map(p=>p.length*8))+20;if(r===h){let p=t[r],$=Math.max(...c.text.split(`
`).map(g=>g.length*8))+20,x=p+40+$+10;x>a&&(a=x)}else{let p=t[r],$=t[h],x=(p+$)/2,g=x-d/2,b=x+d/2;g<s&&(s=g),b>a&&(a=b)}}),{minX:s,maxX:a}}calculateGroupLayouts(i,t,e,n,o){let s=i.groups.length>0?Math.max(...i.groups.map(a=>a.level)):0;return i.groups.map(a=>{let c=a.participants.map(M=>t.findIndex(f=>f.participant.name===M)).filter(M=>M!==-1);if(c.length===0)return null;let r=Math.min(...c),h=Math.max(...c),l=s-a.level,d=10+l*10,p=25+l*8,$=5+l*8,x=t[r].x+t[r].width/2-t[r].width/2-d,g=t[r].x-d,b=t[h].x+t[h].width+d-g;e.filter(M=>{let f=M.note;if(f.step<a.startStep||f.step>(a.endStep||o))return!1;let y=f.owner;if(!y)return!1;if(y===a)return!0;let u=y.endStep??o,w=a.endStep??o;return y.startStep>=a.startStep&&u<=w}).forEach(M=>{let f=M.note;if(f.position==="right"){let y=(f.participants||[]).map(u=>t.findIndex(w=>w.participant.name===u)).filter(u=>u!==-1);if(y.length>0&&Math.max(...y)===h){let u=M.x+M.width,w=g+b;u+10>w&&(b=u+10-g)}}else if(f.position==="left"){let y=(f.participants||[]).map(u=>t.findIndex(w=>w.participant.name===u)).filter(u=>u!==-1);if(y.length>0&&Math.min(...y)===r){let u=M.x,w=g;if(u-10<w){let m=w-(u-10);g-=m,b+=m}}}});let L=n[a.startStep]-p,R=n[a.endStep]+$,N=a.sections.map(M=>({label:M.label,y:n[M.startStep]}));return{group:a,x:g,y:L,width:b,height:R-L,type:a.type,label:a.label,sections:N}}).filter(a=>a!==null)}};var st=class{constructor(){this.theme=gt;this.lastSvg="";this.layoutEngine=new ot(this.theme)}render(i){this.ensureParticipants(i);let t=this.layoutEngine.calculateLayout(i);return this.generateSvg(i,t)}ensureParticipants(i){i.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>i.addParticipant(e))})}generateSvg(i,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(i),e+=this.renderLifelines(i,t),e+=this.renderActivations(i,t),e+=this.renderGroups(t),e+=this.renderParticipants(i,t),e+=this.renderReferences(i,t),e+=this.renderNotes(t),e+=this.renderMessages(i,t),e+=this.renderDividers(i,t),e+=this.renderDelays(i,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),i.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${i.title}</text>`),i.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${i.header}</text>`),i.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${i.footer}</text>`),e+="</svg>",e}renderDefs(i){let t=new Set;t.add(this.theme.colors.defaultStroke),i.messages.forEach(n=>{t.add(this.normalizeColor(n.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(n=>{let o=n.replace("#","");e+=`
      <marker id="arrowhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-open-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${n}" />
      </marker>
      <marker id="halfhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${n}" />
      </marker>
      <marker id="circlehead-${o}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${n}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${o}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
        <circle cx="14" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${o}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${n}" />
        <circle cx="4" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="losthead-${o}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${n}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${n}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(i,t){let e="";return t.participants.forEach(n=>{if(n.participant.name==="["||n.participant.name==="]")return;let o=n.centerX,s=n.destroyedY!==void 0?n.destroyedY:i.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${o}" y1="${n.y+n.height}" x2="${o}" y2="${s}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(i){let t="";return i.participants.forEach(e=>{if(e.destroyedY!==void 0){let n=e.centerX,o=e.destroyedY,s=12;t+=`<line x1="${n-s}" y1="${o-s}" x2="${n+s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${n+s}" y1="${o-s}" x2="${n-s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(i,t){let e="",n=(o,s)=>{let a=this.normalizeColor(o.participant.color,this.theme.colors.actorFill),c=o.x,r=s?o.y:t.height-this.theme.padding-this.theme.participantHeight-20,h=o.centerX,l=r+this.theme.participantHeight/2,p=(o.participant.label||o.participant.name).replace(/\\n/g,`
`).split(`
`);switch(o.participant.type){case"actor":e+=`<circle cx="${h}" cy="${r+10}" r="8" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+18}" x2="${h}" y2="${r+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-10}" y1="${r+22}" x2="${h+10}" y2="${r+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h-8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h+8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+55+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"boundary":e+=`<line x1="${h-20}" y1="${l}" x2="${h-10}" y2="${l}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-20}" y1="${l-10}" x2="${h-20}" y2="${l+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"control":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${h+4} ${l-18} L ${h-4} ${l-14} L ${h+4} ${l-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"entity":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-14}" y1="${l+14}" x2="${h+14}" y2="${l+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"database":let $=34,x=40,g=r,b=h-$/2;e+=`<path d="M ${b} ${g+10} L ${b} ${g+x-10} A 17 8 0 0 0 ${b+$} ${g+x-10} L ${b+$} ${g+10} A 17 8 0 0 0 ${b} ${g+10} M ${b} ${g+10} A 17 8 0 0 1 ${b+$} ${g+10}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${b} ${g+10} A 17 8 0 0 0 ${b+$} ${g+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"collections":let S=34,L=34,R=r+3,N=h-S/2;e+=`<rect x="${N+4}" y="${R-4}" width="${S}" height="${L}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${N}" y="${R}" width="${S}" height="${L}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"queue":let M=40,f=40,y=r+3,u=h-M/2,w=5,m=f/2;e+=`<path d="M ${u+M} ${y} L ${u} ${y} A ${w} ${m} 0 0 0 ${u} ${y+f} L ${u+M} ${y+f} A ${w} ${m} 0 0 0 ${u+M} ${y}" fill="${a}" stroke="none" />`,e+=`<ellipse cx="${u+M}" cy="${y+m}" rx="${w}" ry="${m}" fill="${a}" stroke="none" />`,e+=`<path d="M ${u+M} ${y} L ${u} ${y} A ${w} ${m} 0 0 0 ${u} ${y+f} L ${u+M} ${y+f}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${u+M}" cy="${y+m}" rx="${w}" ry="${m}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;default:e+=`<rect x="${c}" y="${r}" width="${o.width}" height="${this.theme.participantHeight}" rx="5" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((k,v)=>{let A=p.length>1?l-(p.length-1)*7.5+v*15:l;e+=`<text x="${h}" y="${A}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`})}};return t.participants.forEach(o=>{o.participant.name==="["||o.participant.name==="]"||(n(o,!0),i.hideFootbox||n(o,!1))}),e}renderGroups(i){let t="";return i.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(n=>{let o=n.y;t+=`<line x1="${e.x}" y1="${o}" x2="${e.x+e.width}" y2="${o}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${o+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${n.label}]</text>`})}),t}renderNotes(i){let t="";return i.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(i,t){let e="";return[...t.activations].sort((o,s)=>o.activation.level-s.activation.level).forEach(o=>{let s=o.activation.color||this.theme.colors.actorFill;e+=`<rect x="${o.x}" y="${o.y}" width="${o.width}" height="${o.height}" fill="${s}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(i,t){let e="";return t.references.forEach(n=>{e+=`<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${n.x} ${n.y} L ${n.x+70} ${n.y} L ${n.x+70} ${n.y+10} L ${n.x+60} ${n.y+20} L ${n.x} ${n.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${n.x+5}" y="${n.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let o=n.reference.label.split(`
`),s=this.theme.fontSize+2,a=o.length*s,c=25,r=n.y+n.height/2-a/2+s/2;r<n.y+c+s/2&&(r=n.y+c+s/2),o.forEach((h,l)=>{e+=`<text x="${n.x+n.width/2}" y="${r+l*s}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${h}</text>`})}),e}renderMessages(i,t){let e="";return t.messages.forEach(n=>{let o=n.message,s=this.normalizeColor(o.color,this.theme.colors.defaultStroke),a=n.lineStyle==="dashed"?"4":"0",c=s.replace("#",""),r=(x,g)=>{if(x==="none")return"none";let b="";return x==="default"?b=g?`arrowhead-reverse-${c}`:`arrowhead-${c}`:x==="open"?b=g?`arrowhead-open-reverse-${c}`:`arrowhead-open-${c}`:x==="half"?b=g?`halfhead-reverse-${c}`:`halfhead-${c}`:x==="circle"?b=`circlehead-${c}`:x==="arrow-circle"?b=g?`arrowhead-circle-reverse-${c}`:`arrowhead-circle-${c}`:x==="lost"?b=`losthead-${c}`:x==="found"&&(b=`circlehead-${c}`),b?`url(#${b})`:"none"},h=r(o.arrowHead||"default",!1),l=r(o.startHead||(o.bidirectional?"default":"none"),!0);if(n.points.length>2){let x=`M ${n.points.map(g=>`${g.x} ${g.y}`).join(" L ")}`;e+=`<path d="${x}" fill="none" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}else{let[x,g]=n.points;e+=`<line x1="${x.x}" y1="${x.y}" x2="${g.x}" y2="${g.y}" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}let p=(o.number?`[${o.number}] ${o.text}`:o.text).split(`
`),$=n.points.length>2?"start":"middle";p.forEach((x,g)=>{let S=n.labelPosition.y-(p.length-1-g)*15-5;n.points.length>2&&(S=n.labelPosition.y+g*20),e+=`<text x="${n.labelPosition.x}" y="${S}" text-anchor="${$}" font-size="${this.theme.fontSize-2}" fill="${s}">${x}</text>`})}),e}renderDividers(i,t){let e="";return t.dividers.forEach(n=>{let o=n.y;if(e+=`<line x1="${this.theme.padding}" y1="${o}" x2="${t.width-this.theme.padding}" y2="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${o+4}" x2="${t.width-this.theme.padding}" y2="${o+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,n.label){let s=n.label.length*9+20;e+=`<rect x="${t.width/2-s/2}" y="${o-10}" width="${s}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${n.label}</text>`}}),e}renderDelays(i,t){let e="";return t.delays.forEach(n=>{let o=n.y,s=t.width/2,a=10,c=5;if(n.text){let r=n.text.length*8+20;e+=`<text x="${s}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${n.text}</text>`;for(let h=0;h<c;h++){let l=s-r/2-10-h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}for(let h=0;h<c;h++){let l=s+r/2+10+h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let r=-10;r<=10;r++)r!==0&&(e+=`<circle cx="${s+r*a}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(i){let t="";return i.timeConstraints.forEach(e=>{let n=e.x,o=e.startY,s=e.endY,a=this.theme.colors.defaultStroke;if(t+=`<line x1="${n}" y1="${o}" x2="${n}" y2="${s}" stroke="${a}" stroke-width="1.5" />`,t+=`<polygon points="${n} ${o}, ${n-4} ${o+8}, ${n+4} ${o+8}" fill="${a}" />`,t+=`<polygon points="${n} ${s}, ${n-4} ${s-8}, ${n+4} ${s-8}" fill="${a}" />`,e.label){let c=(o+s)/2;t+=`<text x="${n+10}" y="${c}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${a}">${e.label}</text>`}}),t}normalizeColor(i,t){return i?i.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(i)?i:i.substring(1):i:t}formatRichText(i){let t=i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return t=t.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),t=t.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),t}drawNoteShape(i,t,e,n,o,s,a,c){let r="",h=this.normalizeColor(a,this.theme.colors.noteFill),l=this.theme.colors.defaultStroke,d=s||"folder";if(d==="hexagon"){let x=[`${t+10},${e}`,`${t+n-10},${e}`,`${t+n},${e+o/2}`,`${t+n-10},${e+o}`,`${t+10},${e+o}`,`${t},${e+o/2}`].join(" ");r+=`<polygon points="${x}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(d==="bubble"){let $=o/2;r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" rx="${$}" ry="${$}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(d==="rectangle")r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;else{let x=`
                M ${t} ${e}
                L ${t+n-10} ${e}
                L ${t+n} ${e+10}
                L ${t+n} ${e+o}
                L ${t} ${e+o}
                Z
            `;r+=`<path d="${x}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;let g=`
                M ${t+n-10} ${e}
                L ${t+n-10} ${e+10}
                L ${t+n} ${e+10}
            `;r+=`<path d="${g}" fill="none" stroke="${l}" stroke-width="1.5" />`}c.split(`
`).forEach(($,x)=>{r+=`<text x="${t+n/2}" y="${e+20+x*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText($)}</text>`}),this.lastSvg=i+r}};var rt=class{constructor(){this.type="component";this.components=[];this.relationships=[];this.notes=[]}addComponent(i,t,e,n,o){let s=this.components.find(a=>a.name===i);return s?(e&&(s.label=e),n&&(s.parentId=n),o&&(s.color=o),t!=="component"&&s.type==="component"&&(s.type=t)):(s={name:i,type:t,label:e||i,isVisible:!0,parentId:n,color:o,declarationOrder:this.components.length},this.components.push(s)),s}addRelationship(i,t,e="solid",n,o,s=!0,a){this.relationships.push({from:i,to:t,type:e,label:n,direction:o,showArrowHead:s})}addNote(i,t,e,n){let o=`note_${this.notes.length}`;this.notes.push({text:i,position:t,linkedTo:e,id:o,alias:n})}findComponent(i){return this.components.find(t=>t.name===i||t.alias===i)}};var at=class{parse(i){let t=new rt,e=i.split(`
`),n=new Set,o=new Set;for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;let h=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(h){n.add(h[3]||h[1]||(h[2]?h[2].replace(/^"(.*)"$/,"$1"):""));continue}let l=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(l){n.add(l[2]||l[1].replace(/^"(.*)"$/,"$1"));continue}let d=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(d){n.add(d[2]||d[1].replace(/^"(.*)"$/,"$1"));continue}let p=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(p){n.add(p[2]||p[1]);continue}let $=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if($){n.add($[3]||$[2].replace(/^"(.*)"$/,"$1"));continue}let x=r.match(/^note\s+as\s+(\S+)$/i);if(x){o.add(x[1]);continue}}let s=null,a=[];for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;if(s){if(r.endsWith("]"))if(s.isDescription&&s.linkedTo){let u=s.text.join(`
`),w=t.findComponent(s.linkedTo);w&&(w.label=u),s=null}else r.toLowerCase()==="end note"?(t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null):s.text.push(r);else if(r.toLowerCase()==="end note"&&!s.isDescription)t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null;else if(s.isDescription&&r.endsWith("]")){let u=r.substring(0,r.length-1).trim();u&&s.text.push(u);let w=s.text.join(`
`),m=t.findComponent(s.linkedTo);m&&(m.label=w),s=null}else s.text.push(r);continue}let h=a.length>0?a[a.length-1]:void 0,l=r.match(/^\[([^\]]+)\]\s+(left\s+of|right\s+of|top\s+of|bottom\s+of)\s+\[([^\]]+)\](?:\s+(#\w+))?$/i);if(l){let u=l[1],w=l[2].toLowerCase().replace(/\s+of$/,""),m=l[3],k=l[4],v;w==="left"?v="left":w==="right"?v="right":w==="top"?v="top":v="bottom";let A=t.addComponent(u,"component",u,h,this.parseColor(k));A.positionHint={reference:m,position:v};continue}let d=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(d){let u=d[1],w=d[2],m=d[3],k=d[4],v=u||(w?w.replace(/^"(.*)"$/,"$1"):""),A=m||v;t.addComponent(A,"component",v,h,this.parseColor(k)),r.trim().endsWith("[")&&(s={text:[],linkedTo:A,alias:void 0,isDescription:!0});continue}let p=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(p){let u=p[1].replace(/^"(.*)"$/,"$1"),w=p[2],m=p[3];t.addComponent(w||u,"interface",u,h,this.parseColor(m)),r.trim().endsWith("[")&&(s={text:[],linkedTo:w||u,alias:void 0,isDescription:!0});continue}let $=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if($){let u=$[1].replace(/^"(.*)"$/,"$1"),w=$[2],m=$[3];t.addComponent(w||u,"interface",u,h,this.parseColor(m));continue}let x=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(x){let u=x[1],w=x[2],m=x[3],k=w||u;t.addComponent(k,"component",u,h,this.parseColor(m)),r.trim().endsWith("[")&&(s={text:[],linkedTo:k,alias:void 0,isDescription:!0});continue}let g=r.match(/^(package|node|folder|frame|cloud|database|component|interface)(?:\s+(".*?"|\S+))?\s*\{$/i);if(g){let u=g[1].toLowerCase(),w=g[2],m=w?w.replace(/^"(.*)"$/,"$1"):u;if(w)t.addComponent(m,u,m,h);else{let k=t.components.filter(v=>v.type===u).length;m=`${u}_${k}_${c}`,t.addComponent(m,u,"",h)}a.push(m);continue}if(r==="}"){a.pop();continue}let b=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(b){let u=b[1].toLowerCase(),w=b[2].replace(/^"(.*)"$/,"$1"),m=b[3],k="port";u==="portin"&&(k="portin"),u==="portout"&&(k="portout"),t.addComponent(m||w,k,w,h);continue}let S='(\\(\\)\\s+)?(?:\\[([^\\]]+)\\]|(".*?"|[^\\s-]+))',L="([<>]*[-.]+[<>]*[^[\\]\\s]*)",R="(?:\\s+|(?<=[^\\s])(?=[<\\-.>])|(?<=[<\\-.>])(?=[^\\s]))",N=new RegExp(`^${S}${R}${L}${R}${S}(?:\\s*:\\s*(.*))?$`),M=r.match(N);if(M){let u=!!M[1],w=M[2]||M[3],m=!!M[2],k=M[4],v=!!M[5],A=M[6]||M[7],F=!!M[6],U=M[8],E=w,C=A,T=m,D=F,X=u,H=v,Y=k.includes("<"),z=k.includes(">");Y&&!z&&(E=A,C=w,T=F,D=m,X=v,H=u);let q=E.replace(/^"(.*)"$/,"$1"),P=C.replace(/^"(.*)"$/,"$1");if(!t.components.some(V=>V.name===q)&&!o.has(q)){let V=T?"component":"interface";t.addComponent(q,V,q,h)}if(!t.components.some(V=>V.name===P)&&!o.has(P)){let V=D?"component":"interface";t.addComponent(P,V,P,h)}let G="solid";k.includes("..")?G="dashed":k.includes("--")&&(G="solid");let O;if(k.includes("left")||k.includes("le")?O="left":k.includes("right")||k.includes("ri")?O="right":k.includes("up")?O="up":(k.includes("down")||k.includes("do"))&&(O="down"),!O){let _=k.replace(/[<>]/g,"").match(/(-+|\.+)/);if(_){let Z=_[1].length;Y&&!z?O=Z>=2?"up":"left":O=Z>=2?"down":"right"}}let j=z||Y;t.addRelationship(q,P,G,U,O,j,h);continue}let f=r.match(/^note\s+as\s+(\S+)$/i);if(f){let u=f[1];s={text:[],alias:u};continue}let y=r.match(/^note\s+(left|right|top|bottom)\s+of\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s*:\s*(.*))?$/i);if(y){let u=y[1].toLowerCase(),m=(y[2]||y[3]).replace(/^"(.*)"$/,"$1"),k=!!y[2];t.findComponent(m)||t.addComponent(m,k?"component":"interface");let v=y[4];v?t.addNote(v,u,m):s={text:[],position:u,linkedTo:m};continue}}return t}parseColor(i){if(i){if(i.startsWith("#")){let t=i.substring(1);return/^([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)?i:t}return i}}};var ct=class{constructor(i,t){this.diagram=i;this.theme=t;this.layoutMap=new Map;this.gridCells=new Map;this.noteLayoutMap=new Map}calculateLayout(){this.layoutMap.clear();let i=this.diagram.components.filter(l=>!l.parentId);this.layoutGroup(i,0,0);let t=[];this.layoutMap.forEach((l,d)=>{let p=this.diagram.components.find($=>$.name===d);p&&t.push({...l,component:p})}),this.straightenVerticalLines(t),t.forEach(l=>{let d=this.layoutMap.get(l.component.name);d&&(l.x=d.x,l.y=d.y)});let e=1/0,n=1/0,o=-1/0,s=-1/0;t.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let a=this.layoutNotes(t);a.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let c=this.theme.padding-e,r=this.theme.padding-n;(c!==0||r!==0)&&(t.forEach(l=>{l.x+=c,l.y+=r;let d=this.layoutMap.get(l.component.name);d.x=l.x,d.y=l.y}),a.forEach(l=>{l.x+=c,l.y+=r}),o+=c,s+=r);let h=this.diagram.relationships.map(l=>this.routeRelationship(l));return{components:t,relationships:h,notes:a,width:o+this.theme.padding,height:s+this.theme.padding}}straightenVerticalLines(i){let t=new Set;this.diagram.components.filter(n=>n.positionHint).forEach(n=>{t.add(n.name),t.add(n.positionHint.reference)});let e=this.diagram.relationships.filter(n=>!n.direction||n.direction==="down"||n.direction==="up");if(e.length!==0)for(let n=0;n<50;n++){let o=new Map;if(e.forEach(a=>{let c=this.layoutMap.get(a.from),r=this.layoutMap.get(a.to);if(!c||!r)return;let h=c.x+c.width/2,d=r.x+r.width/2-h;if(Math.abs(d)<.1||e.filter(S=>S.from===a.from).length>1||e.filter(S=>S.to===a.to).length>1)return;let x=this.findLowestCommonParent(a.from,a.to),g=this.getAncestorUnder(a.from,x),b=this.getAncestorUnder(a.to,x);if(g&&b&&g!==b){if(t.has(g)||t.has(b))return;o.has(g)||o.set(g,{totalShift:0,count:0}),o.has(b)||o.set(b,{totalShift:0,count:0});let S=o.get(g),L=o.get(b);S.totalShift+=d/2,S.count++,L.totalShift-=d/2,L.count++}}),o.size===0)break;let s=!1;if(o.forEach((a,c)=>{let r=a.totalShift/a.count;if(Math.abs(r)<.1)return;let h=this.layoutMap.get(c);if(h){h.x+=r,s=!0;let l=this.gridCells.get(c);l&&(l.x+=r,this.gridCells.set(c,l));let d=this.diagram.components.filter(p=>p.parentId===c);d.length>0&&this.shiftChildren(d,r,0)}}),!s)break}}findLowestCommonParent(i,t){let e=this.getAncestorPath(i),n=this.getAncestorPath(t),o;for(let s=0;s<Math.min(e.length,n.length)&&e[s]===n[s];s++)o=e[s];return o}getAncestorPath(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?[...this.getAncestorPath(t.parentId),t.parentId]:[]}getAncestorUnder(i,t){let e=this.diagram.components.find(n=>n.name===i);return e&&e.parentId!==t?this.getAncestorUnder(e.parentId,t):i}getTopLevelAncestor(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?this.getTopLevelAncestor(t.parentId):i}layoutGroup(i,t,e){if(i.length===0)return{x:t,y:e,width:0,height:0};let n=new Map;i.forEach(f=>{let y=this.theme.componentWidth,u=this.theme.componentHeight;if(f.type==="interface"){y=this.theme.interfaceRadius*2,u=this.theme.interfaceRadius*2;let m=(f.label||f.name).split(/\\n|\n/),v=Math.max(...m.map(A=>A.length))*8;y=Math.max(y,v),u+=m.length*20}else{let w=this.diagram.components.filter(v=>v.parentId===f.name),m=w.filter(v=>v.type==="port"||v.type==="portin"||v.type==="portout"),k=w.filter(v=>v.type!=="port"&&v.type!=="portin"&&v.type!=="portout");if(k.length>0){let v=this.layoutGroup(k,0,0);y=v.width+this.theme.packagePadding*2,u=v.height+this.theme.packagePadding*2+30}else{let A=(f.label||f.name).split(/\\n|\n/),F=Math.max(...A.map(U=>U.length));y=Math.max(y,F*9+20),u=Math.max(u,A.length*20+20)}}n.set(f.name,{width:y,height:u})});let o=new Set(i.map(f=>f.name)),s=new Map,a=(f,y)=>{for(let u of y.values())if(u.row===f.row&&u.col===f.col)return!0;return!1},c=i.filter(f=>f.positionHint).sort((f,y)=>f.declarationOrder-y.declarationOrder);for(let f of c){let y=f.positionHint;if(!i.find(k=>k.name===y.reference))continue;s.has(y.reference)||s.set(y.reference,{row:0,col:0});let w=s.get(y.reference),m;switch(y.position){case"right":m={row:w.row,col:w.col+1};break;case"left":m={row:w.row,col:w.col-1};break;case"bottom":m={row:w.row+1,col:w.col};break;case"top":m={row:w.row-1,col:w.col};break;default:m={row:w.row+1,col:w.col};break}for(;a(m,s);)y.position==="left"?m.col--:y.position==="right"?m.col++:y.position==="top"?m.row--:y.position==="bottom"?m.row++:m.col++;s.set(f.name,m)}let r=new Map;i.forEach(f=>{r.set(f.name,f.name),this.getAllDescendants(f.name).forEach(u=>r.set(u,f.name))});let h=[],l=new Set;if(this.diagram.relationships.forEach(f=>{let y=r.get(f.from),u=r.get(f.to);if(y&&u&&y!==u){let w=`${y}->${u}`;l.has(w)||(l.add(w),h.push({from:y,to:u,direction:f.direction||"down"}))}}),h.length>0){let f=new Map;h.forEach(m=>{let k=m.direction||"down";f.has(m.from)||f.set(m.from,[]),f.get(m.from).push({target:m.to,direction:k}),f.has(m.to)||f.set(m.to,[]);let v=k==="down"?"up":k==="up"?"down":k==="right"?"left":"right";f.get(m.to).push({target:m.from,direction:v})});let y=[];for(let m of s.keys())y.push(m);let u=i.filter(m=>!h.some(k=>k.to===m.name)).sort((m,k)=>m.declarationOrder-k.declarationOrder);if(y.length===0){let m=u.length>0?u[0].name:h[0].from;s.set(m,{row:0,col:0}),y.push(m)}for(let m of u)if(!s.has(m.name)&&h.some(k=>k.from===m.name||k.to===m.name)){let k=0;for(;a({row:0,col:k},s);)k++;s.set(m.name,{row:0,col:k}),y.push(m.name)}let w=new Set;for(;y.length>0;){let m=y.shift();if(w.has(m))continue;w.add(m);let k=s.get(m),v=f.get(m)||[],A=new Map;v.forEach(F=>{s.has(F.target)||(A.has(F.direction)||A.set(F.direction,[]),A.get(F.direction).push(F.target))}),A.forEach((F,U)=>{F.sort((C,T)=>{let D=i.find(H=>H.name===C),X=i.find(H=>H.name===T);return(D?.declarationOrder??0)-(X?.declarationOrder??0)}).forEach((C,T)=>{let D=k.row,X=k.col,H=F.length===1?0:T-(F.length-1)/2;switch(U){case"down":D++,X+=Math.round(H*1.5);break;case"up":D--,X+=Math.round(H*1.5);break;case"right":X++,D+=Math.round(H*1.5);break;case"left":X--,D+=Math.round(H*1.5);break}for(;a({row:D,col:X},s);)U==="down"||U==="up"?X++:D++;s.set(C,{row:D,col:X}),y.push(C)})})}}let d=i.filter(f=>!s.has(f.name)).sort((f,y)=>f.declarationOrder-y.declarationOrder);if(d.length>0){let f=-1;s.forEach(w=>f=Math.max(f,w.row));let y=f+1,u=Math.ceil(Math.sqrt(d.length));d.forEach((w,m)=>{s.set(w.name,{row:y+Math.floor(m/u),col:m%u})})}let p=new Set;i.filter(f=>f.positionHint).forEach(f=>{p.add(f.name),p.add(f.positionHint.reference)}),i.forEach(f=>{if(p.has(f.name))return;let y=h.filter(u=>u.from===f.name&&u.direction==="down");if(y.length>0){let u=s.get(f.name);if(u){let w=y.map(m=>s.get(m.to)?.col).filter(m=>m!==void 0);if(w.length>0){let m=w.reduce((k,v)=>k+v,0)/w.length;u.col=Math.round(m)}}}}),(()=>{let f=1/0,y=1/0;s.forEach(m=>{f=Math.min(f,m.row),y=Math.min(y,m.col)}),s.forEach(m=>{m.row-=f,m.col-=y});let u=Array.from(s.keys()).sort((m,k)=>{let v=s.get(m),A=s.get(k);return v.row-A.row||v.col-A.col}),w=new Set;u.forEach(m=>{let k=s.get(m),v=`${k.row},${k.col}`;for(;w.has(v);)k.col++,v=`${k.row},${k.col}`;w.add(v)})})();let x=0,g=0;s.forEach(f=>{x=Math.max(x,f.row),g=Math.max(g,f.col)});let b=new Array(g+1).fill(0),S=new Array(x+1).fill(0);s.forEach((f,y)=>{let u=n.get(y);b[f.col]=Math.max(b[f.col],u.width),S[f.row]=Math.max(S[f.row],u.height)});let L=[t];for(let f=1;f<=g;f++)L[f]=L[f-1]+b[f-1]+this.theme.componentGapX;let R=[e];for(let f=1;f<=x;f++)R[f]=R[f-1]+S[f-1]+this.theme.componentGapY;console.log("--- Grid Layout Details ---"),console.log("Col Widths:",b),console.log("Col Starts:",L),console.log("Row Heights:",S),console.log("Row Starts:",R),i.forEach(f=>{let y=s.get(f.name),u=n.get(f.name),w=L[y.col],m=R[y.row],k=b[y.col],v=S[y.row],A=w+(k-u.width)/2,F=m+(v-u.height)/2;this.layoutMap.set(f.name,{x:A,y:F,width:u.width,height:u.height}),this.gridCells.set(f.name,{x:w,w:k})}),i.forEach(f=>{let y=n.get(f.name),u=this.layoutMap.get(f.name),w=u.x,m=u.y,k=this.diagram.components.filter(F=>F.parentId===f.name),v=k.filter(F=>F.type!=="port"&&F.type!=="portin"&&F.type!=="portout");v.length>0&&this.shiftChildren(v,w+this.theme.packagePadding,m+30+this.theme.packagePadding);let A=k.filter(F=>F.type==="port"||F.type==="portin"||F.type==="portout");A.length>0&&this.layoutPorts(f,A,w,m,y.width,y.height)});let N=L[g]+b[g]-t,M=R[x]+S[x]-e;return{x:t,y:e,width:N,height:M}}shiftChildren(i,t,e){i.forEach(n=>{let o=this.layoutMap.get(n.name);if(o){o.x+=t,o.y+=e,this.layoutMap.set(n.name,o);let s=this.gridCells.get(n.name);s&&(s.x+=t,this.gridCells.set(n.name,s));let a=this.diagram.components.filter(c=>c.parentId===n.name);a.length>0&&this.shiftChildren(a,t,e)}})}getAllDescendants(i){let t=[];return this.diagram.components.filter(n=>n.parentId===i).forEach(n=>{t.push(n.name),t.push(...this.getAllDescendants(n.name))}),t}routeRelationship(i){let t=this.layoutMap.get(i.from);t||(t=this.noteLayoutMap.get(i.from));let e=this.layoutMap.get(i.to);if(e||(e=this.noteLayoutMap.get(i.to)),!t||!e)return{relationship:i,path:[]};let n=this.diagram.components.find(d=>d.name===i.from),o=this.diagram.components.find(d=>d.name===i.to),s={x:t.x+t.width/2,y:t.y+t.height/2},a={x:e.x+e.width/2,y:e.y+e.height/2},c=n?.type==="interface"?this.theme.interfaceRadius:0,r=o?.type==="interface"?this.theme.interfaceRadius:0,h=this.getIntersection(s,a,t,c,n?.type==="interface"),l=this.getIntersection(a,s,e,r,o?.type==="interface");return{relationship:i,path:[h,l],labelPosition:{x:(h.x+l.x)/2,y:(h.y+l.y)/2-10}}}getIntersection(i,t,e,n=0,o=!1){let s=t.x-i.x,a=t.y-i.y,c=Math.sqrt(s*s+a*a);if(c===0)return i;if(o){let $=n/c;return{x:i.x+s*$,y:i.y+a*$}}let r=e.width/2+n,h=e.height/2+n,l=Math.abs(s),d=Math.abs(a),p=1;return l*h>d*r?p=r/l:p=h/d,{x:i.x+s*p,y:i.y+a*p}}layoutNotes(i){let t=[],e=0;return i.forEach(n=>e=Math.max(e,n.y+n.height)),e+=50,this.diagram.notes.forEach((n,o)=>{let s=n.text.split(`
`),a=Math.max(100,Math.max(...s.map(p=>p.length*8))+20),c=s.length*20+20,r=0,h=e+o*60;if(n.linkedTo){let p=i.find($=>$.component.name===n.linkedTo);p&&(n.position==="right"?(r=p.x+p.width+30,h=p.y+(p.height-c)/2):n.position==="left"?(r=p.x-a-30,h=p.y+(p.height-c)/2):n.position==="top"?(r=p.x+(p.width-a)/2,h=p.y-c-30):n.position==="bottom"?(r=p.x+(p.width-a)/2,h=p.y+p.height+30):(r=p.x+p.width+30,h=p.y+(p.height-c)/2))}let l={note:n,x:r,y:h,width:a,height:c};t.push(l);let d=n.alias||n.id;this.noteLayoutMap.set(d,{x:r,y:h,width:a,height:c})}),t}layoutPorts(i,t,e,n,o,s){let a={top:[],bottom:[],left:[],right:[]};t.forEach(l=>{let d=this.diagram.relationships.filter(M=>M.from===l.name||M.to===l.name);if(d.length===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let p=0,$=0,x=0;if(d.forEach(M=>{let f=M.from===l.name?M.to:M.from,y=this.layoutMap.get(f);y&&(p+=y.x+y.width/2,$+=y.y+y.height/2,x++)}),x===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let g=p/x,b=$/x,S=e+o/2,L=n+s/2,R=g-S,N=b-L;Math.abs(R)>=Math.abs(N)?R>0?a.right.push(l):a.left.push(l):N>0?a.bottom.push(l):a.top.push(l)});let c=10,r=c/2,h=(l,d)=>{if(l.length===0)return;let p=l.length,g=(d==="left"||d==="right"?s:o)/(p+1);l.forEach((b,S)=>{let L=0,R=0;d==="left"?(L=e-r,R=n+g*(S+1)-r):d==="right"?(L=e+o-r,R=n+g*(S+1)-r):d==="top"?(L=e+g*(S+1)-r,R=n-r):d==="bottom"&&(L=e+g*(S+1)-r,R=n+s-r),this.layoutMap.set(b.name,{x:L,y:R,width:c,height:c})})};h(a.left,"left"),h(a.right,"right"),h(a.top,"top"),h(a.bottom,"bottom")}};var $t={padding:20,componentWidth:120,componentHeight:50,interfaceRadius:10,componentGapX:80,componentGapY:60,fontSize:13,packagePadding:20,colors:{defaultStroke:"#5a6270",defaultFill:"#e8edf3",interfaceFill:"#ffffff",noteFill:"#fff9c4",noteStroke:"#e0d86e",line:"#5a6270",text:"#2c3e50",textLight:"#7f8c9b",packageFill:"#ebf0f7",packageStroke:"#7b8fa8",nodeFill:"#ebf0f7",folderFill:"#ebf0f7",frameFill:"#ebf0f7",cloudFill:"#ebf0f7",databaseFill:"#ebf0f7",componentIcon:"#7b8fa8"},fontFamily:"'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};var lt=class{constructor(){this.theme=$t}render(i){if(i.type!=="component")throw new Error("ComponentSVGRenderer only supports component diagrams");let t=i;this.layoutEngine=new ct(t,this.theme);let e=this.layoutEngine.calculateLayout(),n=Math.max(e.width,100),o=Math.max(e.height,100),s=`<svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${o}" viewBox="0 0 ${n} ${o}">`;return s+=`<defs>
            <marker id="comp-arrow-end" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polygon points="0,0 10,3.5 0,7" fill="${this.theme.colors.line}" />
            </marker>
            <marker id="comp-arrow-open" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polyline points="0,0 10,3.5 0,7" fill="none" stroke="${this.theme.colors.line}" stroke-width="1.5" />
            </marker>
            <filter id="comp-shadow" x="-4%" y="-4%" width="112%" height="112%">
                <feDropShadow dx="1" dy="1" stdDeviation="2" flood-color="#00000020" />
            </filter>
        </defs>`,[...e.components].sort((c,r)=>{let h=l=>{let d=0,p=l.component.parentId;for(;p;)d++,p=t.components.find($=>$.name===p)?.parentId;return d};return h(c)-h(r)}).forEach(c=>{s+=this.renderComponentNode(c,t,e)}),e.notes.forEach(c=>{s+=this.renderNote(c)}),e.relationships.forEach(c=>{s+=this.renderRelationship(c,t)}),s+="</svg>",s}renderComponentNode(i,t,e){let{component:n}=i;switch(n.type){case"interface":return this.renderInterface(i);case"package":return this.renderPackage(i);case"node":return this.renderNode(i);case"folder":return this.renderFolder(i);case"frame":return this.renderFrame(i);case"cloud":return this.renderCloud(i);case"database":return this.renderDatabase(i);case"port":case"portin":case"portout":return this.renderPort(i,t,e);default:return this.renderComponent(i,t)}}renderComponent(i,t){let{x:e,y:n,width:o,height:s,component:a}=i,c=a.color||this.theme.colors.defaultFill,r=this.theme.colors.defaultStroke,l=(a.label||a.name).split(/\\n|\n/),d=14,p=18,$=6,x=6,g=8,b=5,S=t.components.some(M=>M.parentId===a.name),L=e+o/2,R=n+s/2,N="middle";return S&&(R=n+20),`
            <g filter="url(#comp-shadow)">
                <rect x="${e}" y="${n}" width="${o}" height="${s}" fill="${c}" stroke="${r}" stroke-width="1.5" rx="3" ry="3" />
                <!-- SysML Component Icon: rectangle with two tabs -->
                <rect x="${e+$}" y="${n+x}" width="${d}" height="${p}" fill="none" stroke="${this.theme.colors.componentIcon}" stroke-width="1.2" rx="1" />
                <rect x="${e+$-g/2}" y="${n+x+3}" width="${g}" height="${b}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <rect x="${e+$-g/2}" y="${n+x+10}" width="${g}" height="${b}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <text x="${L}" y="${R}" text-anchor="${N}" dominant-baseline="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${l.map((M,f)=>`<tspan x="${L}" dy="${f===0?S?0:-((l.length-1)*.6)+"em":"1.2em"}">${this.escapeXml(M)}</tspan>`).join("")}
                </text>
            </g>
        `}renderInterface(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=this.theme.interfaceRadius,c=t+n/2,r=e+o/2,l=(s.label||s.name).split(/\\n|\n/);return`
            <g>
                <circle cx="${c}" cy="${r}" r="${a}" fill="${this.theme.colors.interfaceFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5"/>
                <text x="${c}" y="${r+a+16}" text-anchor="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${l.map((d,p)=>`<tspan x="${c}" dy="${p===0?0:"1.2em"}">${this.escapeXml(d)}</tspan>`).join("")}
                </text>
            </g>
        `}renderPackage(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=22,r=a.length*8+20,h=Math.min(Math.max(r,60),n*.6);return`
            <g filter="url(#comp-shadow)">
                <!-- Package tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+h-5},${e} L${t+h},${e+c}" fill="${this.theme.colors.packageFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Package body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.packageFill}" fill-opacity="0.25" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" rx="1" />
                <!-- Label in tab -->
                <text x="${t+10}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderNode(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=10;return`
            <g filter="url(#comp-shadow)">
                <!-- Top face -->
                <polygon points="${t},${e+c} ${t+c},${e} ${t+n+c},${e} ${t+n},${e+c}" fill="${this.theme.colors.nodeFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Right face -->
                <polygon points="${t+n},${e+c} ${t+n+c},${e} ${t+n+c},${e+o} ${t+n},${e+o+c}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.7" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Front face -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    \xABnode\xBB ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFolder(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=16,r=Math.min(60,n*.35);return`
            <g filter="url(#comp-shadow)">
                <!-- Folder tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+r-8},${e} L${t+r},${e+c}" fill="${this.theme.colors.folderFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <!-- Folder body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.folderFill}" fill-opacity="0.3" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" rx="1" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFrame(i){let{x:t,y:e,width:n,height:o,component:s}=i,c=(s.label||s.name).split(/\\n|\n/),r=Math.max(...c.map(d=>d.length)),h=Math.min(r*8+24,n*.6),l=22+(c.length-1)*14;return`
            <g filter="url(#comp-shadow)">
                <!-- Frame body -->
                <rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${this.theme.colors.frameFill}" fill-opacity="0.25" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5" rx="2" />
                <!-- Pentagon name tag -->
                <polygon points="${t},${e} ${t+h},${e} ${t+h},${e+l-6} ${t+h-6},${e+l} ${t},${e+l}" fill="${this.theme.colors.frameFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <text x="${t+8}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${c.map((d,p)=>`<tspan x="${t+8}" dy="${p===0?0:"1.2em"}">${this.escapeXml(d)}</tspan>`).join("")}
                </text>
            </g>
        `}renderCloud(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=a.split(/\\n|\n/),r=n/2,h=o/2,l=n,d=o;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <path d="
                    M${l*.25},${d*.7}
                    C${l*.02},${d*.7} ${l*0},${d*.45} ${l*.15},${d*.35}
                    C${l*.1},${d*.15} ${l*.3},${d*.05} ${l*.45},${d*.2}
                    C${l*.5},${d*.05} ${l*.75},${d*.05} ${l*.78},${d*.25}
                    C${l*1},${d*.2} ${l*1.02},${d*.5} ${l*.85},${d*.6}
                    C${l*.95},${d*.75} ${l*.85},${d*.85} ${l*.7},${d*.78}
                    C${l*.6},${d*.9} ${l*.4},${d*.9} ${l*.25},${d*.7}
                    Z
                " fill="${this.theme.colors.cloudFill}" fill-opacity="0.5" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${r}" y="${h}" text-anchor="middle" dominant-baseline="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((p,$)=>`<tspan x="${r}" dy="${$===0?-((c.length-1)*.6)+"em":"1.2em"}">${this.escapeXml(p)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderDatabase(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=a.split(/\\n|\n/),r=12;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <!-- Cylinder body -->
                <rect x="0" y="${r}" width="${n}" height="${o-r*2}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="none" />
                <!-- Side lines -->
                <line x1="0" y1="${r}" x2="0" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <line x1="${n}" y1="${r}" x2="${n}" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Bottom ellipse -->
                <ellipse cx="${n/2}" cy="${o-r}" rx="${n/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Top ellipse (drawn last to overlay body) -->
                <ellipse cx="${n/2}" cy="${r}" rx="${n/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${n/2}" y="${r+20}" text-anchor="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((h,l)=>`<tspan x="${n/2}" dy="${l===0?0:"1.2em"}">${this.escapeXml(h)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderRelationship(i,t){let{path:e,relationship:n}=i;if(e.length<2)return"";let o=e[0],s=e[e.length-1],a=n.type==="dashed"?"6,4":n.type==="dotted"?"2,3":"none",c="";n.showArrowHead!==!1&&(c=n.type==="dashed"?"url(#comp-arrow-open)":"url(#comp-arrow-end)");let r="";return i.labelPosition&&n.label&&(r=`
                <rect x="${i.labelPosition.x-n.label.length*3.5-4}" y="${i.labelPosition.y-10}" width="${n.label.length*7+8}" height="16" fill="white" fill-opacity="0.85" rx="3" />
                <text x="${i.labelPosition.x}" y="${i.labelPosition.y}" text-anchor="middle" dominant-baseline="middle" fill="${this.theme.colors.textLight}" font-family="${this.theme.fontFamily}" font-size="11" font-style="italic">
                    ${this.escapeXml(n.label)}
                </text>
            `),`
            <g>
                <line x1="${o.x}" y1="${o.y}" x2="${s.x}" y2="${s.y}" stroke="${this.theme.colors.line}" stroke-width="1.3" stroke-dasharray="${a}" marker-end="${c}"/>
                ${r}
            </g>
        `}renderNote(i){let{x:t,y:e,width:n,height:o,note:s}=i,a=12;return`
            <g transform="translate(${t}, ${e})">
                <path d="M0,0 L${n-a},0 L${n},${a} L${n},${o} L0,${o} Z" fill="${this.theme.colors.noteFill}" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <path d="M${n-a},0 L${n-a},${a} L${n},${a}" fill="none" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <text x="10" y="18" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${s.text.split(`
`).map((c,r)=>`<tspan x="10" dy="${r===0?0:"1.3em"}">${this.escapeXml(c)}</tspan>`).join("")}
                </text>
            </g>
        `}escapeXml(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}renderPort(i,t,e){let{x:n,y:o,width:s,height:a,component:c}=i,r=this.theme.colors.line,h="";if(c.parentId){let l=e.components.find(d=>d.component.name===c.parentId);if(l){let d=n+s/2,p=o+a/2,$=l.x+l.width/2,x=l.y+l.height/2,g=d-$,b=p-x,S=0,L=0,R="middle",N="middle",M=10;Math.abs(g)>=Math.abs(b)?g>0?(S=n+s+M/2,L=p,R="start"):(S=n-M/2,L=p,R="end"):b>0?(S=d,L=o+a+M,N="hanging"):(S=d,L=o-M/2,N="auto");let f=c.label||c.name;h=`<text x="${S}" y="${L}" text-anchor="${R}" dominant-baseline="${N}" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-2}">${this.escapeXml(f)}</text>`}}return`
            <g>
                <rect x="${n}" y="${o}" width="${s}" height="${a}" fill="${r}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />
                ${h}
            </g>
        `}};function Q(I){let i=new it,t=new st;try{let e=i.parse(I);return t.render(e)}catch(e){return xt(e)}}function J(I){let i=new at,t=new lt;try{let e=i.parse(I);return t.render(e)}catch(e){return xt(e)}}function xt(I){let t=(I.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=800,n=100;return`
        <svg width="${e}" height="${n}" viewBox="0 0 ${e} ${n}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
            <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
            <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${t}</text>
        </svg>
    `.trim()}function ht(I){let i=/\b(component|interface|package|node|cloud|database|frame|folder)\b|\[.*?\]/.test(I),t=/\b(participant|actor|boundary|control|entity|collections|queue|sequence)\b/.test(I);return i&&!t?J(I):!i&&t?Q(I):/\[.*?\]/.test(I)?J(I):Q(I)}function K(I="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(I).forEach(t=>{let e=t.textContent||"",n=ht(e),o=document.createElement("div");o.className="seeduml-diagram",o.innerHTML=n,o.style.display="inline-block",t.parentNode?.replaceChild(o,t)})}function ut(I={}){let{startOnLoad:i=!0,selector:t="pre.seeduml"}=I;i&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{K(t)}):K(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:Q,renderComponentDiagram:J,render:ht,renderAll:K,initialize:ut});var Lt={renderSequenceDiagram:Q,renderComponentDiagram:J,render:ht,renderAll:K,initialize:ut};return Mt(Ct);})();
