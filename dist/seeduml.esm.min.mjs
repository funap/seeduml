var nt=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumbers=[0];this.autonumberDelimiter=".";this.autonumberStopped=!1;this.autoactivateEnabled=!1}setHideFootbox(i){this.hideFootbox=i}addParticipant(i,t,e="participant",n,o,s){let a=this.participants.find(c=>c.name===i);a?(t&&(a.label=t),e!=="participant"&&(a.type=e),n!==void 0&&(a.order=n),o&&(a.color=o),s&&(a.stereotype=s)):(a={name:i,label:t,type:e,order:n,color:o,stereotype:s},this.participants.push(a)),this.groupStack.forEach(c=>{c.participants.includes(i)||c.participants.push(i)})}addMessage(i,t,e,n="arrow",o="default",s,a,c="none"){let r=this.currentStep++;this.addParticipant(i),this.addParticipant(t);let h;if(this.autonumberConfig&&!this.autonumberStopped){this.currentAutonumbers[this.currentAutonumbers.length-1]+=this.autonumberConfig.increment;let l=this.currentAutonumbers.join(this.autonumberDelimiter);this.autonumberConfig.format?h=this.autonumberConfig.format.replace(/%d/g,l):h=l,e=e.replace(/%autonumber%/g,l),e=e.replace(/<U\+([0-9a-fA-F]{4})>/g,(d,p)=>String.fromCharCode(parseInt(p,16)))}return this.messages.push({from:i,to:t,text:e,type:n,step:r,arrowHead:o,startHead:c,color:s,bidirectional:a,number:h}),this.autoactivateEnabled&&i!==t&&n==="arrow"&&this.activate(t,r,r),r}setAutonumber(i=1,t=1,e){if(this.autonumberConfig={start:typeof i=="number"?i:1,increment:t,format:e},this.autonumberStopped=!1,typeof i=="string"){let n=i.split(/([.,;:])/);n.length>1?(this.autonumberDelimiter=n[1],this.currentAutonumbers=n.filter((o,s)=>s%2===0).map(o=>parseInt(o,10))):this.currentAutonumbers=[parseInt(i,10)]}else this.currentAutonumbers=[i];this.currentAutonumbers[this.currentAutonumbers.length-1]-=t}incrementAutonumberLevel(i){if(!this.autonumberConfig)return;let t=i.toUpperCase().charCodeAt(0)-65;if(t>=0&&t<this.currentAutonumbers.length){this.currentAutonumbers[t]++;for(let e=t+1;e<this.currentAutonumbers.length;e++)this.currentAutonumbers[e]=1;this.currentAutonumbers[this.currentAutonumbers.length-1]-=this.autonumberConfig.increment}}stopAutonumber(){this.autonumberStopped=!0}resumeAutonumber(i,t){this.autonumberConfig?(this.autonumberStopped=!1,i!==void 0&&(this.autonumberConfig.increment=i),t!==void 0&&(this.autonumberConfig.format=t)):this.setAutonumber(1,i||1,t)}setAutoactivate(i){this.autoactivateEnabled=i}destroy(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(i,e.destroyedStep))}create(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.createdStep=t)}addDivider(i){this.dividers.push({label:i,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(i){this.delays.push({text:i,step:this.currentStep++})}addSpacing(i=30){this.spacings.push({height:i,step:this.currentStep++})}setTitle(i){this.title=i}setHeader(i){this.header=i}setFooter(i){this.footer=i}returnMessage(i){let t=[...this.activations].reverse().find(s=>s.endStep===void 0);if(!t)return;let e=t.participantName,n=e;if(t.sourceStep!==void 0){let s=this.messages.find(a=>a.step===t.sourceStep);s&&(n=s.from)}let o=this.addMessage(e,n,i,"dotted","open");this.deactivate(e,o)}addNote(i,t,e,n,o="folder",s){let a=s!==void 0?s:this.currentStep++,c=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0;if(this.autonumberConfig){let r=this.currentAutonumbers.join(this.autonumberDelimiter);i=i.replace(/%autonumber%/g,r),i=i.replace(/<U\+([0-9a-fA-F]{4})>/g,(h,l)=>String.fromCharCode(parseInt(l,16)))}return this.notes.push({text:i,position:t,participants:e,step:a,color:n,shape:o,owner:c}),a}activate(i,t=this.currentStep,e,n){this.addParticipant(i);let o=this.activations.filter(s=>s.participantName===i&&s.endStep===void 0).length;this.activations.push({participantName:i,startStep:t,level:o,sourceStep:e,color:n})}deactivate(i,t=this.currentStep,e){this.addParticipant(i);let n=[...this.activations].reverse().find(o=>o.participantName===i&&o.endStep===void 0);n&&(n.endStep=t,n.endSourceStep=e)}startGroup(i,t){let e=this.nextStep(),n={type:i,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(n),this.groupStack.push(n),n}addGroupSection(i){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:i,startStep:this.nextStep()})}endGroup(){let i=this.groupStack.pop();i&&(i.endStep=this.nextStep())}addReference(i,t){let e=this.nextStep(),n=this.nextStep();this.references.push({participants:i,label:t,startStep:e,endStep:n})}addTaggedStep(i,t){this.taggedSteps.set(i,t)}addTimeConstraint(i,t,e){this.timeConstraints.push({startTag:i,endTag:t,label:e})}};var it=class{parse(i){let t=new nt,e=i.split(`
`),n=null,o=null,s=-1,a="",c="",r="",h=new Map;for(let l=0;l<e.length;l++){let d=e[l],p=d;if(d=d.trim(),!d||d.startsWith("@")||d.startsWith("!pragma"))continue;if(o){let E=d.toLowerCase();if(E.startsWith("end note")||(E==="end hnote"||E==="endhnote")||(E==="end rnote"||E==="endrnote")||(E==="end bnote"||E==="endbnote")){let N=o.position.toLowerCase(),X;if(o.participants.length===0&&(N==="right"||N==="left")&&a&&c){let q=t.participants.findIndex(O=>O.name===a),F=t.participants.findIndex(O=>O.name===c);if(q!==-1&&F!==-1){let O=t.participants[q],G=t.participants[F],B=q<F;O.order!==void 0&&G.order!==void 0&&(B=O.order<G.order),N==="left"?o.participants=[B?a:c]:o.participants=[B?c:a]}else o.participants=[c];s!==-1&&(X=s)}let P=o.text.join(`
`).replace(/\\n/g,`
`);t.addNote(P,o.position,o.participants,o.color,o.shape,X),o=null}else o.text.push(p);continue}if(n){d.toLowerCase().startsWith("end ref")?(t.addReference(n.participants,n.label.join(`
`)),n=null):n.label.push(p);continue}if(d.startsWith("'"))continue;let $=!1;d.startsWith("/")&&($=!0,d=d.substring(1).trim(),t.rewindStep());let w=d.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if(w){let[,E,C]=w;t.addParticipant(C,E),t.create(C,t.getCurrentStep());continue}let m=d.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(m){let[,E,C,I]=m,D=C.replace(/^"(.*)"$/,"$1");if(I&&I.startsWith("#")){let N=I.substring(1);/^[0-9A-Fa-f]+$/.test(N)&&[3,4,6,8].includes(N.length)||(I=N)}let j=E.toLowerCase();if(j==="activate")if(D===c&&s!==-1)t.activate(D,s,s,I),h.set(D,s);else{let N=t.nextStep();t.activate(D,N,void 0,I),h.set(D,N)}else if(j==="deactivate"){let N=!1;s!==-1&&s>(h.get(D)??-1)&&(r==="arrow"?N=D===c||D===a:r==="dotted"&&(N=D===a)),N?t.deactivate(D,s):t.deactivate(D,t.nextStep())}else if(j==="destroy"){let N=!1;s!==-1&&s>(h.get(D)??-1)&&(r==="arrow"?N=D===c||D===a:r==="dotted"&&(N=D===a)),N?t.destroy(D,s):t.destroy(D,t.nextStep())}continue}let x=d.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(x){let[,E,C,I]=x;t.addTimeConstraint(E,C,I||"");continue}let b=d.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if(b){let[,E]=b;t.addDelay(E||void 0);continue}let L=d.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(L){let[,E,C,I,D,j,N,X,P,q,F,O]=L;O=O||"";let G=D+(N||"");if(G.length>0){C&&(C=C.replace(/^"(.*)"$/,"$1")),P&&(P=P.replace(/^"(.*)"$/,"$1")),(!C||C==="[")&&(C="["),(!P||P==="]")&&(P="]");let B=G.includes("..")||G.includes("--"),Z=I.includes("<")&&(X||"").includes(">"),K=(W,mt)=>W?W===">"||W==="<"?"default":W===">>"||W==="<<"?"open":W==="\\"||W==="/"?"half":W==="\\\\"||W==="//"?"open":W.includes("x")?"lost":W.includes("o")?"arrow-circle":"default":"none",J=K(X||"",!1),tt=K(I||"",!0);X==="x"&&(J="lost"),C==="x"&&(tt="found");let bt=O.replace(/\\n/g,`
`),Y=t.addMessage(C,P,bt,B?"dotted":"arrow",J,j,Z,tt);E&&t.addTaggedStep(E,Y);let pt=C,ft=P,et=W=>["default","open","half","arrow-circle"].includes(W);if(et(tt)&&!et(J)?(pt=P,ft=C):et(J)&&!et(tt)&&(pt=C,ft=P),s=Y,a=pt,c=ft,r=B?"dotted":"arrow",q==="++"){if(F&&F.startsWith("#")){let W=F.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(F=W)}t.activate(P,Y,Y,F),h.set(P,Y)}else if(q==="--")t.deactivate(C,Y,Y);else if(q==="--++"){if(t.deactivate(C,Y,Y),F&&F.startsWith("#")){let W=F.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(F=W)}t.activate(P,Y,Y,F),h.set(P,Y)}else if(q==="++--"){if(F&&F.startsWith("#")){let W=F.substring(1);/^[0-9A-Fa-f]+$/.test(W)&&[3,4,6,8].includes(W.length)||(F=W)}t.activate(C,Y,Y,F),h.set(C,Y),t.deactivate(P,Y,Y)}else q==="**"?t.create(P,Y):q==="!!"&&t.destroy(P,Y);continue}}let R=d.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if(R){let[,E,C,I,D,j]=R,N=[];I&&I.trim()&&(N=I.split(",").map(P=>P.trim().replace(/^"(.*)"$/,"$1")));let X="folder";if(E==="h"?X="hexagon":E==="r"?X="rectangle":E==="b"&&(X="bubble"),j!==void 0){let P=C.toLowerCase(),q;if(N.length===0&&(P==="right"||P==="left")&&a&&c){let O=t.participants.findIndex(B=>B.name===a),G=t.participants.findIndex(B=>B.name===c);if(O!==-1&&G!==-1){let B=t.participants[O],Z=t.participants[G],K=O<G;B.order!==void 0&&Z.order!==void 0&&(K=B.order<Z.order),P==="left"?N=[K?a:c]:N=[K?c:a]}else N=[c];s!==-1&&(q=s)}let F=j.replace(/\\n/g,`
`);t.addNote(F,C.toLowerCase(),N,D,X,q)}else o={text:[],position:C.toLowerCase(),participants:N,color:D,shape:X};continue}let A=d.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(A){let[,E,C]=A;t.startGroup(E.toLowerCase(),C||"");continue}let M=d.match(/^else(?:\s+(.*))?$/i);if(M){let[,E]=M;t.addGroupSection(E||"");continue}if(d.toLowerCase().startsWith("end")){t.endGroup();continue}let f=d.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(f){let[,E,C]=f,I=E.split(",").map(D=>D.trim().replace(/^"(.*)"$/,"$1"));C?t.addReference(I,C):n={participants:I,label:[]};continue}let y=d.match(/^return(?:\s+(.*))?$/i);if(y){let[,E]=y,C=(E||"").replace(/\\n/g,`
`);t.returnMessage(C);continue}if(/^autonumber\s+stop$/i.test(d)){t.stopAutonumber();continue}let g=d.match(/^autonumber\s+resume(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(g){let[,E,C]=g;t.resumeAutonumber(E?parseInt(E,10):void 0,C);continue}let k=d.match(/^autonumber\s+inc\s+([A-Z])$/i);if(k){t.incrementAutonumberLevel(k[1]);continue}let u=d.match(/^autonumber(?:\s+([\d.]+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(u){let[,E,C,I]=u,D=C?parseInt(C,10):1;t.setAutonumber(E||1,D,I);continue}let S=d.match(/^autoactivate\s+(on|off)$/i);if(S){t.setAutoactivate(S[1].toLowerCase()==="on");continue}let v=d.match(/^==\s*(.*?)\s*==$/);if(v){t.addDivider(v[1]);continue}if(d==="|||"){t.addSpacing();continue}let T=d.match(/^\|\|(\d+)\|\|$/);if(T){t.addSpacing(parseInt(T[1],10));continue}let H=d.match(/^(title|header|footer)\s+(.*)$/i);if(H){let[,E,C]=H;E.toLowerCase()==="title"?t.setTitle(C):E.toLowerCase()==="header"?t.setHeader(C):E.toLowerCase()==="footer"&&t.setFooter(C);continue}if(d.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let V="(participant|actor|boundary|control|entity|database|collections|queue)",_=new RegExp(`^${V}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),U=d.match(_);if(U){let[,E,C,I,D,j,N,X]=U;if(!E||!C)continue;let P=I||j,q,F;D?D.startsWith('"')?(q=C.replace(/^"(.*)"$/,"$1"),F=D.replace(/^"(.*)"$/,"$1")):(q=D.replace(/^"(.*)"$/,"$1"),F=C.replace(/^"(.*)"$/,"$1")):(q=C.replace(/^"(.*)"$/,"$1"),F=void 0);let O=N?parseInt(N,10):void 0;t.addParticipant(q,F,E.toLowerCase(),O,X,P);continue}if(p.trim()!==""&&!p.trim().startsWith("'"))throw new Error(`Syntax error at line ${l+1}: ${d}`)}return t}};var gt={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var ot=class{constructor(i){this.theme=i}calculateLayout(i){let t=[...i.participants].sort((A,M)=>A.order!==void 0&&M.order!==void 0?A.order-M.order:A.order!==void 0?-1:M.order!==void 0?1:0),e=this.calculateMaxStep(i);this.finalizeEndSteps(i,e);let n=this.calculateStepHeights(i,e),o=n.stepY,s=n.totalHeight,a=t.map(A=>this.calculateParticipantWidth(A)),c=this.calculateGaps(i,t,a),r=this.calculateRelativepCenterXs(t,a,c),h=this.preCalculateNoteLayouts(i,t,r,a,o),l=this.calculateBounds(t,r,a,h,i.messages),d=this.theme.padding-l.minX,p=l.maxX-l.minX+this.theme.padding*2,$=p;if(i.timeConstraints.length>0){let M=50+Math.max(...i.timeConstraints.map(f=>f.label.length),0)*8;$+=M}let w=i.hideFootbox?0:this.theme.participantHeight+20,m=s+w+this.theme.padding,x=t.map((A,M)=>{let f=r[M]+d;return{participant:A,centerX:f,x:f-a[M]/2,y:A.createdStep!==void 0?o[A.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:a[M],height:this.theme.participantHeight,destroyedY:A.destroyedStep!==void 0?o[A.destroyedStep]:void 0}}),b=[];h.forEach((A,M)=>{let f=A.x+d,y=A.width;M.position==="across"&&(f=this.theme.padding,y=Math.max(p-this.theme.padding*2,A.width)),b.push({note:M,x:f,y:A.y,width:y,height:A.height})});let L=this.calculateGroupLayouts(i,x,b,o,e),R=this.calculateActivationLayouts(i,x,o,i.messages);return{width:$,height:m,participants:x,notes:b,dividers:this.calculateDividerLayouts(i,o,$),references:this.calculateReferenceLayouts(i,x,o),messages:this.calculateMessageLayouts(i,x,o,R),groups:L,activations:R,delays:this.calculateDelayLayouts(i,o),timeConstraints:this.calculateTimeConstraintLayouts(i,x,o,p)}}calculateMessageLayouts(i,t,e,n){return i.messages.map(o=>{let s=t.findIndex(p=>p.participant.name===o.from),a=t.findIndex(p=>p.participant.name===o.to),c=e[o.step],r=s!==-1?t[s].centerX:0,h=a!==-1?t[a].centerX:0;if(s!==-1&&a!==-1){let p=n.filter(w=>w.activation.participantName===o.from&&w.activation.startStep<=o.step&&(w.activation.endStep??1/0)>=o.step).sort((w,m)=>m.activation.level-w.activation.level),$=n.filter(w=>w.activation.participantName===o.to&&w.activation.startStep<=o.step&&(w.activation.endStep??1/0)>=o.step).sort((w,m)=>m.activation.level-w.activation.level);s!==a&&(s<a?(p.length>0&&(r=p[0].x+p[0].width),$.length>0&&(h=$[0].x)):(p.length>0&&(r=p[0].x),$.length>0&&(h=$[0].x+$[0].width)))}a!==-1&&t[a].participant.createdStep===o.step&&(h=t[a].x);let l=[{x:r,y:c},{x:h,y:c}],d={x:(r+h)/2,y:c};if(s===a&&s!==-1){let p=n.filter(m=>m.activation.participantName===o.from&&m.activation.startStep<=o.step&&(m.activation.endStep??1/0)>=o.step).sort((m,x)=>x.activation.level-m.activation.level),$=0,w=0;if(p.length>0){let m=p[0];m.activation.startStep===o.step?p.length>1?($=1,w=0):($=void 0,w=0):m.activation.endStep===o.step&&(p.length>1?($=0,w=1):($=0,w=void 0));let x=$!==void 0&&p.length>$?p[$].x+p[$].width:t[s].centerX,b=w!==void 0&&p.length>w?p[w].x+p[w].width:t[s].centerX,L=40;l[0]={x,y:c},l[1]={x:Math.max(x,b)+L,y:c},l.push({x:Math.max(x,b)+L,y:c+25}),l.push({x:b,y:c+25}),d={x:Math.max(x,b)+L+5,y:c+10}}else{let m=t[s].centerX,x=40;l[0]={x:m,y:c},l[1]={x:m+x,y:c},l.push({x:m+x,y:c+25}),l.push({x:m,y:c+25}),d={x:m+x+5,y:c+10}}}return{message:o,y:c,points:l,labelPosition:d,lineStyle:o.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(i,t,e){return i.dividers.map(n=>({y:t[n.step],label:n.label}))}calculateDelayLayouts(i,t){return i.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(i,t,e,n){return i.timeConstraints.map(o=>{let s=i.taggedSteps.get(o.startTag),a=i.taggedSteps.get(o.endTag);return s===void 0||a===void 0?null:{x:n-this.theme.padding+20,startY:e[s],endY:e[a],label:o.label}}).filter(o=>o!==null)}calculateReferenceLayouts(i,t,e){return i.references.map(n=>{let o=n.participants.map(d=>t.findIndex(p=>p.participant.name===d)).filter(d=>d!==-1);if(o.length===0)return null;let s=Math.min(...o),a=Math.max(...o),c=t[s].x,r=t[a].x+t[a].width-c,h=e[n.startStep]-10,l=e[n.endStep]-h;return{reference:n,x:c,y:h,width:r,height:l}}).filter(n=>n!==null)}calculateActivationLayouts(i,t,e,n){return i.activations.map(o=>{let s=t.findIndex(p=>p.participant.name===o.participantName);if(s===-1)return null;let c=t[s].centerX-this.theme.activationWidth/2+o.level*5,r=e[o.startStep];if(o.sourceStep!==void 0){let p=n.find($=>$.step===o.sourceStep);p&&p.from===o.participantName&&p.to===o.participantName&&(r+=25)}let h=e[o.endStep];if(o.endSourceStep!==void 0){let p=n.find($=>$.step===o.endSourceStep);p&&p.from===o.participantName&&p.to===o.participantName&&(h+=25)}let d=Math.max(5,h-r);return{activation:o,x:c,y:r,width:this.theme.activationWidth,height:d}}).filter(o=>o!==null)}calculateMaxStep(i){let t=0;return[...i.messages,...i.activations,...i.groups,...i.references,...i.notes,...i.dividers,...i.delays,...i.spacings].forEach(n=>{let o=n.step??n.startStep??n.endStep??0;o>t&&(t=o)}),t+1}finalizeEndSteps(i,t){i.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),i.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(i,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),n=new Array(t+2).fill(0),o=new Array(t+2).fill(0);i.notes.forEach(r=>{let l=r.text.split(`
`).length*20+10;n[r.step]=Math.max(n[r.step],l/2),o[r.step]=Math.max(o[r.step],l/2)}),i.messages.forEach(r=>{let l=r.text.split(`
`).length;if(r.from===r.to){let d=Math.max(25,l*20);n[r.step]=Math.max(n[r.step],0),o[r.step]=Math.max(o[r.step],d+10)}else{let d=l*15+5;n[r.step]=Math.max(n[r.step],d),o[r.step]=Math.max(o[r.step],0)}});let s=new Array(t+1).fill(this.theme.defaultMessageGap);i.dividers.forEach(r=>{s[r.step]=30}),i.delays.forEach(r=>{s[r.step]=40}),i.spacings.forEach(r=>{s[r.step]=r.height}),i.references.forEach(r=>{let l=r.label.split(`
`).length*15+40;r.endStep===r.startStep+1&&(s[r.startStep]=Math.max(s[r.startStep],l))});for(let r=0;r<=t;r++){let h=o[r]+n[r+1]+10;e[r]=Math.max(s[r],h)}let a=new Array(t+1).fill(0),c=this.theme.padding+90;for(let r=0;r<=t;r++)a[r]=c,c+=e[r];return{stepY:a,totalHeight:c}}calculateParticipantWidth(i){let e=(i.label||i.name).replace(/\\n/g,`
`).split(`
`),n=Math.max(...e.map(o=>o.length));return Math.max(this.theme.participantWidth,n*9+30)}calculateGaps(i,t,e){let n=Math.max(0,t.length-1),o=new Array(n).fill(60),s=this.calculateMaxStep(i);for(let a=0;a<=s;a++){let c=new Array(n).fill(0);for(let r=0;r<t.length;r++){let h=t[r].name;if(t[r].createdStep===a){let b=e[r];r<n&&(c[r]=Math.max(c[r],b/2+20))}let d=15,p=i.messages.find(b=>b.step===a&&b.from===h&&b.to===h);p&&(d=40+(Math.max(...p.text.split(`
`).map(L=>L.length*8))+20)+10);let $=i.activations.filter(b=>b.participantName===h&&b.startStep<=a&&(b.endStep??1/0)>=a);if($.length>0){let b=Math.max(...$.map(L=>L.level));d=Math.max(d,this.theme.activationWidth/2+b*5+10)}i.notes.filter(b=>b.step===a&&b.position==="right"&&b.participants?.includes(h)).forEach(b=>{let L=Math.max(60,Math.max(...b.text.split(`
`).map(R=>R.length*8.5))+20);d+=L+10}),r<n&&(c[r]+=d);let m=15;i.notes.filter(b=>b.step===a&&b.position==="left"&&b.participants?.includes(h)).forEach(b=>{let L=Math.max(60,Math.max(...b.text.split(`
`).map(R=>R.length*8.5))+20);m+=L+10}),r>0&&(c[r-1]+=m)}for(let r=0;r<n;r++)o[r]=Math.max(o[r],c[r])}return i.messages.forEach(a=>{let c=t.findIndex($=>$.name===a.from),r=t.findIndex($=>$.name===a.to);if(c===-1||r===-1||c===r)return;let h=Math.max(...a.text.split(`
`).map($=>$.length*8))+20,l=Math.min(c,r),d=Math.max(c,r),p=0;for(let $=l;$<d;$++)p+=e[$]/2+o[$]+e[$+1]/2;if(p<h){let w=(h-p)/(d-l);for(let m=l;m<d;m++)o[m]+=w}}),i.notes.forEach(a=>{if(a.position!=="over"&&a.position!=="across")return;let c=a.text.split(`
`),r=Math.max(60,Math.max(...c.map(h=>h.length*8.5))+20);if(a.participants&&a.participants.length>0){let h=t.findIndex($=>$.name===a.participants[0]),l=a.participants.length>1?t.findIndex($=>$.name===a.participants[1]):h;if(h===-1||l===-1)return;let d=Math.min(h,l),p=Math.max(h,l);if(d===p){let $=r/2+10;d<n&&o[d]<$&&(o[d]=$)}else{let $=0;for(let w=d;w<p;w++)$+=e[w]/2+o[w]+e[w+1]/2;if($<r){let m=(r-$)/(p-d);for(let x=d;x<p;x++)o[x]+=m}}}}),o}calculateRelativepCenterXs(i,t,e){let n=new Array(i.length).fill(0);return i.forEach((o,s)=>{s===0?n[s]=t[s]/2:n[s]=n[s-1]+t[s-1]/2+e[s-1]+t[s]/2}),n}preCalculateNoteLayouts(i,t,e,n,o){let s=new Map,a=new Map;return i.notes.forEach(c=>{let r=c.text.split(`
`),h=Math.max(...r.map(m=>m.length*8.5))+20,d=Math.max(h,60),p=r.length*20+10,$=o[c.step]-p/2,w=0;if(c.position==="across")w=0,s.set(c,{x:w,y:$,width:d,height:p});else if(c.position==="over"){let m=c.participants.map(x=>t.findIndex(b=>b.name===x)).filter(x=>x!==-1);if(m.length>0){let x=Math.min(...m),b=Math.max(...m),L=e[b]+n[b]/2-(e[x]-n[x]/2),R=Math.max(L,d);w=e[x]-n[x]/2-(R-L)/2,s.set(c,{x:w,y:$,width:R,height:p})}}else{let m=(c.participants||[]).map(x=>t.findIndex(b=>b.name===x)).filter(x=>x!==-1);if(m.length>0){let x=c.position==="left"?Math.min(...m):Math.max(...m),b=e[x],L=`${c.step}-${x}-${c.position}`,R=t[x],A=n[x]/2,f=c.step===R.createdStep?A:0;if(c.position==="left")w=(a.get(L)??b-f-5)-d,a.set(L,w-10);else{let y=i.messages.find(H=>H.step===c.step&&H.from===R.name&&H.to===R.name),g=0;if(y){let H=y.text.split(`
`);g=40+(Math.max(...H.map(_=>_.length*8))+20)}let k=i.activations.filter(H=>H.participantName===R.name&&H.startStep<=c.step&&(H.endStep??1/0)>=c.step),u=k.length>0?Math.max(...k.map(H=>H.level)):0,S=this.theme.activationWidth/2+u*5,v=Math.max(f,S,g);w=a.get(L)??b+v+5,a.set(L,w+d+10)}s.set(c,{x:w,y:$,width:d,height:p})}}}),s}calculateBounds(i,t,e,n,o){let s=0,a=0;return i.forEach((c,r)=>{let h=t[r]-e[r]/2,l=t[r]+e[r]/2;r===0?(s=h,a=l):(h<s&&(s=h),l>a&&(a=l))}),n.forEach(c=>{c.x<s&&(s=c.x),c.x+c.width>a&&(a=c.x+c.width)}),o.forEach(c=>{let r=i.findIndex(p=>p.name===c.from),h=i.findIndex(p=>p.name===c.to);if(r===-1||h===-1)return;let l=c.text.split(`
`),d=Math.max(...l.map(p=>p.length*8))+20;if(r===h){let p=t[r],$=Math.max(...c.text.split(`
`).map(m=>m.length*8))+20,w=p+40+$+10;w>a&&(a=w)}else{let p=t[r],$=t[h],w=(p+$)/2,m=w-d/2,x=w+d/2;m<s&&(s=m),x>a&&(a=x)}}),{minX:s,maxX:a}}calculateGroupLayouts(i,t,e,n,o){let s=i.groups.length>0?Math.max(...i.groups.map(a=>a.level)):0;return i.groups.map(a=>{let c=a.participants.map(M=>t.findIndex(f=>f.participant.name===M)).filter(M=>M!==-1);if(c.length===0)return null;let r=Math.min(...c),h=Math.max(...c),l=s-a.level,d=10+l*10,p=25+l*8,$=5+l*8,w=t[r].x+t[r].width/2-t[r].width/2-d,m=t[r].x-d,x=t[h].x+t[h].width+d-m;e.filter(M=>{let f=M.note;if(f.step<a.startStep||f.step>(a.endStep||o))return!1;let y=f.owner;if(!y)return!1;if(y===a)return!0;let g=y.endStep??o,k=a.endStep??o;return y.startStep>=a.startStep&&g<=k}).forEach(M=>{let f=M.note;if(f.position==="right"){let y=(f.participants||[]).map(g=>t.findIndex(k=>k.participant.name===g)).filter(g=>g!==-1);if(y.length>0&&Math.max(...y)===h){let g=M.x+M.width,k=m+x;g+10>k&&(x=g+10-m)}}else if(f.position==="left"){let y=(f.participants||[]).map(g=>t.findIndex(k=>k.participant.name===g)).filter(g=>g!==-1);if(y.length>0&&Math.min(...y)===r){let g=M.x,k=m;if(g-10<k){let u=k-(g-10);m-=u,x+=u}}}});let L=n[a.startStep]-p,R=n[a.endStep]+$,A=a.sections.map(M=>({label:M.label,y:n[M.startStep]}));return{group:a,x:m,y:L,width:x,height:R-L,type:a.type,label:a.label,sections:A}}).filter(a=>a!==null)}};var st=class{constructor(){this.theme=gt;this.lastSvg="";this.layoutEngine=new ot(this.theme)}render(i){this.ensureParticipants(i);let t=this.layoutEngine.calculateLayout(i);return this.generateSvg(i,t)}ensureParticipants(i){i.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>i.addParticipant(e))})}generateSvg(i,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(i),e+=this.renderLifelines(i,t),e+=this.renderActivations(i,t),e+=this.renderGroups(t),e+=this.renderParticipants(i,t),e+=this.renderReferences(i,t),e+=this.renderNotes(t),e+=this.renderMessages(i,t),e+=this.renderDividers(i,t),e+=this.renderDelays(i,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),i.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${i.title}</text>`),i.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${i.header}</text>`),i.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${i.footer}</text>`),e+="</svg>",e}renderDefs(i){let t=new Set;t.add(this.theme.colors.defaultStroke),i.messages.forEach(n=>{t.add(this.normalizeColor(n.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(n=>{let o=n.replace("#","");e+=`
      <marker id="arrowhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-open-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${n}" />
      </marker>
      <marker id="halfhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${n}" />
      </marker>
      <marker id="circlehead-${o}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${n}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${o}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
        <circle cx="14" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${o}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${n}" />
        <circle cx="4" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="losthead-${o}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${n}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${n}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(i,t){let e="";return t.participants.forEach(n=>{if(n.participant.name==="["||n.participant.name==="]")return;let o=n.centerX,s=n.destroyedY!==void 0?n.destroyedY:i.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${o}" y1="${n.y+n.height}" x2="${o}" y2="${s}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(i){let t="";return i.participants.forEach(e=>{if(e.destroyedY!==void 0){let n=e.centerX,o=e.destroyedY,s=12;t+=`<line x1="${n-s}" y1="${o-s}" x2="${n+s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${n+s}" y1="${o-s}" x2="${n-s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(i,t){let e="",n=(o,s)=>{let a=this.normalizeColor(o.participant.color,this.theme.colors.actorFill),c=o.x,r=s?o.y:t.height-this.theme.padding-this.theme.participantHeight-20,h=o.centerX,l=r+this.theme.participantHeight/2,p=(o.participant.label||o.participant.name).replace(/\\n/g,`
`).split(`
`);switch(o.participant.type){case"actor":e+=`<circle cx="${h}" cy="${r+10}" r="8" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+18}" x2="${h}" y2="${r+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-10}" y1="${r+22}" x2="${h+10}" y2="${r+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h-8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h+8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+55+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"boundary":e+=`<line x1="${h-20}" y1="${l}" x2="${h-10}" y2="${l}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-20}" y1="${l-10}" x2="${h-20}" y2="${l+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"control":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${h+4} ${l-18} L ${h-4} ${l-14} L ${h+4} ${l-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"entity":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-14}" y1="${l+14}" x2="${h+14}" y2="${l+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"database":let $=34,w=40,m=r,x=h-$/2;e+=`<path d="M ${x} ${m+10} L ${x} ${m+w-10} A 17 8 0 0 0 ${x+$} ${m+w-10} L ${x+$} ${m+10} A 17 8 0 0 0 ${x} ${m+10} M ${x} ${m+10} A 17 8 0 0 1 ${x+$} ${m+10}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${x} ${m+10} A 17 8 0 0 0 ${x+$} ${m+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"collections":let b=34,L=34,R=r+3,A=h-b/2;e+=`<rect x="${A+4}" y="${R-4}" width="${b}" height="${L}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${A}" y="${R}" width="${b}" height="${L}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;case"queue":let M=40,f=40,y=r+3,g=h-M/2,k=5,u=f/2;e+=`<path d="M ${g+M} ${y} L ${g} ${y} A ${k} ${u} 0 0 0 ${g} ${y+f} L ${g+M} ${y+f} A ${k} ${u} 0 0 0 ${g+M} ${y}" fill="${a}" stroke="none" />`,e+=`<ellipse cx="${g+M}" cy="${y+u}" rx="${k}" ry="${u}" fill="${a}" stroke="none" />`,e+=`<path d="M ${g+M} ${y} L ${g} ${y} A ${k} ${u} 0 0 0 ${g} ${y+f} L ${g+M} ${y+f}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${g+M}" cy="${y+u}" rx="${k}" ry="${u}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+v*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`});break;default:e+=`<rect x="${c}" y="${r}" width="${o.width}" height="${this.theme.participantHeight}" rx="5" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,p.forEach((S,v)=>{let T=p.length>1?l-(p.length-1)*7.5+v*15:l;e+=`<text x="${h}" y="${T}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${S}</text>`})}};return t.participants.forEach(o=>{o.participant.name==="["||o.participant.name==="]"||(n(o,!0),i.hideFootbox||n(o,!1))}),e}renderGroups(i){let t="";return i.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(n=>{let o=n.y;t+=`<line x1="${e.x}" y1="${o}" x2="${e.x+e.width}" y2="${o}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${o+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${n.label}]</text>`})}),t}renderNotes(i){let t="";return i.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(i,t){let e="";return[...t.activations].sort((o,s)=>o.activation.level-s.activation.level).forEach(o=>{let s=o.activation.color||this.theme.colors.actorFill;e+=`<rect x="${o.x}" y="${o.y}" width="${o.width}" height="${o.height}" fill="${s}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(i,t){let e="";return t.references.forEach(n=>{e+=`<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${n.x} ${n.y} L ${n.x+70} ${n.y} L ${n.x+70} ${n.y+10} L ${n.x+60} ${n.y+20} L ${n.x} ${n.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${n.x+5}" y="${n.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let o=n.reference.label.split(`
`),s=this.theme.fontSize+2,a=o.length*s,c=25,r=n.y+n.height/2-a/2+s/2;r<n.y+c+s/2&&(r=n.y+c+s/2),o.forEach((h,l)=>{e+=`<text x="${n.x+n.width/2}" y="${r+l*s}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${h}</text>`})}),e}renderMessages(i,t){let e="";return t.messages.forEach(n=>{let o=n.message,s=this.normalizeColor(o.color,this.theme.colors.defaultStroke),a=n.lineStyle==="dashed"?"4":"0",c=s.replace("#",""),r=(m,x)=>{if(m==="none")return"none";let b="";return m==="default"?b=x?`arrowhead-reverse-${c}`:`arrowhead-${c}`:m==="open"?b=x?`arrowhead-open-reverse-${c}`:`arrowhead-open-${c}`:m==="half"?b=x?`halfhead-reverse-${c}`:`halfhead-${c}`:m==="circle"?b=`circlehead-${c}`:m==="arrow-circle"?b=x?`arrowhead-circle-reverse-${c}`:`arrowhead-circle-${c}`:m==="lost"?b=`losthead-${c}`:m==="found"&&(b=`circlehead-${c}`),b?`url(#${b})`:"none"},h=r(o.arrowHead||"default",!1),l=r(o.startHead||(o.bidirectional?"default":"none"),!0);if(n.points.length>2){let m=`M ${n.points.map(x=>`${x.x} ${x.y}`).join(" L ")}`;e+=`<path d="${m}" fill="none" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}else{let[m,x]=n.points;e+=`<line x1="${m.x}" y1="${m.y}" x2="${x.x}" y2="${x.y}" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}let d=o.number?this.formatRichText(o.number):"",$=(o.text||"").split(`
`),w=n.points.length>2?"start":"middle";$.forEach((m,x)=>{let L=n.labelPosition.y-($.length-1-x)*15-5;n.points.length>2&&(L=n.labelPosition.y+x*20);let R=this.formatRichText(m),A=x===0&&d?`${d} ${R}`:R;e+=`<text x="${n.labelPosition.x}" y="${L}" text-anchor="${w}" font-size="${this.theme.fontSize-2}" fill="${s}">${A}</text>`})}),e}renderDividers(i,t){let e="";return t.dividers.forEach(n=>{let o=n.y;if(e+=`<line x1="${this.theme.padding}" y1="${o}" x2="${t.width-this.theme.padding}" y2="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${o+4}" x2="${t.width-this.theme.padding}" y2="${o+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,n.label){let s=n.label.length*9+20;e+=`<rect x="${t.width/2-s/2}" y="${o-10}" width="${s}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${n.label}</text>`}}),e}renderDelays(i,t){let e="";return t.delays.forEach(n=>{let o=n.y,s=t.width/2,a=10,c=5;if(n.text){let r=n.text.length*8+20;e+=`<text x="${s}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${n.text}</text>`;for(let h=0;h<c;h++){let l=s-r/2-10-h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}for(let h=0;h<c;h++){let l=s+r/2+10+h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let r=-10;r<=10;r++)r!==0&&(e+=`<circle cx="${s+r*a}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(i){let t="";return i.timeConstraints.forEach(e=>{let n=e.x,o=e.startY,s=e.endY,a=this.theme.colors.defaultStroke;if(t+=`<line x1="${n}" y1="${o}" x2="${n}" y2="${s}" stroke="${a}" stroke-width="1.5" />`,t+=`<polygon points="${n} ${o}, ${n-4} ${o+8}, ${n+4} ${o+8}" fill="${a}" />`,t+=`<polygon points="${n} ${s}, ${n-4} ${s-8}, ${n+4} ${s-8}" fill="${a}" />`,e.label){let c=(o+s)/2;t+=`<text x="${n+10}" y="${c}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${a}">${e.label}</text>`}}),t}normalizeColor(i,t){return i?i.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(i)?i:i.substring(1):i:t}formatRichText(i){let t=i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return t=t.replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/gi,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/&lt;u&gt;(.*?)&lt;\/u&gt;/gi,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/gi,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/&lt;s&gt;(.*?)&lt;\/s&gt;/gi,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/&lt;font\s+color=(?:&quot;)?(.*?)(?:&quot;)?&gt;(.*?)&lt;\/font&gt;/gi,'<tspan fill="$1">$2</tspan>'),t=t.replace(/&lt;b&gt;(?!.*&lt;\/b&gt;)(.*)/gi,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/&lt;font\s+color=(?:&quot;)?(.*?)(?:&quot;)?&gt;(?!.*&lt;\/font&gt;)(.*)/gi,'<tspan fill="$1">$2</tspan>'),t=t.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),t=t.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),t}drawNoteShape(i,t,e,n,o,s,a,c){let r="",h=this.normalizeColor(a,this.theme.colors.noteFill),l=this.theme.colors.defaultStroke,d=s||"folder";if(d==="hexagon"){let w=[`${t+10},${e}`,`${t+n-10},${e}`,`${t+n},${e+o/2}`,`${t+n-10},${e+o}`,`${t+10},${e+o}`,`${t},${e+o/2}`].join(" ");r+=`<polygon points="${w}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(d==="bubble"){let $=o/2;r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" rx="${$}" ry="${$}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(d==="rectangle")r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;else{let w=`
                M ${t} ${e}
                L ${t+n-10} ${e}
                L ${t+n} ${e+10}
                L ${t+n} ${e+o}
                L ${t} ${e+o}
                Z
            `;r+=`<path d="${w}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;let m=`
                M ${t+n-10} ${e}
                L ${t+n-10} ${e+10}
                L ${t+n} ${e+10}
            `;r+=`<path d="${m}" fill="none" stroke="${l}" stroke-width="1.5" />`}c.split(`
`).forEach(($,w)=>{r+=`<text x="${t+n/2}" y="${e+20+w*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText($)}</text>`}),this.lastSvg=i+r}};var rt=class{constructor(){this.type="component";this.components=[];this.relationships=[];this.notes=[]}addComponent(i,t,e,n,o){let s=this.components.find(a=>a.name===i);return s?(e&&(s.label=e),n&&(s.parentId=n),o&&(s.color=o),t!=="component"&&s.type==="component"&&(s.type=t)):(s={name:i,type:t,label:e||i,isVisible:!0,parentId:n,color:o,declarationOrder:this.components.length},this.components.push(s)),s}addRelationship(i,t,e="solid",n,o,s=!0,a){this.relationships.push({from:i,to:t,type:e,label:n,direction:o,showArrowHead:s})}addNote(i,t,e,n){let o=`note_${this.notes.length}`;this.notes.push({text:i,position:t,linkedTo:e,id:o,alias:n})}findComponent(i){return this.components.find(t=>t.name===i||t.alias===i)}};var at=class{parse(i){let t=new rt,e=i.split(`
`),n=new Set,o=new Set;for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;let h=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(h){n.add(h[3]||h[1]||(h[2]?h[2].replace(/^"(.*)"$/,"$1"):""));continue}let l=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(l){n.add(l[2]||l[1].replace(/^"(.*)"$/,"$1"));continue}let d=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(d){n.add(d[2]||d[1].replace(/^"(.*)"$/,"$1"));continue}let p=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(p){n.add(p[2]||p[1]);continue}let $=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if($){n.add($[3]||$[2].replace(/^"(.*)"$/,"$1"));continue}let w=r.match(/^note\s+as\s+(\S+)$/i);if(w){o.add(w[1]);continue}}let s=null,a=[];for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;if(s){if(r.endsWith("]"))if(s.isDescription&&s.linkedTo){let g=s.text.join(`
`),k=t.findComponent(s.linkedTo);k&&(k.label=g),s=null}else r.toLowerCase()==="end note"?(t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null):s.text.push(r);else if(r.toLowerCase()==="end note"&&!s.isDescription)t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null;else if(s.isDescription&&r.endsWith("]")){let g=r.substring(0,r.length-1).trim();g&&s.text.push(g);let k=s.text.join(`
`),u=t.findComponent(s.linkedTo);u&&(u.label=k),s=null}else s.text.push(r);continue}let h=a.length>0?a[a.length-1]:void 0,l=r.match(/^\[([^\]]+)\]\s+(left\s+of|right\s+of|top\s+of|bottom\s+of)\s+\[([^\]]+)\](?:\s+(#\w+))?$/i);if(l){let g=l[1],k=l[2].toLowerCase().replace(/\s+of$/,""),u=l[3],S=l[4],v;k==="left"?v="left":k==="right"?v="right":k==="top"?v="top":v="bottom";let T=t.addComponent(g,"component",g,h,this.parseColor(S));T.positionHint={reference:u,position:v};continue}let d=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(d){let g=d[1],k=d[2],u=d[3],S=d[4],v=g||(k?k.replace(/^"(.*)"$/,"$1"):""),T=u||v;t.addComponent(T,"component",v,h,this.parseColor(S)),r.trim().endsWith("[")&&(s={text:[],linkedTo:T,alias:void 0,isDescription:!0});continue}let p=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(p){let g=p[1].replace(/^"(.*)"$/,"$1"),k=p[2],u=p[3];t.addComponent(k||g,"interface",g,h,this.parseColor(u)),r.trim().endsWith("[")&&(s={text:[],linkedTo:k||g,alias:void 0,isDescription:!0});continue}let $=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if($){let g=$[1].replace(/^"(.*)"$/,"$1"),k=$[2],u=$[3];t.addComponent(k||g,"interface",g,h,this.parseColor(u));continue}let w=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(w){let g=w[1],k=w[2],u=w[3],S=k||g;t.addComponent(S,"component",g,h,this.parseColor(u)),r.trim().endsWith("[")&&(s={text:[],linkedTo:S,alias:void 0,isDescription:!0});continue}let m=r.match(/^(package|node|folder|frame|cloud|database|component|interface)(?:\s+(".*?"|\S+))?\s*\{$/i);if(m){let g=m[1].toLowerCase(),k=m[2],u=k?k.replace(/^"(.*)"$/,"$1"):g;if(k)t.addComponent(u,g,u,h);else{let S=t.components.filter(v=>v.type===g).length;u=`${g}_${S}_${c}`,t.addComponent(u,g,"",h)}a.push(u);continue}if(r==="}"){a.pop();continue}let x=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(x){let g=x[1].toLowerCase(),k=x[2].replace(/^"(.*)"$/,"$1"),u=x[3],S="port";g==="portin"&&(S="portin"),g==="portout"&&(S="portout"),t.addComponent(u||k,S,k,h);continue}let b='(\\(\\)\\s+)?(?:\\[([^\\]]+)\\]|(".*?"|[^\\s-]+))',L="([<>]*[-.]+[<>]*[^[\\]\\s]*)",R="(?:\\s+|(?<=[^\\s])(?=[<\\-.>])|(?<=[<\\-.>])(?=[^\\s]))",A=new RegExp(`^${b}${R}${L}${R}${b}(?:\\s*:\\s*(.*))?$`),M=r.match(A);if(M){let g=!!M[1],k=M[2]||M[3],u=!!M[2],S=M[4],v=!!M[5],T=M[6]||M[7],H=!!M[6],V=M[8],_=k,U=T,E=u,C=H,I=g,D=v,j=S.includes("<"),N=S.includes(">");j&&!N&&(_=T,U=k,E=H,C=u,I=v,D=g);let X=_.replace(/^"(.*)"$/,"$1"),P=U.replace(/^"(.*)"$/,"$1");if(!t.components.some(G=>G.name===X)&&!o.has(X)){let G=E?"component":"interface";t.addComponent(X,G,X,h)}if(!t.components.some(G=>G.name===P)&&!o.has(P)){let G=C?"component":"interface";t.addComponent(P,G,P,h)}let q="solid";S.includes("..")?q="dashed":S.includes("--")&&(q="solid");let F;if(S.includes("left")||S.includes("le")?F="left":S.includes("right")||S.includes("ri")?F="right":S.includes("up")?F="up":(S.includes("down")||S.includes("do"))&&(F="down"),!F){let B=S.replace(/[<>]/g,"").match(/(-+|\.+)/);if(B){let Z=B[1].length;j&&!N?F=Z>=2?"up":"left":F=Z>=2?"down":"right"}}let O=N||j;t.addRelationship(X,P,q,V,F,O,h);continue}let f=r.match(/^note\s+as\s+(\S+)$/i);if(f){let g=f[1];s={text:[],alias:g};continue}let y=r.match(/^note\s+(left|right|top|bottom)\s+of\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s*:\s*(.*))?$/i);if(y){let g=y[1].toLowerCase(),u=(y[2]||y[3]).replace(/^"(.*)"$/,"$1"),S=!!y[2];t.findComponent(u)||t.addComponent(u,S?"component":"interface");let v=y[4];v?t.addNote(v,g,u):s={text:[],position:g,linkedTo:u};continue}}return t}parseColor(i){if(i){if(i.startsWith("#")){let t=i.substring(1);return/^([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)?i:t}return i}}};var ct=class{constructor(i,t){this.diagram=i;this.theme=t;this.layoutMap=new Map;this.gridCells=new Map;this.noteLayoutMap=new Map}calculateLayout(){this.layoutMap.clear();let i=this.diagram.components.filter(l=>!l.parentId);this.layoutGroup(i,0,0);let t=[];this.layoutMap.forEach((l,d)=>{let p=this.diagram.components.find($=>$.name===d);p&&t.push({...l,component:p})}),this.straightenVerticalLines(t),t.forEach(l=>{let d=this.layoutMap.get(l.component.name);d&&(l.x=d.x,l.y=d.y)});let e=1/0,n=1/0,o=-1/0,s=-1/0;t.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let a=this.layoutNotes(t);a.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let c=this.theme.padding-e,r=this.theme.padding-n;(c!==0||r!==0)&&(t.forEach(l=>{l.x+=c,l.y+=r;let d=this.layoutMap.get(l.component.name);d.x=l.x,d.y=l.y}),a.forEach(l=>{l.x+=c,l.y+=r}),o+=c,s+=r);let h=this.diagram.relationships.map(l=>this.routeRelationship(l));return{components:t,relationships:h,notes:a,width:o+this.theme.padding,height:s+this.theme.padding}}straightenVerticalLines(i){let t=new Set;this.diagram.components.filter(n=>n.positionHint).forEach(n=>{t.add(n.name),t.add(n.positionHint.reference)});let e=this.diagram.relationships.filter(n=>!n.direction||n.direction==="down"||n.direction==="up");if(e.length!==0)for(let n=0;n<50;n++){let o=new Map;if(e.forEach(a=>{let c=this.layoutMap.get(a.from),r=this.layoutMap.get(a.to);if(!c||!r)return;let h=c.x+c.width/2,d=r.x+r.width/2-h;if(Math.abs(d)<.1||e.filter(b=>b.from===a.from).length>1||e.filter(b=>b.to===a.to).length>1)return;let w=this.findLowestCommonParent(a.from,a.to),m=this.getAncestorUnder(a.from,w),x=this.getAncestorUnder(a.to,w);if(m&&x&&m!==x){if(t.has(m)||t.has(x))return;o.has(m)||o.set(m,{totalShift:0,count:0}),o.has(x)||o.set(x,{totalShift:0,count:0});let b=o.get(m),L=o.get(x);b.totalShift+=d/2,b.count++,L.totalShift-=d/2,L.count++}}),o.size===0)break;let s=!1;if(o.forEach((a,c)=>{let r=a.totalShift/a.count;if(Math.abs(r)<.1)return;let h=this.layoutMap.get(c);if(h){h.x+=r,s=!0;let l=this.gridCells.get(c);l&&(l.x+=r,this.gridCells.set(c,l));let d=this.diagram.components.filter(p=>p.parentId===c);d.length>0&&this.shiftChildren(d,r,0)}}),!s)break}}findLowestCommonParent(i,t){let e=this.getAncestorPath(i),n=this.getAncestorPath(t),o;for(let s=0;s<Math.min(e.length,n.length)&&e[s]===n[s];s++)o=e[s];return o}getAncestorPath(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?[...this.getAncestorPath(t.parentId),t.parentId]:[]}getAncestorUnder(i,t){let e=this.diagram.components.find(n=>n.name===i);return e&&e.parentId!==t?this.getAncestorUnder(e.parentId,t):i}getTopLevelAncestor(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?this.getTopLevelAncestor(t.parentId):i}layoutGroup(i,t,e){if(i.length===0)return{x:t,y:e,width:0,height:0};let n=new Map;i.forEach(f=>{let y=this.theme.componentWidth,g=this.theme.componentHeight;if(f.type==="interface"){y=this.theme.interfaceRadius*2,g=this.theme.interfaceRadius*2;let u=(f.label||f.name).split(/\\n|\n/),v=Math.max(...u.map(T=>T.length))*8;y=Math.max(y,v),g+=u.length*20}else{let k=this.diagram.components.filter(v=>v.parentId===f.name),u=k.filter(v=>v.type==="port"||v.type==="portin"||v.type==="portout"),S=k.filter(v=>v.type!=="port"&&v.type!=="portin"&&v.type!=="portout");if(S.length>0){let v=this.layoutGroup(S,0,0);y=v.width+this.theme.packagePadding*2,g=v.height+this.theme.packagePadding*2+30}else{let T=(f.label||f.name).split(/\\n|\n/),H=Math.max(...T.map(V=>V.length));y=Math.max(y,H*9+20),g=Math.max(g,T.length*20+20)}}n.set(f.name,{width:y,height:g})});let o=new Set(i.map(f=>f.name)),s=new Map,a=(f,y)=>{for(let g of y.values())if(g.row===f.row&&g.col===f.col)return!0;return!1},c=i.filter(f=>f.positionHint).sort((f,y)=>f.declarationOrder-y.declarationOrder);for(let f of c){let y=f.positionHint;if(!i.find(S=>S.name===y.reference))continue;s.has(y.reference)||s.set(y.reference,{row:0,col:0});let k=s.get(y.reference),u;switch(y.position){case"right":u={row:k.row,col:k.col+1};break;case"left":u={row:k.row,col:k.col-1};break;case"bottom":u={row:k.row+1,col:k.col};break;case"top":u={row:k.row-1,col:k.col};break;default:u={row:k.row+1,col:k.col};break}for(;a(u,s);)y.position==="left"?u.col--:y.position==="right"?u.col++:y.position==="top"?u.row--:y.position==="bottom"?u.row++:u.col++;s.set(f.name,u)}let r=new Map;i.forEach(f=>{r.set(f.name,f.name),this.getAllDescendants(f.name).forEach(g=>r.set(g,f.name))});let h=[],l=new Set;if(this.diagram.relationships.forEach(f=>{let y=r.get(f.from),g=r.get(f.to);if(y&&g&&y!==g){let k=`${y}->${g}`;l.has(k)||(l.add(k),h.push({from:y,to:g,direction:f.direction||"down"}))}}),h.length>0){let f=new Map;h.forEach(u=>{let S=u.direction||"down";f.has(u.from)||f.set(u.from,[]),f.get(u.from).push({target:u.to,direction:S}),f.has(u.to)||f.set(u.to,[]);let v=S==="down"?"up":S==="up"?"down":S==="right"?"left":"right";f.get(u.to).push({target:u.from,direction:v})});let y=[];for(let u of s.keys())y.push(u);let g=i.filter(u=>!h.some(S=>S.to===u.name)).sort((u,S)=>u.declarationOrder-S.declarationOrder);if(y.length===0){let u=g.length>0?g[0].name:h[0].from;s.set(u,{row:0,col:0}),y.push(u)}for(let u of g)if(!s.has(u.name)&&h.some(S=>S.from===u.name||S.to===u.name)){let S=0;for(;a({row:0,col:S},s);)S++;s.set(u.name,{row:0,col:S}),y.push(u.name)}let k=new Set;for(;y.length>0;){let u=y.shift();if(k.has(u))continue;k.add(u);let S=s.get(u),v=f.get(u)||[],T=new Map;v.forEach(H=>{s.has(H.target)||(T.has(H.direction)||T.set(H.direction,[]),T.get(H.direction).push(H.target))}),T.forEach((H,V)=>{H.sort((U,E)=>{let C=i.find(D=>D.name===U),I=i.find(D=>D.name===E);return(C?.declarationOrder??0)-(I?.declarationOrder??0)}).forEach((U,E)=>{let C=S.row,I=S.col,D=H.length===1?0:E-(H.length-1)/2;switch(V){case"down":C++,I+=Math.round(D*1.5);break;case"up":C--,I+=Math.round(D*1.5);break;case"right":I++,C+=Math.round(D*1.5);break;case"left":I--,C+=Math.round(D*1.5);break}for(;a({row:C,col:I},s);)V==="down"||V==="up"?I++:C++;s.set(U,{row:C,col:I}),y.push(U)})})}}let d=i.filter(f=>!s.has(f.name)).sort((f,y)=>f.declarationOrder-y.declarationOrder);if(d.length>0){let f=-1;s.forEach(k=>f=Math.max(f,k.row));let y=f+1,g=Math.ceil(Math.sqrt(d.length));d.forEach((k,u)=>{s.set(k.name,{row:y+Math.floor(u/g),col:u%g})})}let p=new Set;i.filter(f=>f.positionHint).forEach(f=>{p.add(f.name),p.add(f.positionHint.reference)}),i.forEach(f=>{if(p.has(f.name))return;let y=h.filter(g=>g.from===f.name&&g.direction==="down");if(y.length>0){let g=s.get(f.name);if(g){let k=y.map(u=>s.get(u.to)?.col).filter(u=>u!==void 0);if(k.length>0){let u=k.reduce((S,v)=>S+v,0)/k.length;g.col=Math.round(u)}}}}),(()=>{let f=1/0,y=1/0;s.forEach(u=>{f=Math.min(f,u.row),y=Math.min(y,u.col)}),s.forEach(u=>{u.row-=f,u.col-=y});let g=Array.from(s.keys()).sort((u,S)=>{let v=s.get(u),T=s.get(S);return v.row-T.row||v.col-T.col}),k=new Set;g.forEach(u=>{let S=s.get(u),v=`${S.row},${S.col}`;for(;k.has(v);)S.col++,v=`${S.row},${S.col}`;k.add(v)})})();let w=0,m=0;s.forEach(f=>{w=Math.max(w,f.row),m=Math.max(m,f.col)});let x=new Array(m+1).fill(0),b=new Array(w+1).fill(0);s.forEach((f,y)=>{let g=n.get(y);x[f.col]=Math.max(x[f.col],g.width),b[f.row]=Math.max(b[f.row],g.height)});let L=[t];for(let f=1;f<=m;f++)L[f]=L[f-1]+x[f-1]+this.theme.componentGapX;let R=[e];for(let f=1;f<=w;f++)R[f]=R[f-1]+b[f-1]+this.theme.componentGapY;console.log("--- Grid Layout Details ---"),console.log("Col Widths:",x),console.log("Col Starts:",L),console.log("Row Heights:",b),console.log("Row Starts:",R),i.forEach(f=>{let y=s.get(f.name),g=n.get(f.name),k=L[y.col],u=R[y.row],S=x[y.col],v=b[y.row],T=k+(S-g.width)/2,H=u+(v-g.height)/2;this.layoutMap.set(f.name,{x:T,y:H,width:g.width,height:g.height}),this.gridCells.set(f.name,{x:k,w:S})}),i.forEach(f=>{let y=n.get(f.name),g=this.layoutMap.get(f.name),k=g.x,u=g.y,S=this.diagram.components.filter(H=>H.parentId===f.name),v=S.filter(H=>H.type!=="port"&&H.type!=="portin"&&H.type!=="portout");v.length>0&&this.shiftChildren(v,k+this.theme.packagePadding,u+30+this.theme.packagePadding);let T=S.filter(H=>H.type==="port"||H.type==="portin"||H.type==="portout");T.length>0&&this.layoutPorts(f,T,k,u,y.width,y.height)});let A=L[m]+x[m]-t,M=R[w]+b[w]-e;return{x:t,y:e,width:A,height:M}}shiftChildren(i,t,e){i.forEach(n=>{let o=this.layoutMap.get(n.name);if(o){o.x+=t,o.y+=e,this.layoutMap.set(n.name,o);let s=this.gridCells.get(n.name);s&&(s.x+=t,this.gridCells.set(n.name,s));let a=this.diagram.components.filter(c=>c.parentId===n.name);a.length>0&&this.shiftChildren(a,t,e)}})}getAllDescendants(i){let t=[];return this.diagram.components.filter(n=>n.parentId===i).forEach(n=>{t.push(n.name),t.push(...this.getAllDescendants(n.name))}),t}routeRelationship(i){let t=this.layoutMap.get(i.from);t||(t=this.noteLayoutMap.get(i.from));let e=this.layoutMap.get(i.to);if(e||(e=this.noteLayoutMap.get(i.to)),!t||!e)return{relationship:i,path:[]};let n=this.diagram.components.find(d=>d.name===i.from),o=this.diagram.components.find(d=>d.name===i.to),s={x:t.x+t.width/2,y:t.y+t.height/2},a={x:e.x+e.width/2,y:e.y+e.height/2},c=n?.type==="interface"?this.theme.interfaceRadius:0,r=o?.type==="interface"?this.theme.interfaceRadius:0,h=this.getIntersection(s,a,t,c,n?.type==="interface"),l=this.getIntersection(a,s,e,r,o?.type==="interface");return{relationship:i,path:[h,l],labelPosition:{x:(h.x+l.x)/2,y:(h.y+l.y)/2-10}}}getIntersection(i,t,e,n=0,o=!1){let s=t.x-i.x,a=t.y-i.y,c=Math.sqrt(s*s+a*a);if(c===0)return i;if(o){let $=n/c;return{x:i.x+s*$,y:i.y+a*$}}let r=e.width/2+n,h=e.height/2+n,l=Math.abs(s),d=Math.abs(a),p=1;return l*h>d*r?p=r/l:p=h/d,{x:i.x+s*p,y:i.y+a*p}}layoutNotes(i){let t=[],e=0;return i.forEach(n=>e=Math.max(e,n.y+n.height)),e+=50,this.diagram.notes.forEach((n,o)=>{let s=n.text.split(`
`),a=Math.max(100,Math.max(...s.map(p=>p.length*8))+20),c=s.length*20+20,r=0,h=e+o*60;if(n.linkedTo){let p=i.find($=>$.component.name===n.linkedTo);p&&(n.position==="right"?(r=p.x+p.width+30,h=p.y+(p.height-c)/2):n.position==="left"?(r=p.x-a-30,h=p.y+(p.height-c)/2):n.position==="top"?(r=p.x+(p.width-a)/2,h=p.y-c-30):n.position==="bottom"?(r=p.x+(p.width-a)/2,h=p.y+p.height+30):(r=p.x+p.width+30,h=p.y+(p.height-c)/2))}let l={note:n,x:r,y:h,width:a,height:c};t.push(l);let d=n.alias||n.id;this.noteLayoutMap.set(d,{x:r,y:h,width:a,height:c})}),t}layoutPorts(i,t,e,n,o,s){let a={top:[],bottom:[],left:[],right:[]};t.forEach(l=>{let d=this.diagram.relationships.filter(M=>M.from===l.name||M.to===l.name);if(d.length===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let p=0,$=0,w=0;if(d.forEach(M=>{let f=M.from===l.name?M.to:M.from,y=this.layoutMap.get(f);y&&(p+=y.x+y.width/2,$+=y.y+y.height/2,w++)}),w===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let m=p/w,x=$/w,b=e+o/2,L=n+s/2,R=m-b,A=x-L;Math.abs(R)>=Math.abs(A)?R>0?a.right.push(l):a.left.push(l):A>0?a.bottom.push(l):a.top.push(l)});let c=10,r=c/2,h=(l,d)=>{if(l.length===0)return;let p=l.length,m=(d==="left"||d==="right"?s:o)/(p+1);l.forEach((x,b)=>{let L=0,R=0;d==="left"?(L=e-r,R=n+m*(b+1)-r):d==="right"?(L=e+o-r,R=n+m*(b+1)-r):d==="top"?(L=e+m*(b+1)-r,R=n-r):d==="bottom"&&(L=e+m*(b+1)-r,R=n+s-r),this.layoutMap.set(x.name,{x:L,y:R,width:c,height:c})})};h(a.left,"left"),h(a.right,"right"),h(a.top,"top"),h(a.bottom,"bottom")}};var $t={padding:20,componentWidth:120,componentHeight:50,interfaceRadius:10,componentGapX:80,componentGapY:60,fontSize:13,packagePadding:20,colors:{defaultStroke:"#5a6270",defaultFill:"#e8edf3",interfaceFill:"#ffffff",noteFill:"#fff9c4",noteStroke:"#e0d86e",line:"#5a6270",text:"#2c3e50",textLight:"#7f8c9b",packageFill:"#ebf0f7",packageStroke:"#7b8fa8",nodeFill:"#ebf0f7",folderFill:"#ebf0f7",frameFill:"#ebf0f7",cloudFill:"#ebf0f7",databaseFill:"#ebf0f7",componentIcon:"#7b8fa8"},fontFamily:"'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};var lt=class{constructor(){this.theme=$t}render(i){if(i.type!=="component")throw new Error("ComponentSVGRenderer only supports component diagrams");let t=i;this.layoutEngine=new ct(t,this.theme);let e=this.layoutEngine.calculateLayout(),n=Math.max(e.width,100),o=Math.max(e.height,100),s=`<svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${o}" viewBox="0 0 ${n} ${o}">`;return s+=`<defs>
            <marker id="comp-arrow-end" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polygon points="0,0 10,3.5 0,7" fill="${this.theme.colors.line}" />
            </marker>
            <marker id="comp-arrow-open" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polyline points="0,0 10,3.5 0,7" fill="none" stroke="${this.theme.colors.line}" stroke-width="1.5" />
            </marker>
            <filter id="comp-shadow" x="-4%" y="-4%" width="112%" height="112%">
                <feDropShadow dx="1" dy="1" stdDeviation="2" flood-color="#00000020" />
            </filter>
        </defs>`,[...e.components].sort((c,r)=>{let h=l=>{let d=0,p=l.component.parentId;for(;p;)d++,p=t.components.find($=>$.name===p)?.parentId;return d};return h(c)-h(r)}).forEach(c=>{s+=this.renderComponentNode(c,t,e)}),e.notes.forEach(c=>{s+=this.renderNote(c)}),e.relationships.forEach(c=>{s+=this.renderRelationship(c,t)}),s+="</svg>",s}renderComponentNode(i,t,e){let{component:n}=i;switch(n.type){case"interface":return this.renderInterface(i);case"package":return this.renderPackage(i);case"node":return this.renderNode(i);case"folder":return this.renderFolder(i);case"frame":return this.renderFrame(i);case"cloud":return this.renderCloud(i);case"database":return this.renderDatabase(i);case"port":case"portin":case"portout":return this.renderPort(i,t,e);default:return this.renderComponent(i,t)}}renderComponent(i,t){let{x:e,y:n,width:o,height:s,component:a}=i,c=a.color||this.theme.colors.defaultFill,r=this.theme.colors.defaultStroke,l=(a.label||a.name).split(/\\n|\n/),d=14,p=18,$=6,w=6,m=8,x=5,b=t.components.some(M=>M.parentId===a.name),L=e+o/2,R=n+s/2,A="middle";return b&&(R=n+20),`
            <g filter="url(#comp-shadow)">
                <rect x="${e}" y="${n}" width="${o}" height="${s}" fill="${c}" stroke="${r}" stroke-width="1.5" rx="3" ry="3" />
                <!-- SysML Component Icon: rectangle with two tabs -->
                <rect x="${e+$}" y="${n+w}" width="${d}" height="${p}" fill="none" stroke="${this.theme.colors.componentIcon}" stroke-width="1.2" rx="1" />
                <rect x="${e+$-m/2}" y="${n+w+3}" width="${m}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <rect x="${e+$-m/2}" y="${n+w+10}" width="${m}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <text x="${L}" y="${R}" text-anchor="${A}" dominant-baseline="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${l.map((M,f)=>`<tspan x="${L}" dy="${f===0?b?0:-((l.length-1)*.6)+"em":"1.2em"}">${this.escapeXml(M)}</tspan>`).join("")}
                </text>
            </g>
        `}renderInterface(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=this.theme.interfaceRadius,c=t+n/2,r=e+o/2,l=(s.label||s.name).split(/\\n|\n/);return`
            <g>
                <circle cx="${c}" cy="${r}" r="${a}" fill="${this.theme.colors.interfaceFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5"/>
                <text x="${c}" y="${r+a+16}" text-anchor="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${l.map((d,p)=>`<tspan x="${c}" dy="${p===0?0:"1.2em"}">${this.escapeXml(d)}</tspan>`).join("")}
                </text>
            </g>
        `}renderPackage(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=22,r=a.length*8+20,h=Math.min(Math.max(r,60),n*.6);return`
            <g filter="url(#comp-shadow)">
                <!-- Package tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+h-5},${e} L${t+h},${e+c}" fill="${this.theme.colors.packageFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Package body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.packageFill}" fill-opacity="0.25" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" rx="1" />
                <!-- Label in tab -->
                <text x="${t+10}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderNode(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=10;return`
            <g filter="url(#comp-shadow)">
                <!-- Top face -->
                <polygon points="${t},${e+c} ${t+c},${e} ${t+n+c},${e} ${t+n},${e+c}" fill="${this.theme.colors.nodeFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Right face -->
                <polygon points="${t+n},${e+c} ${t+n+c},${e} ${t+n+c},${e+o} ${t+n},${e+o+c}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.7" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Front face -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    \xABnode\xBB ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFolder(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=16,r=Math.min(60,n*.35);return`
            <g filter="url(#comp-shadow)">
                <!-- Folder tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+r-8},${e} L${t+r},${e+c}" fill="${this.theme.colors.folderFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <!-- Folder body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.folderFill}" fill-opacity="0.3" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" rx="1" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFrame(i){let{x:t,y:e,width:n,height:o,component:s}=i,c=(s.label||s.name).split(/\\n|\n/),r=Math.max(...c.map(d=>d.length)),h=Math.min(r*8+24,n*.6),l=22+(c.length-1)*14;return`
            <g filter="url(#comp-shadow)">
                <!-- Frame body -->
                <rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${this.theme.colors.frameFill}" fill-opacity="0.25" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5" rx="2" />
                <!-- Pentagon name tag -->
                <polygon points="${t},${e} ${t+h},${e} ${t+h},${e+l-6} ${t+h-6},${e+l} ${t},${e+l}" fill="${this.theme.colors.frameFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <text x="${t+8}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${c.map((d,p)=>`<tspan x="${t+8}" dy="${p===0?0:"1.2em"}">${this.escapeXml(d)}</tspan>`).join("")}
                </text>
            </g>
        `}renderCloud(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=a.split(/\\n|\n/),r=n/2,h=o/2,l=n,d=o;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <path d="
                    M${l*.25},${d*.7}
                    C${l*.02},${d*.7} ${l*0},${d*.45} ${l*.15},${d*.35}
                    C${l*.1},${d*.15} ${l*.3},${d*.05} ${l*.45},${d*.2}
                    C${l*.5},${d*.05} ${l*.75},${d*.05} ${l*.78},${d*.25}
                    C${l*1},${d*.2} ${l*1.02},${d*.5} ${l*.85},${d*.6}
                    C${l*.95},${d*.75} ${l*.85},${d*.85} ${l*.7},${d*.78}
                    C${l*.6},${d*.9} ${l*.4},${d*.9} ${l*.25},${d*.7}
                    Z
                " fill="${this.theme.colors.cloudFill}" fill-opacity="0.5" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${r}" y="${h}" text-anchor="middle" dominant-baseline="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((p,$)=>`<tspan x="${r}" dy="${$===0?-((c.length-1)*.6)+"em":"1.2em"}">${this.escapeXml(p)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderDatabase(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=a.split(/\\n|\n/),r=12;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <!-- Cylinder body -->
                <rect x="0" y="${r}" width="${n}" height="${o-r*2}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="none" />
                <!-- Side lines -->
                <line x1="0" y1="${r}" x2="0" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <line x1="${n}" y1="${r}" x2="${n}" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Bottom ellipse -->
                <ellipse cx="${n/2}" cy="${o-r}" rx="${n/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Top ellipse (drawn last to overlay body) -->
                <ellipse cx="${n/2}" cy="${r}" rx="${n/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${n/2}" y="${r+20}" text-anchor="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((h,l)=>`<tspan x="${n/2}" dy="${l===0?0:"1.2em"}">${this.escapeXml(h)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderRelationship(i,t){let{path:e,relationship:n}=i;if(e.length<2)return"";let o=e[0],s=e[e.length-1],a=n.type==="dashed"?"6,4":n.type==="dotted"?"2,3":"none",c="";n.showArrowHead!==!1&&(c=n.type==="dashed"?"url(#comp-arrow-open)":"url(#comp-arrow-end)");let r="";return i.labelPosition&&n.label&&(r=`
                <rect x="${i.labelPosition.x-n.label.length*3.5-4}" y="${i.labelPosition.y-10}" width="${n.label.length*7+8}" height="16" fill="white" fill-opacity="0.85" rx="3" />
                <text x="${i.labelPosition.x}" y="${i.labelPosition.y}" text-anchor="middle" dominant-baseline="middle" fill="${this.theme.colors.textLight}" font-family="${this.theme.fontFamily}" font-size="11" font-style="italic">
                    ${this.escapeXml(n.label)}
                </text>
            `),`
            <g>
                <line x1="${o.x}" y1="${o.y}" x2="${s.x}" y2="${s.y}" stroke="${this.theme.colors.line}" stroke-width="1.3" stroke-dasharray="${a}" marker-end="${c}"/>
                ${r}
            </g>
        `}renderNote(i){let{x:t,y:e,width:n,height:o,note:s}=i,a=12;return`
            <g transform="translate(${t}, ${e})">
                <path d="M0,0 L${n-a},0 L${n},${a} L${n},${o} L0,${o} Z" fill="${this.theme.colors.noteFill}" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <path d="M${n-a},0 L${n-a},${a} L${n},${a}" fill="none" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <text x="10" y="18" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${s.text.split(`
`).map((c,r)=>`<tspan x="10" dy="${r===0?0:"1.3em"}">${this.escapeXml(c)}</tspan>`).join("")}
                </text>
            </g>
        `}escapeXml(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}renderPort(i,t,e){let{x:n,y:o,width:s,height:a,component:c}=i,r=this.theme.colors.line,h="";if(c.parentId){let l=e.components.find(d=>d.component.name===c.parentId);if(l){let d=n+s/2,p=o+a/2,$=l.x+l.width/2,w=l.y+l.height/2,m=d-$,x=p-w,b=0,L=0,R="middle",A="middle",M=10;Math.abs(m)>=Math.abs(x)?m>0?(b=n+s+M/2,L=p,R="start"):(b=n-M/2,L=p,R="end"):x>0?(b=d,L=o+a+M,A="hanging"):(b=d,L=o-M/2,A="auto");let f=c.label||c.name;h=`<text x="${b}" y="${L}" text-anchor="${R}" dominant-baseline="${A}" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-2}">${this.escapeXml(f)}</text>`}}return`
            <g>
                <rect x="${n}" y="${o}" width="${s}" height="${a}" fill="${r}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />
                ${h}
            </g>
        `}};function Q(z){let i=new it,t=new st;try{let e=i.parse(z);return t.render(e)}catch(e){return xt(e)}}function ht(z){let i=new at,t=new lt;try{let e=i.parse(z);return t.render(e)}catch(e){return xt(e)}}function xt(z){let t=(z.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=800,n=100;return`
        <svg width="${e}" height="${n}" viewBox="0 0 ${e} ${n}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
            <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
            <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${t}</text>
        </svg>
    `.trim()}function ut(z){let i=/\b(participant|actor|boundary|control|entity|collections|queue)\b/.test(z),t=/\b(component|package|node|cloud|database|frame|folder)\b/.test(z),e=/^\s*\[[^\]]+\]/m.test(z),n=t||e,o=i;return o&&!n?Q(z):n&&!o?ht(z):/\b(alt|else|loop|group|note|opt|par|break|critical|ref)\b/.test(z)?Q(z):e?ht(z):Q(z)}function dt(z="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(z).forEach(t=>{let e=t.textContent||"",n=ut(e),o=document.createElement("div");o.className="seeduml-diagram",o.innerHTML=n,o.style.display="inline-block",t.parentNode?.replaceChild(o,t)})}function yt(z={}){let{startOnLoad:i=!0,selector:t="pre.seeduml"}=z;i&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{dt(t)}):dt(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:Q,renderComponentDiagram:ht,render:ut,renderAll:dt,initialize:yt});var Qt={renderSequenceDiagram:Q,renderComponentDiagram:ht,render:ut,renderAll:dt,initialize:yt};export{Qt as default,yt as initialize,ut as render,dt as renderAll,ht as renderComponentDiagram,Q as renderSequenceDiagram};
