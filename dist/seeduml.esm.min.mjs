var Q=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumber=0;this.autoactivateEnabled=!1}setHideFootbox(r){this.hideFootbox=r}addParticipant(r,t,e="participant",n,i,a){let o=this.participants.find(c=>c.name===r);o?(t&&(o.label=t),e!=="participant"&&(o.type=e),n!==void 0&&(o.order=n),i&&(o.color=i),a&&(o.stereotype=a)):(o={name:r,label:t,type:e,order:n,color:i,stereotype:a},this.participants.push(o)),this.groupStack.forEach(c=>{c.participants.includes(r)||c.participants.push(r)})}addMessage(r,t,e,n="arrow",i="default",a,o,c="none"){let s=this.currentStep++;this.addParticipant(r),this.addParticipant(t);let l;return this.autonumberConfig&&(l=this.currentAutonumber.toString(),this.currentAutonumber+=this.autonumberConfig.increment),this.messages.push({from:r,to:t,text:e,type:n,step:s,arrowHead:i,startHead:c,color:a,bidirectional:o,number:l}),this.autoactivateEnabled&&r!==t&&n==="arrow"&&this.activate(t,s,s),s}setAutonumber(r=1,t=1,e){this.autonumberConfig={start:r,increment:t,format:e},this.currentAutonumber=r}setAutoactivate(r){this.autoactivateEnabled=r}destroy(r,t){let e=this.participants.find(n=>n.name===r);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(r,e.destroyedStep))}create(r,t){let e=this.participants.find(n=>n.name===r);e&&(e.createdStep=t)}addDivider(r){this.dividers.push({label:r,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(r){this.delays.push({text:r,step:this.currentStep++})}addSpacing(r=30){this.spacings.push({height:r,step:this.currentStep++})}setTitle(r){this.title=r}setHeader(r){this.header=r}setFooter(r){this.footer=r}returnMessage(r){let t=[...this.activations].reverse().find(a=>a.endStep===void 0);if(!t)return;let e=t.participantName,n=e;if(t.sourceStep!==void 0){let a=this.messages.find(o=>o.step===t.sourceStep);a&&(n=a.from)}let i=this.addMessage(e,n,r,"dotted","open");this.deactivate(e,i)}addNote(r,t,e,n,i="folder",a){let o=a!==void 0?a:this.currentStep++,c=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0;return this.notes.push({text:r,position:t,participants:e,step:o,color:n,shape:i,owner:c}),o}activate(r,t=this.currentStep,e,n){this.addParticipant(r);let i=this.activations.filter(a=>a.participantName===r&&a.endStep===void 0).length;this.activations.push({participantName:r,startStep:t,level:i,sourceStep:e,color:n})}deactivate(r,t=this.currentStep,e){this.addParticipant(r);let n=[...this.activations].reverse().find(i=>i.participantName===r&&i.endStep===void 0);n&&(n.endStep=t,n.endSourceStep=e)}startGroup(r,t){let e=this.nextStep(),n={type:r,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(n),this.groupStack.push(n),n}addGroupSection(r){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:r,startStep:this.nextStep()})}endGroup(){let r=this.groupStack.pop();r&&(r.endStep=this.nextStep())}addReference(r,t){let e=this.nextStep(),n=this.nextStep();this.references.push({participants:r,label:t,startStep:e,endStep:n})}addTaggedStep(r,t){this.taggedSteps.set(r,t)}addTimeConstraint(r,t,e){this.timeConstraints.push({startTag:r,endTag:t,label:e})}};var V=class{parse(r){let t=new Q,e=r.split(`
`),n=null,i=null,a=-1,o="",c="",s="",l=new Map;for(let f=0;f<e.length;f++){let h=e[f],d=h;if(h=h.trim(),!h||h.startsWith("@")||h.startsWith("!pragma"))continue;if(i){let y=h.toLowerCase();if(y.startsWith("end note")||(y==="end hnote"||y==="endhnote")||(y==="end rnote"||y==="endrnote")||(y==="end bnote"||y==="endbnote")){let v=i.position.toLowerCase(),F;if(i.participants.length===0&&(v==="right"||v==="left")&&o&&c){let W=t.participants.findIndex(q=>q.name===o),A=t.participants.findIndex(q=>q.name===c);if(W!==-1&&A!==-1){let q=t.participants[W],B=t.participants[A],X=W<A;q.order!==void 0&&B.order!==void 0&&(X=q.order<B.order),v==="left"?i.participants=[X?o:c]:i.participants=[X?c:o]}else i.participants=[c];a!==-1&&(F=a)}let H=i.text.join(`
`).replace(/\\n/g,`
`);t.addNote(H,i.position,i.participants,i.color,i.shape,F),i=null}else i.text.push(d);continue}if(n){h.toLowerCase().startsWith("end ref")?(t.addReference(n.participants,n.label.join(`
`)),n=null):n.label.push(d);continue}if(h.startsWith("'"))continue;let m=!1;h.startsWith("/")&&(m=!0,h=h.substring(1).trim(),t.rewindStep());let u=h.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if(u){let[,y,x]=u;t.addParticipant(x,y),t.create(x,t.getCurrentStep());continue}let p=h.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(p){let[,y,x,C]=p,M=x.replace(/^"(.*)"$/,"$1");if(C&&C.startsWith("#")){let v=C.substring(1);/^[0-9A-Fa-f]+$/.test(v)&&[3,4,6,8].includes(v.length)||(C=v)}let Y=y.toLowerCase();if(Y==="activate")if(M===c&&a!==-1)t.activate(M,a,a,C),l.set(M,a);else{let v=t.nextStep();t.activate(M,v,void 0,C),l.set(M,v)}else if(Y==="deactivate"){let v=!1;a!==-1&&a>(l.get(M)??-1)&&(s==="arrow"?v=M===c||M===o:s==="dotted"&&(v=M===o)),v?t.deactivate(M,a):t.deactivate(M,t.nextStep())}else if(Y==="destroy"){let v=!1;a!==-1&&a>(l.get(M)??-1)&&(s==="arrow"?v=M===c||M===o:s==="dotted"&&(v=M===o)),v?t.destroy(M,a):t.destroy(M,t.nextStep())}continue}let g=h.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(g){let[,y,x,C]=g;t.addTimeConstraint(y,x,C||"");continue}let $=h.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if($){let[,y]=$;t.addDelay(y||void 0);continue}let k=h.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(k){let[,y,x,C,M,Y,v,F,H,W,A,q]=k;q=q||"";let B=M+(v||"");if(B.length>0){x&&(x=x.replace(/^"(.*)"$/,"$1")),H&&(H=H.replace(/^"(.*)"$/,"$1")),(!x||x==="[")&&(x="["),(!H||H==="]")&&(H="]");let X=B.includes("..")||B.includes("--"),Z=C.includes("<")&&(F||"").includes(">"),j=(z,ot)=>z?z===">"||z==="<"?"default":z===">>"||z==="<<"?"open":z==="\\"||z==="/"?"half":z==="\\\\"||z==="//"?"open":z.includes("x")?"lost":z.includes("o")?"arrow-circle":"default":"none",U=j(F||"",!1),J=j(C||"",!0);F==="x"&&(U="lost"),x==="x"&&(J="found");let ht=q.replace(/\\n/g,`
`),T=t.addMessage(x,H,ht,X?"dotted":"arrow",U,Y,Z,J);y&&t.addTaggedStep(y,T);let rt=x,st=H,K=z=>["default","open","half","arrow-circle"].includes(z);if(K(J)&&!K(U)?(rt=H,st=x):K(U)&&!K(J)&&(rt=x,st=H),a=T,o=rt,c=st,s=X?"dotted":"arrow",W==="++"){if(A&&A.startsWith("#")){let z=A.substring(1);/^[0-9A-Fa-f]+$/.test(z)&&[3,4,6,8].includes(z.length)||(A=z)}t.activate(H,T,T,A),l.set(H,T)}else if(W==="--")t.deactivate(x,T,T);else if(W==="--++"){if(t.deactivate(x,T,T),A&&A.startsWith("#")){let z=A.substring(1);/^[0-9A-Fa-f]+$/.test(z)&&[3,4,6,8].includes(z.length)||(A=z)}t.activate(H,T,T,A),l.set(H,T)}else if(W==="++--"){if(A&&A.startsWith("#")){let z=A.substring(1);/^[0-9A-Fa-f]+$/.test(z)&&[3,4,6,8].includes(z.length)||(A=z)}t.activate(x,T,T,A),l.set(x,T),t.deactivate(H,T,T)}else W==="**"?t.create(H,T):W==="!!"&&t.destroy(H,T);continue}}let D=h.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if(D){let[,y,x,C,M,Y]=D,v=[];C&&C.trim()&&(v=C.split(",").map(H=>H.trim().replace(/^"(.*)"$/,"$1")));let F="folder";if(y==="h"?F="hexagon":y==="r"?F="rectangle":y==="b"&&(F="bubble"),Y!==void 0){let H=x.toLowerCase(),W;if(v.length===0&&(H==="right"||H==="left")&&o&&c){let q=t.participants.findIndex(X=>X.name===o),B=t.participants.findIndex(X=>X.name===c);if(q!==-1&&B!==-1){let X=t.participants[q],Z=t.participants[B],j=q<B;X.order!==void 0&&Z.order!==void 0&&(j=X.order<Z.order),H==="left"?v=[j?o:c]:v=[j?c:o]}else v=[c];a!==-1&&(W=a)}let A=Y.replace(/\\n/g,`
`);t.addNote(A,x.toLowerCase(),v,M,F,W)}else i={text:[],position:x.toLowerCase(),participants:v,color:M,shape:F};continue}let E=h.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(E){let[,y,x]=E;t.startGroup(y.toLowerCase(),x||"");continue}let b=h.match(/^else(?:\s+(.*))?$/i);if(b){let[,y]=b;t.addGroupSection(y||"");continue}if(h.toLowerCase().startsWith("end")){t.endGroup();continue}let L=h.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(L){let[,y,x]=L,C=y.split(",").map(M=>M.trim().replace(/^"(.*)"$/,"$1"));x?t.addReference(C,x):n={participants:C,label:[]};continue}let w=h.match(/^return(?:\s+(.*))?$/i);if(w){let[,y]=w,x=(y||"").replace(/\\n/g,`
`);t.returnMessage(x);continue}let S=h.match(/^autonumber(?:\s+(\d+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(S){let[,y,x,C]=S;t.setAutonumber(y?parseInt(y,10):1,x?parseInt(x,10):1,C);continue}let R=h.match(/^autoactivate\s+(on|off)$/i);if(R){t.setAutoactivate(R[1].toLowerCase()==="on");continue}let N=h.match(/^==\s*(.*?)\s*==$/);if(N){t.addDivider(N[1]);continue}if(h==="|||"){t.addSpacing();continue}let I=h.match(/^\|\|(\d+)\|\|$/);if(I){t.addSpacing(parseInt(I[1],10));continue}let P=h.match(/^(title|header|footer)\s+(.*)$/i);if(P){let[,y,x]=P;y.toLowerCase()==="title"?t.setTitle(x):y.toLowerCase()==="header"?t.setHeader(x):y.toLowerCase()==="footer"&&t.setFooter(x);continue}if(h.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let _="(participant|actor|boundary|control|entity|database|collections|queue)",G=new RegExp(`^${_}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),nt=h.match(G);if(nt){let[,y,x,C,M,Y,v,F]=nt;if(!y||!x)continue;let H=C||Y,W,A;M?M.startsWith('"')?(W=x.replace(/^"(.*)"$/,"$1"),A=M.replace(/^"(.*)"$/,"$1")):(W=M.replace(/^"(.*)"$/,"$1"),A=x.replace(/^"(.*)"$/,"$1")):(W=x.replace(/^"(.*)"$/,"$1"),A=void 0);let q=v?parseInt(v,10):void 0;t.addParticipant(W,A,y.toLowerCase(),q,F,H);continue}if(d.trim()!==""&&!d.trim().startsWith("'"))throw new Error(`Syntax error at line ${f+1}: ${h}`)}return t}};var ct={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var tt=class{constructor(r){this.theme=r}calculateLayout(r){let t=[...r.participants].sort((E,b)=>E.order!==void 0&&b.order!==void 0?E.order-b.order:E.order!==void 0?-1:b.order!==void 0?1:0),e=this.calculateMaxStep(r);this.finalizeEndSteps(r,e);let n=this.calculateStepHeights(r,e),i=n.stepY,a=n.totalHeight,o=t.map(E=>this.calculateParticipantWidth(E)),c=this.calculateGaps(r,t,o),s=this.calculateRelativepCenterXs(t,o,c),l=this.preCalculateNoteLayouts(r,t,s,o,i),f=this.calculateBounds(t,s,o,l,r.messages),h=this.theme.padding-f.minX,d=f.maxX-f.minX+this.theme.padding*2,m=d;if(r.timeConstraints.length>0){let b=50+Math.max(...r.timeConstraints.map(L=>L.label.length),0)*8;m+=b}let u=r.hideFootbox?0:this.theme.participantHeight+20,p=a+u+this.theme.padding,g=t.map((E,b)=>{let L=s[b]+h;return{participant:E,centerX:L,x:L-o[b]/2,y:E.createdStep!==void 0?i[E.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:o[b],height:this.theme.participantHeight,destroyedY:E.destroyedStep!==void 0?i[E.destroyedStep]:void 0}}),$=[];l.forEach((E,b)=>{let L=E.x+h,w=E.width;b.position==="across"&&(L=this.theme.padding,w=Math.max(d-this.theme.padding*2,E.width)),$.push({note:b,x:L,y:E.y,width:w,height:E.height})});let k=this.calculateGroupLayouts(r,g,$,i,e),D=this.calculateActivationLayouts(r,g,i,r.messages);return{width:m,height:p,participants:g,notes:$,dividers:this.calculateDividerLayouts(r,i,m),references:this.calculateReferenceLayouts(r,g,i),messages:this.calculateMessageLayouts(r,g,i,D),groups:k,activations:D,delays:this.calculateDelayLayouts(r,i),timeConstraints:this.calculateTimeConstraintLayouts(r,g,i,d)}}calculateMessageLayouts(r,t,e,n){return r.messages.map(i=>{let a=t.findIndex(d=>d.participant.name===i.from),o=t.findIndex(d=>d.participant.name===i.to),c=e[i.step],s=a!==-1?t[a].centerX:0,l=o!==-1?t[o].centerX:0;if(a!==-1&&o!==-1){let d=n.filter(u=>u.activation.participantName===i.from&&u.activation.startStep<=i.step&&(u.activation.endStep??1/0)>=i.step).sort((u,p)=>p.activation.level-u.activation.level),m=n.filter(u=>u.activation.participantName===i.to&&u.activation.startStep<=i.step&&(u.activation.endStep??1/0)>=i.step).sort((u,p)=>p.activation.level-u.activation.level);a!==o&&(a<o?(d.length>0&&(s=d[0].x+d[0].width),m.length>0&&(l=m[0].x)):(d.length>0&&(s=d[0].x),m.length>0&&(l=m[0].x+m[0].width)))}o!==-1&&t[o].participant.createdStep===i.step&&(l=t[o].x);let f=[{x:s,y:c},{x:l,y:c}],h={x:(s+l)/2,y:c};if(a===o&&a!==-1){let d=n.filter(p=>p.activation.participantName===i.from&&p.activation.startStep<=i.step&&(p.activation.endStep??1/0)>=i.step).sort((p,g)=>g.activation.level-p.activation.level),m=0,u=0;if(d.length>0){let p=d[0];p.activation.startStep===i.step?d.length>1?(m=1,u=0):(m=void 0,u=0):p.activation.endStep===i.step&&(d.length>1?(m=0,u=1):(m=0,u=void 0));let g=m!==void 0&&d.length>m?d[m].x+d[m].width:t[a].centerX,$=u!==void 0&&d.length>u?d[u].x+d[u].width:t[a].centerX,k=40;f[0]={x:g,y:c},f[1]={x:Math.max(g,$)+k,y:c},f.push({x:Math.max(g,$)+k,y:c+25}),f.push({x:$,y:c+25}),h={x:Math.max(g,$)+k+5,y:c+10}}else{let p=t[a].centerX,g=40;f[0]={x:p,y:c},f[1]={x:p+g,y:c},f.push({x:p+g,y:c+25}),f.push({x:p,y:c+25}),h={x:p+g+5,y:c+10}}}return{message:i,y:c,points:f,labelPosition:h,lineStyle:i.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(r,t,e){return r.dividers.map(n=>({y:t[n.step],label:n.label}))}calculateDelayLayouts(r,t){return r.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(r,t,e,n){return r.timeConstraints.map(i=>{let a=r.taggedSteps.get(i.startTag),o=r.taggedSteps.get(i.endTag);return a===void 0||o===void 0?null:{x:n-this.theme.padding+20,startY:e[a],endY:e[o],label:i.label}}).filter(i=>i!==null)}calculateReferenceLayouts(r,t,e){return r.references.map(n=>{let i=n.participants.map(h=>t.findIndex(d=>d.participant.name===h)).filter(h=>h!==-1);if(i.length===0)return null;let a=Math.min(...i),o=Math.max(...i),c=t[a].x,s=t[o].x+t[o].width-c,l=e[n.startStep]-10,f=e[n.endStep]-l;return{reference:n,x:c,y:l,width:s,height:f}}).filter(n=>n!==null)}calculateActivationLayouts(r,t,e,n){return r.activations.map(i=>{let a=t.findIndex(d=>d.participant.name===i.participantName);if(a===-1)return null;let c=t[a].centerX-this.theme.activationWidth/2+i.level*5,s=e[i.startStep];if(i.sourceStep!==void 0){let d=n.find(m=>m.step===i.sourceStep);d&&d.from===i.participantName&&d.to===i.participantName&&(s+=25)}let l=e[i.endStep];if(i.endSourceStep!==void 0){let d=n.find(m=>m.step===i.endSourceStep);d&&d.from===i.participantName&&d.to===i.participantName&&(l+=25)}let h=Math.max(5,l-s);return{activation:i,x:c,y:s,width:this.theme.activationWidth,height:h}}).filter(i=>i!==null)}calculateMaxStep(r){let t=0;return[...r.messages,...r.activations,...r.groups,...r.references,...r.notes,...r.dividers,...r.delays,...r.spacings].forEach(n=>{let i=n.step??n.startStep??n.endStep??0;i>t&&(t=i)}),t+1}finalizeEndSteps(r,t){r.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),r.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(r,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),n=new Array(t+2).fill(0),i=new Array(t+2).fill(0);r.notes.forEach(s=>{let f=s.text.split(`
`).length*20+10;n[s.step]=Math.max(n[s.step],f/2),i[s.step]=Math.max(i[s.step],f/2)}),r.messages.forEach(s=>{let f=s.text.split(`
`).length;if(s.from===s.to){let h=Math.max(25,f*20);n[s.step]=Math.max(n[s.step],0),i[s.step]=Math.max(i[s.step],h+10)}else{let h=f*15+5;n[s.step]=Math.max(n[s.step],h),i[s.step]=Math.max(i[s.step],0)}});let a=new Array(t+1).fill(this.theme.defaultMessageGap);r.dividers.forEach(s=>{a[s.step]=30}),r.delays.forEach(s=>{a[s.step]=40}),r.spacings.forEach(s=>{a[s.step]=s.height}),r.references.forEach(s=>{let f=s.label.split(`
`).length*15+40;s.endStep===s.startStep+1&&(a[s.startStep]=Math.max(a[s.startStep],f))});for(let s=0;s<=t;s++){let l=i[s]+n[s+1]+10;e[s]=Math.max(a[s],l)}let o=new Array(t+1).fill(0),c=this.theme.padding+90;for(let s=0;s<=t;s++)o[s]=c,c+=e[s];return{stepY:o,totalHeight:c}}calculateParticipantWidth(r){let e=(r.label||r.name).replace(/\\n/g,`
`).split(`
`),n=Math.max(...e.map(i=>i.length));return Math.max(this.theme.participantWidth,n*9+30)}calculateGaps(r,t,e){let n=Math.max(0,t.length-1),i=new Array(n).fill(60),a=this.calculateMaxStep(r);for(let o=0;o<=a;o++){let c=new Array(n).fill(0);for(let s=0;s<t.length;s++){let l=t[s].name;if(t[s].createdStep===o){let $=e[s];s<n&&(c[s]=Math.max(c[s],$/2+20))}let h=15,d=r.messages.find($=>$.step===o&&$.from===l&&$.to===l);d&&(h=40+(Math.max(...d.text.split(`
`).map(k=>k.length*8))+20)+10);let m=r.activations.filter($=>$.participantName===l&&$.startStep<=o&&($.endStep??1/0)>=o);if(m.length>0){let $=Math.max(...m.map(k=>k.level));h=Math.max(h,this.theme.activationWidth/2+$*5+10)}r.notes.filter($=>$.step===o&&$.position==="right"&&$.participants?.includes(l)).forEach($=>{let k=Math.max(60,Math.max(...$.text.split(`
`).map(D=>D.length*8.5))+20);h+=k+10}),s<n&&(c[s]+=h);let p=15;r.notes.filter($=>$.step===o&&$.position==="left"&&$.participants?.includes(l)).forEach($=>{let k=Math.max(60,Math.max(...$.text.split(`
`).map(D=>D.length*8.5))+20);p+=k+10}),s>0&&(c[s-1]+=p)}for(let s=0;s<n;s++)i[s]=Math.max(i[s],c[s])}return r.messages.forEach(o=>{let c=t.findIndex(m=>m.name===o.from),s=t.findIndex(m=>m.name===o.to);if(c===-1||s===-1||c===s)return;let l=Math.max(...o.text.split(`
`).map(m=>m.length*8))+20,f=Math.min(c,s),h=Math.max(c,s),d=0;for(let m=f;m<h;m++)d+=e[m]/2+i[m]+e[m+1]/2;if(d<l){let u=(l-d)/(h-f);for(let p=f;p<h;p++)i[p]+=u}}),r.notes.forEach(o=>{if(o.position!=="over"&&o.position!=="across")return;let c=o.text.split(`
`),s=Math.max(60,Math.max(...c.map(l=>l.length*8.5))+20);if(o.participants&&o.participants.length>0){let l=t.findIndex(m=>m.name===o.participants[0]),f=o.participants.length>1?t.findIndex(m=>m.name===o.participants[1]):l;if(l===-1||f===-1)return;let h=Math.min(l,f),d=Math.max(l,f);if(h===d){let m=s/2+10;h<n&&i[h]<m&&(i[h]=m)}else{let m=0;for(let u=h;u<d;u++)m+=e[u]/2+i[u]+e[u+1]/2;if(m<s){let p=(s-m)/(d-h);for(let g=h;g<d;g++)i[g]+=p}}}}),i}calculateRelativepCenterXs(r,t,e){let n=new Array(r.length).fill(0);return r.forEach((i,a)=>{a===0?n[a]=t[a]/2:n[a]=n[a-1]+t[a-1]/2+e[a-1]+t[a]/2}),n}preCalculateNoteLayouts(r,t,e,n,i){let a=new Map,o=new Map;return r.notes.forEach(c=>{let s=c.text.split(`
`),l=Math.max(...s.map(p=>p.length*8.5))+20,h=Math.max(l,60),d=s.length*20+10,m=i[c.step]-d/2,u=0;if(c.position==="across")u=0,a.set(c,{x:u,y:m,width:h,height:d});else if(c.position==="over"){let p=c.participants.map(g=>t.findIndex($=>$.name===g)).filter(g=>g!==-1);if(p.length>0){let g=Math.min(...p),$=Math.max(...p),k=e[$]+n[$]/2-(e[g]-n[g]/2),D=Math.max(k,h);u=e[g]-n[g]/2-(D-k)/2,a.set(c,{x:u,y:m,width:D,height:d})}}else{let p=(c.participants||[]).map(g=>t.findIndex($=>$.name===g)).filter(g=>g!==-1);if(p.length>0){let g=c.position==="left"?Math.min(...p):Math.max(...p),$=e[g],k=`${c.step}-${g}-${c.position}`,D=t[g],E=n[g]/2,L=c.step===D.createdStep?E:0;if(c.position==="left")u=(o.get(k)??$-L-5)-h,o.set(k,u-10);else{let w=r.messages.find(G=>G.step===c.step&&G.from===D.name&&G.to===D.name),S=0;if(w){let G=w.text.split(`
`);S=40+(Math.max(...G.map(y=>y.length*8))+20)}let R=r.activations.filter(G=>G.participantName===D.name&&G.startStep<=c.step&&(G.endStep??1/0)>=c.step),N=R.length>0?Math.max(...R.map(G=>G.level)):0,I=this.theme.activationWidth/2+N*5,P=Math.max(L,I,S);u=o.get(k)??$+P+5,o.set(k,u+h+10)}a.set(c,{x:u,y:m,width:h,height:d})}}}),a}calculateBounds(r,t,e,n,i){let a=0,o=0;return r.forEach((c,s)=>{let l=t[s]-e[s]/2,f=t[s]+e[s]/2;s===0?(a=l,o=f):(l<a&&(a=l),f>o&&(o=f))}),n.forEach(c=>{c.x<a&&(a=c.x),c.x+c.width>o&&(o=c.x+c.width)}),i.forEach(c=>{let s=r.findIndex(d=>d.name===c.from),l=r.findIndex(d=>d.name===c.to);if(s===-1||l===-1)return;let f=c.text.split(`
`),h=Math.max(...f.map(d=>d.length*8))+20;if(s===l){let d=t[s],m=Math.max(...c.text.split(`
`).map(p=>p.length*8))+20,u=d+40+m+10;u>o&&(o=u)}else{let d=t[s],m=t[l],u=(d+m)/2,p=u-h/2,g=u+h/2;p<a&&(a=p),g>o&&(o=g)}}),{minX:a,maxX:o}}calculateGroupLayouts(r,t,e,n,i){let a=r.groups.length>0?Math.max(...r.groups.map(o=>o.level)):0;return r.groups.map(o=>{let c=o.participants.map(b=>t.findIndex(L=>L.participant.name===b)).filter(b=>b!==-1);if(c.length===0)return null;let s=Math.min(...c),l=Math.max(...c),f=a-o.level,h=10+f*10,d=25+f*8,m=5+f*8,u=t[s].x+t[s].width/2-t[s].width/2-h,p=t[s].x-h,g=t[l].x+t[l].width+h-p;e.filter(b=>{let L=b.note;if(L.step<o.startStep||L.step>(o.endStep||i))return!1;let w=L.owner;if(!w)return!1;if(w===o)return!0;let S=w.endStep??i,R=o.endStep??i;return w.startStep>=o.startStep&&S<=R}).forEach(b=>{let L=b.note;if(L.position==="right"){let w=(L.participants||[]).map(S=>t.findIndex(R=>R.participant.name===S)).filter(S=>S!==-1);if(w.length>0&&Math.max(...w)===l){let S=b.x+b.width,R=p+g;S+10>R&&(g=S+10-p)}}else if(L.position==="left"){let w=(L.participants||[]).map(S=>t.findIndex(R=>R.participant.name===S)).filter(S=>S!==-1);if(w.length>0&&Math.min(...w)===s){let S=b.x,R=p;if(S-10<R){let N=R-(S-10);p-=N,g+=N}}}});let k=n[o.startStep]-d,D=n[o.endStep]+m,E=o.sections.map(b=>({label:b.label,y:n[b.startStep]}));return{group:o,x:p,y:k,width:g,height:D-k,type:o.type,label:o.label,sections:E}}).filter(o=>o!==null)}};var et=class{constructor(){this.theme=ct;this.lastSvg="";this.layoutEngine=new tt(this.theme)}render(r){this.ensureParticipants(r);let t=this.layoutEngine.calculateLayout(r);return this.generateSvg(r,t)}ensureParticipants(r){r.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>r.addParticipant(e))})}generateSvg(r,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(r),e+=this.renderLifelines(r,t),e+=this.renderActivations(r,t),e+=this.renderGroups(t),e+=this.renderParticipants(r,t),e+=this.renderReferences(r,t),e+=this.renderNotes(t),e+=this.renderMessages(r,t),e+=this.renderDividers(r,t),e+=this.renderDelays(r,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),r.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${r.title}</text>`),r.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${r.header}</text>`),r.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${r.footer}</text>`),e+="</svg>",e}renderDefs(r){let t=new Set;t.add(this.theme.colors.defaultStroke),r.messages.forEach(n=>{t.add(this.normalizeColor(n.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(n=>{let i=n.replace("#","");e+=`
      <marker id="arrowhead-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-open-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${n}" />
      </marker>
      <marker id="halfhead-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${n}" />
      </marker>
      <marker id="circlehead-${i}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${n}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${i}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
        <circle cx="14" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${i}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${n}" />
        <circle cx="4" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="losthead-${i}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${n}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${n}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(r,t){let e="";return t.participants.forEach(n=>{if(n.participant.name==="["||n.participant.name==="]")return;let i=n.centerX,a=n.destroyedY!==void 0?n.destroyedY:r.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${i}" y1="${n.y+n.height}" x2="${i}" y2="${a}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(r){let t="";return r.participants.forEach(e=>{if(e.destroyedY!==void 0){let n=e.centerX,i=e.destroyedY,a=12;t+=`<line x1="${n-a}" y1="${i-a}" x2="${n+a}" y2="${i+a}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${n+a}" y1="${i-a}" x2="${n-a}" y2="${i+a}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(r,t){let e="",n=(i,a)=>{let o=this.normalizeColor(i.participant.color,this.theme.colors.actorFill),c=i.x,s=a?i.y:t.height-this.theme.padding-this.theme.participantHeight-20,l=i.centerX,f=s+this.theme.participantHeight/2,d=(i.participant.label||i.participant.name).replace(/\\n/g,`
`).split(`
`);switch(i.participant.type){case"actor":e+=`<circle cx="${l}" cy="${s+10}" r="8" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${s+18}" x2="${l}" y2="${s+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-10}" y1="${s+22}" x2="${l+10}" y2="${s+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${s+30}" x2="${l-8}" y2="${s+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${s+30}" x2="${l+8}" y2="${s+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+55+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"boundary":e+=`<line x1="${l-20}" y1="${f}" x2="${l-10}" y2="${f}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-20}" y1="${f-10}" x2="${l-20}" y2="${f+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${l}" cy="${f}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"control":e+=`<circle cx="${l}" cy="${f}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${l+4} ${f-18} L ${l-4} ${f-14} L ${l+4} ${f-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"entity":e+=`<circle cx="${l}" cy="${f}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-14}" y1="${f+14}" x2="${l+14}" y2="${f+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"database":let m=34,u=40,p=s,g=l-m/2;e+=`<path d="M ${g} ${p+10} L ${g} ${p+u-10} A 17 8 0 0 0 ${g+m} ${p+u-10} L ${g+m} ${p+10} A 17 8 0 0 0 ${g} ${p+10} M ${g} ${p+10} A 17 8 0 0 1 ${g+m} ${p+10}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${g} ${p+10} A 17 8 0 0 0 ${g+m} ${p+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"collections":let $=34,k=34,D=s+3,E=l-$/2;e+=`<rect x="${E+4}" y="${D-4}" width="${$}" height="${k}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${E}" y="${D}" width="${$}" height="${k}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;case"queue":let b=40,L=40,w=s+3,S=l-b/2,R=5,N=L/2;e+=`<path d="M ${S+b} ${w} L ${S} ${w} A ${R} ${N} 0 0 0 ${S} ${w+L} L ${S+b} ${w+L} A ${R} ${N} 0 0 0 ${S+b} ${w}" fill="${o}" stroke="none" />`,e+=`<ellipse cx="${S+b}" cy="${w+N}" rx="${R}" ry="${N}" fill="${o}" stroke="none" />`,e+=`<path d="M ${S+b} ${w} L ${S} ${w} A ${R} ${N} 0 0 0 ${S} ${w+L} L ${S+b} ${w+L}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${S+b}" cy="${w+N}" rx="${R}" ry="${N}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{e+=`<text x="${l}" y="${s+this.theme.participantHeight+20+P*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`});break;default:e+=`<rect x="${c}" y="${s}" width="${i.width}" height="${this.theme.participantHeight}" rx="5" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((I,P)=>{let _=d.length>1?f-(d.length-1)*7.5+P*15:f;e+=`<text x="${l}" y="${_}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${I}</text>`})}};return t.participants.forEach(i=>{i.participant.name==="["||i.participant.name==="]"||(n(i,!0),r.hideFootbox||n(i,!1))}),e}renderGroups(r){let t="";return r.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(n=>{let i=n.y;t+=`<line x1="${e.x}" y1="${i}" x2="${e.x+e.width}" y2="${i}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${i+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${n.label}]</text>`})}),t}renderNotes(r){let t="";return r.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(r,t){let e="";return[...t.activations].sort((i,a)=>i.activation.level-a.activation.level).forEach(i=>{let a=i.activation.color||this.theme.colors.actorFill;e+=`<rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(r,t){let e="";return t.references.forEach(n=>{e+=`<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${n.x} ${n.y} L ${n.x+70} ${n.y} L ${n.x+70} ${n.y+10} L ${n.x+60} ${n.y+20} L ${n.x} ${n.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${n.x+5}" y="${n.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let i=n.reference.label.split(`
`),a=this.theme.fontSize+2,o=i.length*a,c=25,s=n.y+n.height/2-o/2+a/2;s<n.y+c+a/2&&(s=n.y+c+a/2),i.forEach((l,f)=>{e+=`<text x="${n.x+n.width/2}" y="${s+f*a}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${l}</text>`})}),e}renderMessages(r,t){let e="";return t.messages.forEach(n=>{let i=n.message,a=this.normalizeColor(i.color,this.theme.colors.defaultStroke),o=n.lineStyle==="dashed"?"4":"0",c=a.replace("#",""),s=(u,p)=>{if(u==="none")return"none";let g="";return u==="default"?g=p?`arrowhead-reverse-${c}`:`arrowhead-${c}`:u==="open"?g=p?`arrowhead-open-reverse-${c}`:`arrowhead-open-${c}`:u==="half"?g=p?`halfhead-reverse-${c}`:`halfhead-${c}`:u==="circle"?g=`circlehead-${c}`:u==="arrow-circle"?g=p?`arrowhead-circle-reverse-${c}`:`arrowhead-circle-${c}`:u==="lost"?g=`losthead-${c}`:u==="found"&&(g=`circlehead-${c}`),g?`url(#${g})`:"none"},l=s(i.arrowHead||"default",!1),f=s(i.startHead||(i.bidirectional?"default":"none"),!0);if(n.points.length>2){let u=`M ${n.points.map(p=>`${p.x} ${p.y}`).join(" L ")}`;e+=`<path d="${u}" fill="none" stroke="${a}" stroke-width="1.5" stroke-dasharray="${o}" marker-end="${l}" marker-start="${f}" />`}else{let[u,p]=n.points;e+=`<line x1="${u.x}" y1="${u.y}" x2="${p.x}" y2="${p.y}" stroke="${a}" stroke-width="1.5" stroke-dasharray="${o}" marker-end="${l}" marker-start="${f}" />`}let d=(i.number?`[${i.number}] ${i.text}`:i.text).split(`
`),m=n.points.length>2?"start":"middle";d.forEach((u,p)=>{let $=n.labelPosition.y-(d.length-1-p)*15-5;n.points.length>2&&($=n.labelPosition.y+p*20),e+=`<text x="${n.labelPosition.x}" y="${$}" text-anchor="${m}" font-size="${this.theme.fontSize-2}" fill="${a}">${u}</text>`})}),e}renderDividers(r,t){let e="";return t.dividers.forEach(n=>{let i=n.y;if(e+=`<line x1="${this.theme.padding}" y1="${i}" x2="${t.width-this.theme.padding}" y2="${i}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${i+4}" x2="${t.width-this.theme.padding}" y2="${i+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,n.label){let a=n.label.length*9+20;e+=`<rect x="${t.width/2-a/2}" y="${i-10}" width="${a}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${i}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${n.label}</text>`}}),e}renderDelays(r,t){let e="";return t.delays.forEach(n=>{let i=n.y,a=t.width/2,o=10,c=5;if(n.text){let s=n.text.length*8+20;e+=`<text x="${a}" y="${i}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${n.text}</text>`;for(let l=0;l<c;l++){let f=a-s/2-10-l*o;e+=`<circle cx="${f}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`}for(let l=0;l<c;l++){let f=a+s/2+10+l*o;e+=`<circle cx="${f}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let s=-10;s<=10;s++)s!==0&&(e+=`<circle cx="${a+s*o}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(r){let t="";return r.timeConstraints.forEach(e=>{let n=e.x,i=e.startY,a=e.endY,o=this.theme.colors.defaultStroke;if(t+=`<line x1="${n}" y1="${i}" x2="${n}" y2="${a}" stroke="${o}" stroke-width="1.5" />`,t+=`<polygon points="${n} ${i}, ${n-4} ${i+8}, ${n+4} ${i+8}" fill="${o}" />`,t+=`<polygon points="${n} ${a}, ${n-4} ${a-8}, ${n+4} ${a-8}" fill="${o}" />`,e.label){let c=(i+a)/2;t+=`<text x="${n+10}" y="${c}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${o}">${e.label}</text>`}}),t}normalizeColor(r,t){return r?r.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(r)?r:r.substring(1):r:t}formatRichText(r){let t=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return t=t.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),t=t.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),t}drawNoteShape(r,t,e,n,i,a,o,c){let s="",l=this.normalizeColor(o,this.theme.colors.noteFill),f=this.theme.colors.defaultStroke,h=a||"folder";if(h==="hexagon"){let u=[`${t+10},${e}`,`${t+n-10},${e}`,`${t+n},${e+i/2}`,`${t+n-10},${e+i}`,`${t+10},${e+i}`,`${t},${e+i/2}`].join(" ");s+=`<polygon points="${u}" fill="${l}" stroke="${f}" stroke-width="1.5" />`}else if(h==="bubble"){let m=i/2;s+=`<rect x="${t}" y="${e}" width="${n}" height="${i}" rx="${m}" ry="${m}" fill="${l}" stroke="${f}" stroke-width="1.5" />`}else if(h==="rectangle")s+=`<rect x="${t}" y="${e}" width="${n}" height="${i}" fill="${l}" stroke="${f}" stroke-width="1.5" />`;else{let u=`
                M ${t} ${e}
                L ${t+n-10} ${e}
                L ${t+n} ${e+10}
                L ${t+n} ${e+i}
                L ${t} ${e+i}
                Z
            `;s+=`<path d="${u}" fill="${l}" stroke="${f}" stroke-width="1.5" />`;let p=`
                M ${t+n-10} ${e}
                L ${t+n-10} ${e+10}
                L ${t+n} ${e+10}
            `;s+=`<path d="${p}" fill="none" stroke="${f}" stroke-width="1.5" />`}c.split(`
`).forEach((m,u)=>{s+=`<text x="${t+n/2}" y="${e+20+u*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText(m)}</text>`}),this.lastSvg=r+s}};function at(O){let r=new V,t=new et;try{let e=r.parse(O);return t.render(e)}catch(e){let i=(e.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a=800,o=100;return`
            <svg width="${a}" height="${o}" viewBox="0 0 ${a} ${o}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
                <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
                <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${i}</text>
            </svg>
        `.trim()}}function it(O="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(O).forEach(t=>{let e=t.textContent||"",n=at(e),i=document.createElement("div");i.className="seeduml-diagram",i.innerHTML=n,i.style.display="inline-block",t.parentNode?.replaceChild(i,t)})}function lt(O={}){let{startOnLoad:r=!0,selector:t="pre.seeduml"}=O;r&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{it(t)}):it(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:at,renderAll:it,initialize:lt});var kt={renderSequenceDiagram:at,renderAll:it,initialize:lt};export{kt as default,lt as initialize,it as renderAll,at as renderSequenceDiagram};
