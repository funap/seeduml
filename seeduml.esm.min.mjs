var Z=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumber=0;this.autoactivateEnabled=!1}setHideFootbox(r){this.hideFootbox=r}addParticipant(r,t,e="participant",n,i,c){let o=this.participants.find(l=>l.name===r);o?(t&&(o.label=t),e!=="participant"&&(o.type=e),n!==void 0&&(o.order=n),i&&(o.color=i),c&&(o.stereotype=c)):(o={name:r,label:t,type:e,order:n,color:i,stereotype:c},this.participants.push(o)),this.groupStack.forEach(l=>{l.participants.includes(r)||l.participants.push(r)})}addMessage(r,t,e,n="arrow",i="default",c,o,l="none"){let s=this.currentStep++;this.addParticipant(r),this.addParticipant(t);let a;return this.autonumberConfig&&(a=this.currentAutonumber.toString(),this.currentAutonumber+=this.autonumberConfig.increment),this.messages.push({from:r,to:t,text:e,type:n,step:s,arrowHead:i,startHead:l,color:c,bidirectional:o,number:a}),this.autoactivateEnabled&&r!==t&&n==="arrow"&&this.activate(t,s,s),s}setAutonumber(r=1,t=1,e){this.autonumberConfig={start:r,increment:t,format:e},this.currentAutonumber=r}setAutoactivate(r){this.autoactivateEnabled=r}destroy(r,t){let e=this.participants.find(n=>n.name===r);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(r,e.destroyedStep))}create(r,t){let e=this.participants.find(n=>n.name===r);e&&(e.createdStep=t)}addDivider(r){this.dividers.push({label:r,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(r){this.delays.push({text:r,step:this.currentStep++})}addSpacing(r=30){this.spacings.push({height:r,step:this.currentStep++})}setTitle(r){this.title=r}setHeader(r){this.header=r}setFooter(r){this.footer=r}returnMessage(r){let t=[...this.activations].reverse().find(c=>c.endStep===void 0);if(!t)return;let e=t.participantName,n=e;if(t.sourceStep!==void 0){let c=this.messages.find(o=>o.step===t.sourceStep);c&&(n=c.from)}let i=this.addMessage(e,n,r,"dotted","open");this.deactivate(e,i)}addNote(r,t,e,n,i="folder",c){let o=c!==void 0?c:this.currentStep++,l=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0;return this.notes.push({text:r,position:t,participants:e,step:o,color:n,shape:i,owner:l}),o}activate(r,t=this.currentStep,e,n){this.addParticipant(r);let i=this.activations.filter(c=>c.participantName===r&&c.endStep===void 0).length;this.activations.push({participantName:r,startStep:t,level:i,sourceStep:e,color:n})}deactivate(r,t=this.currentStep,e){this.addParticipant(r);let n=[...this.activations].reverse().find(i=>i.participantName===r&&i.endStep===void 0);n&&(n.endStep=t,n.endSourceStep=e)}startGroup(r,t){let e=this.nextStep(),n={type:r,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(n),this.groupStack.push(n),n}addGroupSection(r){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:r,startStep:this.nextStep()})}endGroup(){let r=this.groupStack.pop();r&&(r.endStep=this.nextStep())}addReference(r,t){let e=this.nextStep(),n=this.nextStep();this.references.push({participants:r,label:t,startStep:e,endStep:n})}addTaggedStep(r,t){this.taggedSteps.set(r,t)}addTimeConstraint(r,t,e){this.timeConstraints.push({startTag:r,endTag:t,label:e})}};var U=class{parse(r){let t=new Z,e=r.split(`
`),n=null,i=null,c=-1,o="",l="";for(let s=0;s<e.length;s++){let a=e[s],p=a;if(a=a.trim(),!a||a.startsWith("@")||a.startsWith("!pragma"))continue;if(i){let x=a.toLowerCase();if(x.startsWith("end note")||(x==="end hnote"||x==="endhnote")||(x==="end rnote"||x==="endrnote")||(x==="end bnote"||x==="endbnote")){let D=i.position.toLowerCase(),F;if(i.participants.length===0&&(D==="right"||D==="left")&&o&&l){let W=t.participants.findIndex(q=>q.name===o),M=t.participants.findIndex(q=>q.name===l);if(W!==-1&&M!==-1){let q=t.participants[W],Y=t.participants[M],G=W<M;q.order!==void 0&&Y.order!==void 0&&(G=q.order<Y.order),D==="left"?i.participants=[G?o:l]:i.participants=[G?l:o]}else i.participants=[l];c!==-1&&(F=c)}let H=i.text.join(`
`).replace(/\\n/g,`
`);t.addNote(H,i.position,i.participants,i.color,i.shape,F),i=null}else i.text.push(p);continue}if(n){a.toLowerCase().startsWith("end ref")?(t.addReference(n.participants,n.label.join(`
`)),n=null):n.label.push(p);continue}if(a.startsWith("'"))continue;let g=!1;a.startsWith("/")&&(g=!0,a=a.substring(1).trim(),t.rewindStep());let h=a.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if(h){let[,x,y]=h;t.addParticipant(y,x),t.create(y,t.getCurrentStep());continue}let f=a.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(f){let[,x,y,E]=f,P=y.replace(/^"(.*)"$/,"$1");if(E&&E.startsWith("#")){let D=E.substring(1);/^[0-9A-Fa-f]+$/.test(D)&&[3,4,6,8].includes(D.length)||(E=D)}let X=x.toLowerCase();X==="activate"?P===l&&c!==-1?t.activate(P,c,c,E):t.activate(P,void 0,void 0,E):X==="deactivate"?t.deactivate(P):X==="destroy"&&t.destroy(P,t.getCurrentStep());continue}let u=a.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(u){let[,x,y,E]=u;t.addTimeConstraint(x,y,E||"");continue}let d=a.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if(d){let[,x]=d;t.addDelay(x||void 0);continue}let m=a.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(m){let[,x,y,E,P,X,D,F,H,W,M,q]=m;q=q||"";let Y=P+(D||"");if(Y.length>0){y&&(y=y.replace(/^"(.*)"$/,"$1")),H&&(H=H.replace(/^"(.*)"$/,"$1")),(!y||y==="[")&&(y="["),(!H||H==="]")&&(H="]");let G=Y.includes("..")||Y.includes("--"),_=E.includes("<")&&(F||"").includes(">"),O=(C,V)=>C?C===">"||C==="<"?"default":C===">>"||C==="<<"?"open":C==="\\"||C==="/"?"half":C==="\\\\"||C==="//"?"open":C.includes("x")?"lost":C.includes("o")?"arrow-circle":"default":"none",et=O(F||"",!1),it=O(E||"",!0);F==="x"&&(et="lost"),y==="x"&&(it="found");let st=q.replace(/\\n/g,`
`),T=t.addMessage(y,H,st,G?"dotted":"arrow",et,X,_,it);if(x&&t.addTaggedStep(x,T),c=T,o=y,l=H,W==="++"){if(M&&M.startsWith("#")){let C=M.substring(1);/^[0-9A-Fa-f]+$/.test(C)&&[3,4,6,8].includes(C.length)||(M=C)}t.activate(H,T,T,M)}else if(W==="--")t.deactivate(y,T,T);else if(W==="--++"){if(t.deactivate(y,T,T),M&&M.startsWith("#")){let C=M.substring(1);/^[0-9A-Fa-f]+$/.test(C)&&[3,4,6,8].includes(C.length)||(M=C)}t.activate(H,T,T,M)}else if(W==="++--"){if(M&&M.startsWith("#")){let C=M.substring(1);/^[0-9A-Fa-f]+$/.test(C)&&[3,4,6,8].includes(C.length)||(M=C)}t.activate(y,T,T,M),t.deactivate(H,T,T)}else W==="**"?t.create(H,T):W==="!!"&&t.destroy(H,T);continue}}let $=a.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if($){let[,x,y,E,P,X]=$,D=[];E&&E.trim()&&(D=E.split(",").map(H=>H.trim().replace(/^"(.*)"$/,"$1")));let F="folder";if(x==="h"?F="hexagon":x==="r"?F="rectangle":x==="b"&&(F="bubble"),X!==void 0){let H=y.toLowerCase(),W;if(D.length===0&&(H==="right"||H==="left")&&o&&l){let q=t.participants.findIndex(G=>G.name===o),Y=t.participants.findIndex(G=>G.name===l);if(q!==-1&&Y!==-1){let G=t.participants[q],_=t.participants[Y],O=q<Y;G.order!==void 0&&_.order!==void 0&&(O=G.order<_.order),H==="left"?D=[O?o:l]:D=[O?l:o]}else D=[l];c!==-1&&(W=c)}let M=X.replace(/\\n/g,`
`);t.addNote(M,y.toLowerCase(),D,P,F,W)}else i={text:[],position:y.toLowerCase(),participants:D,color:P,shape:F};continue}let v=a.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(v){let[,x,y]=v;t.startGroup(x.toLowerCase(),y||"");continue}let z=a.match(/^else(?:\s+(.*))?$/i);if(z){let[,x]=z;t.addGroupSection(x||"");continue}if(a.toLowerCase().startsWith("end")){t.endGroup();continue}let L=a.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(L){let[,x,y]=L,E=x.split(",").map(P=>P.trim().replace(/^"(.*)"$/,"$1"));y?t.addReference(E,y):n={participants:E,label:[]};continue}let b=a.match(/^return(?:\s+(.*))?$/i);if(b){let[,x]=b,y=(x||"").replace(/\\n/g,`
`);t.returnMessage(y);continue}let k=a.match(/^autonumber(?:\s+(\d+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(k){let[,x,y,E]=k;t.setAutonumber(x?parseInt(x,10):1,y?parseInt(y,10):1,E);continue}let w=a.match(/^autoactivate\s+(on|off)$/i);if(w){t.setAutoactivate(w[1].toLowerCase()==="on");continue}let S=a.match(/^==\s*(.*?)\s*==$/);if(S){t.addDivider(S[1]);continue}if(a==="|||"){t.addSpacing();continue}let A=a.match(/^\|\|(\d+)\|\|$/);if(A){t.addSpacing(parseInt(A[1],10));continue}let N=a.match(/^(title|header|footer)\s+(.*)$/i);if(N){let[,x,y]=N;x.toLowerCase()==="title"?t.setTitle(y):x.toLowerCase()==="header"?t.setHeader(y):x.toLowerCase()==="footer"&&t.setFooter(y);continue}if(a.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let R="(participant|actor|boundary|control|entity|database|collections|queue)",I=new RegExp(`^${R}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),j=a.match(I);if(j){let[,x,y,E,P,X,D,F]=j;if(!x||!y)continue;let H=E||X,W,M;P?P.startsWith('"')?(W=y.replace(/^"(.*)"$/,"$1"),M=P.replace(/^"(.*)"$/,"$1")):(W=P.replace(/^"(.*)"$/,"$1"),M=y.replace(/^"(.*)"$/,"$1")):(W=y.replace(/^"(.*)"$/,"$1"),M=void 0);let q=D?parseInt(D,10):void 0;t.addParticipant(W,M,x.toLowerCase(),q,F,H);continue}if(p.trim()!==""&&!p.trim().startsWith("'"))throw new Error(`Syntax error at line ${s+1}: ${a}`)}return t}};var nt={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var J=class{constructor(r){this.theme=r}calculateLayout(r){let t=[...r.participants].sort((L,b)=>L.order!==void 0&&b.order!==void 0?L.order-b.order:L.order!==void 0?-1:b.order!==void 0?1:0),e=this.calculateMaxStep(r);this.finalizeEndSteps(r,e);let n=this.calculateStepHeights(r,e),i=n.stepY,c=n.totalHeight,o=t.map(L=>this.calculateParticipantWidth(L)),l=this.calculateGaps(r,t,o),s=this.calculateRelativepCenterXs(t,o,l),a=this.preCalculateNoteLayouts(r,t,s,o,i),p=this.calculateBounds(t,s,o,a,r.messages),g=this.theme.padding-p.minX,h=p.maxX-p.minX+this.theme.padding*2,f=h;if(r.timeConstraints.length>0){let b=50+Math.max(...r.timeConstraints.map(k=>k.label.length),0)*8;f+=b}let u=r.hideFootbox?0:this.theme.participantHeight+20,d=c+u+this.theme.padding,m=t.map((L,b)=>{let k=s[b]+g;return{participant:L,centerX:k,x:k-o[b]/2,y:L.createdStep!==void 0?i[L.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:o[b],height:this.theme.participantHeight,destroyedY:L.destroyedStep!==void 0?i[L.destroyedStep]:void 0}}),$=[];a.forEach((L,b)=>{let k=L.x+g,w=L.width;b.position==="across"&&(k=this.theme.padding,w=Math.max(h-this.theme.padding*2,L.width)),$.push({note:b,x:k,y:L.y,width:w,height:L.height})});let v=this.calculateGroupLayouts(r,m,$,i,e),z=this.calculateActivationLayouts(r,m,i,r.messages);return{width:f,height:d,participants:m,notes:$,dividers:this.calculateDividerLayouts(r,i,f),references:this.calculateReferenceLayouts(r,m,i),messages:this.calculateMessageLayouts(r,m,i,z),groups:v,activations:z,delays:this.calculateDelayLayouts(r,i),timeConstraints:this.calculateTimeConstraintLayouts(r,m,i,h)}}calculateMessageLayouts(r,t,e,n){return r.messages.map(i=>{let c=t.findIndex(h=>h.participant.name===i.from),o=t.findIndex(h=>h.participant.name===i.to),l=e[i.step],s=c!==-1?t[c].centerX:0,a=o!==-1?t[o].centerX:0;if(c!==-1&&o!==-1){let h=n.filter(u=>u.activation.participantName===i.from&&u.activation.startStep<=i.step&&(u.activation.endStep??1/0)>=i.step).sort((u,d)=>d.activation.level-u.activation.level),f=n.filter(u=>u.activation.participantName===i.to&&u.activation.startStep<=i.step&&(u.activation.endStep??1/0)>=i.step).sort((u,d)=>d.activation.level-u.activation.level);c!==o&&(c<o?(h.length>0&&(s=h[0].x+h[0].width),f.length>0&&(a=f[0].x)):(h.length>0&&(s=h[0].x),f.length>0&&(a=f[0].x+f[0].width)))}o!==-1&&t[o].participant.createdStep===i.step&&(a=t[o].x);let p=[{x:s,y:l},{x:a,y:l}],g={x:(s+a)/2,y:l};if(c===o&&c!==-1){let h=n.filter(d=>d.activation.participantName===i.from&&d.activation.startStep<=i.step&&(d.activation.endStep??1/0)>=i.step).sort((d,m)=>m.activation.level-d.activation.level),f=0,u=0;if(h.length>0){let d=h[0];d.activation.startStep===i.step?h.length>1?(f=1,u=0):(f=void 0,u=0):d.activation.endStep===i.step&&(h.length>1?(f=0,u=1):(f=0,u=void 0));let m=f!==void 0&&h.length>f?h[f].x+h[f].width:t[c].centerX,$=u!==void 0&&h.length>u?h[u].x+h[u].width:t[c].centerX,v=40;p[0]={x:m,y:l},p[1]={x:Math.max(m,$)+v,y:l},p.push({x:Math.max(m,$)+v,y:l+25}),p.push({x:$,y:l+25}),g={x:Math.max(m,$)+v+5,y:l+10}}else{let d=t[c].centerX,m=40;p[0]={x:d,y:l},p[1]={x:d+m,y:l},p.push({x:d+m,y:l+25}),p.push({x:d,y:l+25}),g={x:d+m+5,y:l+10}}}return{message:i,y:l,points:p,labelPosition:g,lineStyle:i.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(r,t,e){return r.dividers.map(n=>({y:t[n.step],label:n.label}))}calculateDelayLayouts(r,t){return r.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(r,t,e,n){return r.timeConstraints.map(i=>{let c=r.taggedSteps.get(i.startTag),o=r.taggedSteps.get(i.endTag);return c===void 0||o===void 0?null:{x:n-this.theme.padding+20,startY:e[c],endY:e[o],label:i.label}}).filter(i=>i!==null)}calculateReferenceLayouts(r,t,e){return r.references.map(n=>{let i=n.participants.map(g=>t.findIndex(h=>h.participant.name===g)).filter(g=>g!==-1);if(i.length===0)return null;let c=Math.min(...i),o=Math.max(...i),l=t[c].x,s=t[o].x+t[o].width-l,a=e[n.startStep]-10,p=e[n.endStep]-a;return{reference:n,x:l,y:a,width:s,height:p}}).filter(n=>n!==null)}calculateActivationLayouts(r,t,e,n){return r.activations.map(i=>{let c=t.findIndex(h=>h.participant.name===i.participantName);if(c===-1)return null;let l=t[c].centerX-this.theme.activationWidth/2+i.level*5,s=e[i.startStep];if(i.sourceStep!==void 0){let h=n.find(f=>f.step===i.sourceStep);h&&h.from===i.participantName&&h.to===i.participantName&&(s+=25)}let a=e[i.endStep];if(i.endSourceStep!==void 0){let h=n.find(f=>f.step===i.endSourceStep);h&&h.from===i.participantName&&h.to===i.participantName&&(a+=25)}let g=Math.max(5,a-s);return{activation:i,x:l,y:s,width:this.theme.activationWidth,height:g}}).filter(i=>i!==null)}calculateMaxStep(r){let t=0;return[...r.messages,...r.activations,...r.groups,...r.references,...r.notes,...r.dividers,...r.delays,...r.spacings].forEach(n=>{let i=n.step??n.startStep??n.endStep??0;i>t&&(t=i)}),t+1}finalizeEndSteps(r,t){r.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),r.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(r,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),n=new Array(t+2).fill(0),i=new Array(t+2).fill(0);r.notes.forEach(s=>{let p=s.text.split(`
`).length*20+10;n[s.step]=Math.max(n[s.step],p/2),i[s.step]=Math.max(i[s.step],p/2)}),r.messages.forEach(s=>{let p=s.text.split(`
`).length;if(s.from===s.to){let g=Math.max(25,p*20);n[s.step]=Math.max(n[s.step],0),i[s.step]=Math.max(i[s.step],g+10)}else{let g=p*15+5;n[s.step]=Math.max(n[s.step],g),i[s.step]=Math.max(i[s.step],0)}});let c=new Array(t+1).fill(this.theme.defaultMessageGap);r.dividers.forEach(s=>{c[s.step]=30}),r.delays.forEach(s=>{c[s.step]=40}),r.spacings.forEach(s=>{c[s.step]=s.height}),r.references.forEach(s=>{let p=s.label.split(`
`).length*15+40;s.endStep===s.startStep+1&&(c[s.startStep]=Math.max(c[s.startStep],p))});for(let s=0;s<=t;s++){let a=i[s]+n[s+1]+10;e[s]=Math.max(c[s],a)}let o=new Array(t+1).fill(0),l=this.theme.padding+90;for(let s=0;s<=t;s++)o[s]=l,l+=e[s];return{stepY:o,totalHeight:l}}calculateParticipantWidth(r){let e=(r.label||r.name).replace(/\\n/g,`
`).split(`
`),n=Math.max(...e.map(i=>i.length));return Math.max(this.theme.participantWidth,n*9+30)}calculateGaps(r,t,e){let n=Math.max(0,t.length-1),i=new Array(n).fill(60),c=this.calculateMaxStep(r);for(let o=0;o<=c;o++){let l=new Array(n).fill(0);for(let s=0;s<t.length;s++){let a=t[s].name;if(t[s].createdStep===o){let $=e[s];s<n&&(l[s]=Math.max(l[s],$/2+20))}let g=15,h=r.messages.find($=>$.step===o&&$.from===a&&$.to===a);h&&(g=40+(Math.max(...h.text.split(`
`).map(v=>v.length*8))+20)+10);let f=r.activations.filter($=>$.participantName===a&&$.startStep<=o&&($.endStep??1/0)>=o);if(f.length>0){let $=Math.max(...f.map(v=>v.level));g=Math.max(g,this.theme.activationWidth/2+$*5+10)}r.notes.filter($=>$.step===o&&$.position==="right"&&$.participants?.includes(a)).forEach($=>{let v=Math.max(60,Math.max(...$.text.split(`
`).map(z=>z.length*8.5))+20);g+=v+10}),s<n&&(l[s]+=g);let d=15;r.notes.filter($=>$.step===o&&$.position==="left"&&$.participants?.includes(a)).forEach($=>{let v=Math.max(60,Math.max(...$.text.split(`
`).map(z=>z.length*8.5))+20);d+=v+10}),s>0&&(l[s-1]+=d)}for(let s=0;s<n;s++)i[s]=Math.max(i[s],l[s])}return r.messages.forEach(o=>{let l=t.findIndex(f=>f.name===o.from),s=t.findIndex(f=>f.name===o.to);if(l===-1||s===-1||l===s)return;let a=Math.max(...o.text.split(`
`).map(f=>f.length*8))+20,p=Math.min(l,s),g=Math.max(l,s),h=0;for(let f=p;f<g;f++)h+=e[f]/2+i[f]+e[f+1]/2;if(h<a){let u=(a-h)/(g-p);for(let d=p;d<g;d++)i[d]+=u}}),r.notes.forEach(o=>{if(o.position!=="over"&&o.position!=="across")return;let l=o.text.split(`
`),s=Math.max(60,Math.max(...l.map(a=>a.length*8.5))+20);if(o.participants&&o.participants.length>0){let a=t.findIndex(f=>f.name===o.participants[0]),p=o.participants.length>1?t.findIndex(f=>f.name===o.participants[1]):a;if(a===-1||p===-1)return;let g=Math.min(a,p),h=Math.max(a,p);if(g===h){let f=s/2+10;g<n&&i[g]<f&&(i[g]=f)}else{let f=0;for(let u=g;u<h;u++)f+=e[u]/2+i[u]+e[u+1]/2;if(f<s){let d=(s-f)/(h-g);for(let m=g;m<h;m++)i[m]+=d}}}}),i}calculateRelativepCenterXs(r,t,e){let n=new Array(r.length).fill(0);return r.forEach((i,c)=>{c===0?n[c]=t[c]/2:n[c]=n[c-1]+t[c-1]/2+e[c-1]+t[c]/2}),n}preCalculateNoteLayouts(r,t,e,n,i){let c=new Map,o=new Map;return r.notes.forEach(l=>{let s=l.text.split(`
`),a=Math.max(...s.map(d=>d.length*8.5))+20,g=Math.max(a,60),h=s.length*20+10,f=i[l.step]-h/2,u=0;if(l.position==="across")u=0,c.set(l,{x:u,y:f,width:g,height:h});else if(l.position==="over"){let d=l.participants.map(m=>t.findIndex($=>$.name===m)).filter(m=>m!==-1);if(d.length>0){let m=Math.min(...d),$=Math.max(...d),v=e[$]+n[$]/2-(e[m]-n[m]/2),z=Math.max(v,g);u=e[m]-n[m]/2-(z-v)/2,c.set(l,{x:u,y:f,width:z,height:h})}}else{let d=(l.participants||[]).map(m=>t.findIndex($=>$.name===m)).filter(m=>m!==-1);if(d.length>0){let m=l.position==="left"?Math.min(...d):Math.max(...d),$=e[m],v=`${l.step}-${m}-${l.position}`,z=t[m],L=n[m]/2,k=l.step===z.createdStep?L:0;if(l.position==="left")u=(o.get(v)??$-k-5)-g,o.set(v,u-10);else{let w=r.messages.find(x=>x.step===l.step&&x.from===z.name&&x.to===z.name),S=0;if(w){let x=w.text.split(`
`);S=40+(Math.max(...x.map(E=>E.length*8))+20)}let A=r.activations.filter(x=>x.participantName===z.name&&x.startStep<=l.step&&(x.endStep??1/0)>=l.step),N=A.length>0?Math.max(...A.map(x=>x.level)):0,R=this.theme.activationWidth/2+N*5,I=Math.max(k,R,S);u=o.get(v)??$+I+5,o.set(v,u+g+10)}c.set(l,{x:u,y:f,width:g,height:h})}}}),c}calculateBounds(r,t,e,n,i){let c=0,o=0;return r.forEach((l,s)=>{let a=t[s]-e[s]/2,p=t[s]+e[s]/2;s===0?(c=a,o=p):(a<c&&(c=a),p>o&&(o=p))}),n.forEach(l=>{l.x<c&&(c=l.x),l.x+l.width>o&&(o=l.x+l.width)}),i.forEach(l=>{let s=r.findIndex(h=>h.name===l.from),a=r.findIndex(h=>h.name===l.to);if(s===-1||a===-1)return;let p=l.text.split(`
`),g=Math.max(...p.map(h=>h.length*8))+20;if(s===a){let h=t[s],f=Math.max(...l.text.split(`
`).map(d=>d.length*8))+20,u=h+40+f+10;u>o&&(o=u)}else{let h=t[s],f=t[a],u=(h+f)/2,d=u-g/2,m=u+g/2;d<c&&(c=d),m>o&&(o=m)}}),{minX:c,maxX:o}}calculateGroupLayouts(r,t,e,n,i){let c=r.groups.length>0?Math.max(...r.groups.map(o=>o.level)):0;return r.groups.map(o=>{let l=o.participants.map(b=>t.findIndex(k=>k.participant.name===b)).filter(b=>b!==-1);if(l.length===0)return null;let s=Math.min(...l),a=Math.max(...l),p=c-o.level,g=10+p*10,h=25+p*8,f=5+p*8,u=t[s].x+t[s].width/2-t[s].width/2-g,d=t[s].x-g,m=t[a].x+t[a].width+g-d;e.filter(b=>{let k=b.note;if(k.step<o.startStep||k.step>(o.endStep||i))return!1;let w=k.owner;if(!w)return!1;if(w===o)return!0;let S=w.endStep??i,A=o.endStep??i;return w.startStep>=o.startStep&&S<=A}).forEach(b=>{let k=b.note;if(k.position==="right"){let w=(k.participants||[]).map(S=>t.findIndex(A=>A.participant.name===S)).filter(S=>S!==-1);if(w.length>0&&Math.max(...w)===a){let S=b.x+b.width,A=d+m;S+10>A&&(m=S+10-d)}}else if(k.position==="left"){let w=(k.participants||[]).map(S=>t.findIndex(A=>A.participant.name===S)).filter(S=>S!==-1);if(w.length>0&&Math.min(...w)===s){let S=b.x,A=d;if(S-10<A){let N=A-(S-10);d-=N,m+=N}}}});let v=n[o.startStep]-h,z=n[o.endStep]+f,L=o.sections.map(b=>({label:b.label,y:n[b.startStep]}));return{group:o,x:d,y:v,width:m,height:z-v,type:o.type,label:o.label,sections:L}}).filter(o=>o!==null)}};var K=class{constructor(){this.theme=nt;this.lastSvg="";this.layoutEngine=new J(this.theme)}render(r){this.ensureParticipants(r);let t=this.layoutEngine.calculateLayout(r);return this.generateSvg(r,t)}ensureParticipants(r){r.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>r.addParticipant(e))})}generateSvg(r,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(r),e+=this.renderLifelines(r,t),e+=this.renderActivations(r,t),e+=this.renderGroups(t),e+=this.renderParticipants(r,t),e+=this.renderReferences(r,t),e+=this.renderNotes(t),e+=this.renderMessages(r,t),e+=this.renderDividers(r,t),e+=this.renderDelays(r,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),r.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${r.title}</text>`),r.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${r.header}</text>`),r.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${r.footer}</text>`),e+="</svg>",e}renderDefs(r){let t=new Set;t.add(this.theme.colors.defaultStroke),r.messages.forEach(n=>{t.add(this.normalizeColor(n.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(n=>{let i=n.replace("#","");e+=`
      <marker id="arrowhead-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-open-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${i}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${n}" />
      </marker>
      <marker id="halfhead-reverse-${i}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${n}" />
      </marker>
      <marker id="circlehead-${i}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${n}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${i}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
        <circle cx="14" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${i}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${n}" />
        <circle cx="4" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="losthead-${i}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${n}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${n}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(r,t){let e="";return t.participants.forEach(n=>{if(n.participant.name==="["||n.participant.name==="]")return;let i=n.centerX,c=n.destroyedY!==void 0?n.destroyedY:r.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${i}" y1="${n.y+n.height}" x2="${i}" y2="${c}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(r){let t="";return r.participants.forEach(e=>{if(e.destroyedY!==void 0){let n=e.centerX,i=e.destroyedY,c=12;t+=`<line x1="${n-c}" y1="${i-c}" x2="${n+c}" y2="${i+c}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${n+c}" y1="${i-c}" x2="${n-c}" y2="${i+c}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(r,t){let e="",n=(i,c)=>{let o=this.normalizeColor(i.participant.color,this.theme.colors.actorFill),l=i.x,s=c?i.y:t.height-this.theme.padding-this.theme.participantHeight-20,a=i.centerX,p=s+this.theme.participantHeight/2,h=(i.participant.label||i.participant.name).replace(/\\n/g,`
`).split(`
`);switch(i.participant.type){case"actor":e+=`<circle cx="${a}" cy="${s+10}" r="8" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a}" y1="${s+18}" x2="${a}" y2="${s+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a-10}" y1="${s+22}" x2="${a+10}" y2="${s+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a}" y1="${s+30}" x2="${a-8}" y2="${s+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a}" y1="${s+30}" x2="${a+8}" y2="${s+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+55+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"boundary":e+=`<line x1="${a-20}" y1="${p}" x2="${a-10}" y2="${p}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a-20}" y1="${p-10}" x2="${a-20}" y2="${p+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${a}" cy="${p}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"control":e+=`<circle cx="${a}" cy="${p}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${a+4} ${p-18} L ${a-4} ${p-14} L ${a+4} ${p-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"entity":e+=`<circle cx="${a}" cy="${p}" r="14" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${a-14}" y1="${p+14}" x2="${a+14}" y2="${p+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"database":let f=34,u=40,d=s,m=a-f/2;e+=`<path d="M ${m} ${d+10} L ${m} ${d+u-10} A 17 8 0 0 0 ${m+f} ${d+u-10} L ${m+f} ${d+10} A 17 8 0 0 0 ${m} ${d+10} M ${m} ${d+10} A 17 8 0 0 1 ${m+f} ${d+10}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${m} ${d+10} A 17 8 0 0 0 ${m+f} ${d+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"collections":let $=34,v=34,z=s+3,L=a-$/2;e+=`<rect x="${L+4}" y="${z-4}" width="${$}" height="${v}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${L}" y="${z}" width="${$}" height="${v}" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"queue":let b=40,k=40,w=s+3,S=a-b/2,A=5,N=k/2;e+=`<path d="M ${S+b} ${w} L ${S} ${w} A ${A} ${N} 0 0 0 ${S} ${w+k} L ${S+b} ${w+k} A ${A} ${N} 0 0 0 ${S+b} ${w}" fill="${o}" stroke="none" />`,e+=`<ellipse cx="${S+b}" cy="${w+N}" rx="${A}" ry="${N}" fill="${o}" stroke="none" />`,e+=`<path d="M ${S+b} ${w} L ${S} ${w} A ${A} ${N} 0 0 0 ${S} ${w+k} L ${S+b} ${w+k}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${S+b}" cy="${w+N}" rx="${A}" ry="${N}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{e+=`<text x="${a}" y="${s+this.theme.participantHeight+20+I*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;default:e+=`<rect x="${l}" y="${s}" width="${i.width}" height="${this.theme.participantHeight}" rx="5" fill="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((R,I)=>{let j=h.length>1?p-(h.length-1)*7.5+I*15:p;e+=`<text x="${a}" y="${j}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`})}};return t.participants.forEach(i=>{i.participant.name==="["||i.participant.name==="]"||(n(i,!0),r.hideFootbox||n(i,!1))}),e}renderGroups(r){let t="";return r.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(n=>{let i=n.y;t+=`<line x1="${e.x}" y1="${i}" x2="${e.x+e.width}" y2="${i}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${i+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${n.label}]</text>`})}),t}renderNotes(r){let t="";return r.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(r,t){let e="";return[...t.activations].sort((i,c)=>i.activation.level-c.activation.level).forEach(i=>{let c=i.activation.color||this.theme.colors.actorFill;e+=`<rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" fill="${c}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(r,t){let e="";return t.references.forEach(n=>{e+=`<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${n.x} ${n.y} L ${n.x+70} ${n.y} L ${n.x+70} ${n.y+10} L ${n.x+60} ${n.y+20} L ${n.x} ${n.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${n.x+5}" y="${n.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let i=n.reference.label.split(`
`),c=this.theme.fontSize+2,o=i.length*c,l=25,s=n.y+n.height/2-o/2+c/2;s<n.y+l+c/2&&(s=n.y+l+c/2),i.forEach((a,p)=>{e+=`<text x="${n.x+n.width/2}" y="${s+p*c}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${a}</text>`})}),e}renderMessages(r,t){let e="";return t.messages.forEach(n=>{let i=n.message,c=this.normalizeColor(i.color,this.theme.colors.defaultStroke),o=n.lineStyle==="dashed"?"4":"0",l=c.replace("#",""),s=(u,d)=>{if(u==="none")return"none";let m="";return u==="default"?m=d?`arrowhead-reverse-${l}`:`arrowhead-${l}`:u==="open"?m=d?`arrowhead-open-reverse-${l}`:`arrowhead-open-${l}`:u==="half"?m=d?`halfhead-reverse-${l}`:`halfhead-${l}`:u==="circle"?m=`circlehead-${l}`:u==="arrow-circle"?m=d?`arrowhead-circle-reverse-${l}`:`arrowhead-circle-${l}`:u==="lost"?m=`losthead-${l}`:u==="found"&&(m=`circlehead-${l}`),m?`url(#${m})`:"none"},a=s(i.arrowHead||"default",!1),p=s(i.startHead||(i.bidirectional?"default":"none"),!0);if(n.points.length>2){let u=`M ${n.points.map(d=>`${d.x} ${d.y}`).join(" L ")}`;e+=`<path d="${u}" fill="none" stroke="${c}" stroke-width="1.5" stroke-dasharray="${o}" marker-end="${a}" marker-start="${p}" />`}else{let[u,d]=n.points;e+=`<line x1="${u.x}" y1="${u.y}" x2="${d.x}" y2="${d.y}" stroke="${c}" stroke-width="1.5" stroke-dasharray="${o}" marker-end="${a}" marker-start="${p}" />`}let h=(i.number?`[${i.number}] ${i.text}`:i.text).split(`
`),f=n.points.length>2?"start":"middle";h.forEach((u,d)=>{let $=n.labelPosition.y-(h.length-1-d)*15-5;n.points.length>2&&($=n.labelPosition.y+d*20),e+=`<text x="${n.labelPosition.x}" y="${$}" text-anchor="${f}" font-size="${this.theme.fontSize-2}" fill="${c}">${u}</text>`})}),e}renderDividers(r,t){let e="";return t.dividers.forEach(n=>{let i=n.y;if(e+=`<line x1="${this.theme.padding}" y1="${i}" x2="${t.width-this.theme.padding}" y2="${i}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${i+4}" x2="${t.width-this.theme.padding}" y2="${i+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,n.label){let c=n.label.length*9+20;e+=`<rect x="${t.width/2-c/2}" y="${i-10}" width="${c}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${i}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${n.label}</text>`}}),e}renderDelays(r,t){let e="";return t.delays.forEach(n=>{let i=n.y,c=t.width/2,o=10,l=5;if(n.text){let s=n.text.length*8+20;e+=`<text x="${c}" y="${i}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${n.text}</text>`;for(let a=0;a<l;a++){let p=c-s/2-10-a*o;e+=`<circle cx="${p}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`}for(let a=0;a<l;a++){let p=c+s/2+10+a*o;e+=`<circle cx="${p}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let s=-10;s<=10;s++)s!==0&&(e+=`<circle cx="${c+s*o}" cy="${i}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(r){let t="";return r.timeConstraints.forEach(e=>{let n=e.x,i=e.startY,c=e.endY,o=this.theme.colors.defaultStroke;if(t+=`<line x1="${n}" y1="${i}" x2="${n}" y2="${c}" stroke="${o}" stroke-width="1.5" />`,t+=`<polygon points="${n} ${i}, ${n-4} ${i+8}, ${n+4} ${i+8}" fill="${o}" />`,t+=`<polygon points="${n} ${c}, ${n-4} ${c-8}, ${n+4} ${c-8}" fill="${o}" />`,e.label){let l=(i+c)/2;t+=`<text x="${n+10}" y="${l}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${o}">${e.label}</text>`}}),t}normalizeColor(r,t){return r?r.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(r)?r:r.substring(1):r:t}formatRichText(r){let t=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return t=t.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),t=t.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),t}drawNoteShape(r,t,e,n,i,c,o,l){let s="",a=this.normalizeColor(o,this.theme.colors.noteFill),p=this.theme.colors.defaultStroke,g=c||"folder";if(g==="hexagon"){let u=[`${t+10},${e}`,`${t+n-10},${e}`,`${t+n},${e+i/2}`,`${t+n-10},${e+i}`,`${t+10},${e+i}`,`${t},${e+i/2}`].join(" ");s+=`<polygon points="${u}" fill="${a}" stroke="${p}" stroke-width="1.5" />`}else if(g==="bubble"){let f=i/2;s+=`<rect x="${t}" y="${e}" width="${n}" height="${i}" rx="${f}" ry="${f}" fill="${a}" stroke="${p}" stroke-width="1.5" />`}else if(g==="rectangle")s+=`<rect x="${t}" y="${e}" width="${n}" height="${i}" fill="${a}" stroke="${p}" stroke-width="1.5" />`;else{let u=`
                M ${t} ${e}
                L ${t+n-10} ${e}
                L ${t+n} ${e+10}
                L ${t+n} ${e+i}
                L ${t} ${e+i}
                Z
            `;s+=`<path d="${u}" fill="${a}" stroke="${p}" stroke-width="1.5" />`;let d=`
                M ${t+n-10} ${e}
                L ${t+n-10} ${e+10}
                L ${t+n} ${e+10}
            `;s+=`<path d="${d}" fill="none" stroke="${p}" stroke-width="1.5" />`}l.split(`
`).forEach((f,u)=>{s+=`<text x="${t+n/2}" y="${e+20+u*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText(f)}</text>`}),this.lastSvg=r+s}};function tt(B){let r=new U,t=new K;try{let e=r.parse(B);return t.render(e)}catch(e){let i=(e.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),c=800,o=100;return`
            <svg width="${c}" height="${o}" viewBox="0 0 ${c} ${o}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
                <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
                <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${i}</text>
            </svg>
        `.trim()}}function Q(B="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(B).forEach(t=>{let e=t.textContent||"",n=tt(e),i=document.createElement("div");i.className="seeduml-diagram",i.innerHTML=n,i.style.display="inline-block",t.parentNode?.replaceChild(i,t)})}function rt(B={}){let{startOnLoad:r=!0,selector:t="pre.seeduml"}=B;r&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Q(t)}):Q(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:tt,renderAll:Q,initialize:rt});var yt={renderSequenceDiagram:tt,renderAll:Q,initialize:rt};export{yt as default,rt as initialize,Q as renderAll,tt as renderSequenceDiagram};
